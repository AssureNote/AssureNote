var AssureNote;!function(a){function b(a){return a+2&3}!function(b){function c(a,b,c,d){$.ajax({type:"POST",url:Config.BASEPATH+"/api/1.0",data:JSON.stringify({jsonrpc:"2.0",id:"1",method:a,params:b}),dataType:"json",contentType:"application/json; charset=utf-8",success:function(a){c(a.result)},error:function(a,b){console.log("========== Ajax Error =========="),console.log(b),null!=d&&d(),console.log("================================")}})}function d(a,b){var c=new Blob([a],{type:"text/plain; charset=UTF-8"});saveAs(c,b)}function e(a){for(var b=a.target||a.srcElement;null!=b;){if(""!=b.id)return b.id;b=b.parentElement}return""}function f(b){var c=document.getElementById(b),d=c.getBoundingClientRect();return new a.Point(d.left,d.top)}function g(b){switch(b.GetNodeType()){case 0:return new a.GSNGoalShape(b);case 1:return new a.GSNContextShape(b);case 2:return new a.GSNStrategyShape(b);case 3:return new a.GSNEvidenceShape(b)}}function h(a){return document.createElementNS("http://www.w3.org/2000/svg",a)}function i(a){return r.textContent=a,r.innerHTML}function j(a,b,c){if(c){var d=a,e=b||20;e=1>e?1:e;for(var f=0,g=0,h=0;h<d.length;++h){var i=d.charCodeAt(h);f+=128>i?1:2,(f>e||"\n"==d.charAt(h))&&(c(d.substr(0,h),g),"\n"==d.charAt(h)&&h++,d=d.substr(h,d.length-h),h=-1,f=0,g++)}c(d,g)}}function k(a){var b=(new Date).getTime()-new Date(a).getTime();return s>b?"just now":b>=s&&2*s>b?"a minute ago":b>=2*s&&t>b?""+Math.floor(b/s)+" minutes ago":b>=t&&2*t>b?"an hour ago":b>=2*t&&u>b?""+Math.floor(b/t)+" hours ago":b>=u&&2*u>b?"a day ago":b>=2*u&&v>b?""+Math.floor(b/u)+" days ago":b>=v&&2*v>b?"a month ago":b>=2*v&&w>b?""+Math.floor(b/v)+" months ago":b>=w&&2*w>b?"an year ago":b>=2*w?""+Math.floor(b/w)+" years ago":"error"}function l(){return Math.floor(2147483647*Math.random())}function m(){return l().toString(36)}function n(a){a||(a=""),window.location.hash=a}function o(a,b){$("<style>").html("."+a+" { "+$("span").css(b).attr("style")+" }").appendTo("head")}function p(a){var b="%[0-9a-fA-F]{2}",c="(http|https):\\/\\/",d="([a-zA-Z0-9$\\-_.+!*'(),;:&=]|"+b+")+@",e="(25[0-5]|2[0-4][0-9]|[0-1][0-9][0-9]|[1-9][0-9]|[0-9])",f="("+e+"(\\."+e+"){3})",g="([a-zA-Z0-9\\-\\u00C0-\\u017F]+\\.)+([a-zA-Z]{2,})",h="[0-9]+",i="("+f+"|localhost|"+g+")(:"+h+")?",j="a-zA-Z0-9$\\-_.+!*'(),;:@&=",k="(["+j+"]|"+b+")*",l=k+"(\\/"+k+")*",m="\\?(["+j+"/?]|"+b+")*",n="\\#(["+j+"/?]|"+b+")*",o=new RegExp("^"+c+"("+d+")?"+i+"(\\/("+l+")?("+m+")?("+n+")?)?$");return o.test(a)?!0:!1}function q(a){var b=a.substring(0,1).toUpperCase()+a.substring(1);return x.IsTrident()?(b="ms"+b,function(a,c){a.style[b]=c}):x.IsGecko()?(b="Moz"+b,function(a,c){a.style[b]=c}):x.IsWebkit()||x.IsBlink()?(b="webkit"+b,function(a,c){a.style[b]=c}):function(b,c){b.style[a]=c}}b.postJsonRPC=c,b.SaveAs=d,b.GetNodeLabelFromEvent=e,b.GetNodePosition=f,b.CreateGSNShape=g,b.CreateSVGElement=h;var r=document.createElement("div");b.HTMLEncode=i,b.ForeachLine=j;var s=6e4,t=60*s,u=24*t,v=30*u,w=365*v;b.FormatDate=k,b.GenerateUID=l,b.GenerateRandomString=m,b.UpdateHash=n;var x=function(){function a(){}return a.IsLessThanIE6=function(){return!!a.ua.ltIE6},a.IsLessThanIE7=function(){return!!a.ua.ltIE7},a.IsLessThanIE8=function(){return!!a.ua.ltIE8},a.IsLessThanIE9=function(){return!!a.ua.ltIE9},a.IsGreaterThanIE10=function(){return!!a.ua.gtIE10},a.IsTrident=function(){return!!a.ua.Trident},a.IsGecko=function(){return!!a.ua.Gecko},a.IsPresto=function(){return!!a.ua.Presto},a.IsBlink=function(){return!!a.ua.Blink},a.IsWebkit=function(){return!!a.ua.Webkit},a.IsTouchEnabled=function(){return!!a.ua.Touch},a.IsPointerEnabled=function(){return!!a.ua.Pointer},a.IsMSPoniterEnabled=function(){return!!a.ua.MSPoniter},a.IsPerformanceEnabled=function(){return!!a.ua.Performance},a.IsAnimationFrameEnabled=function(){return!!a.ua.AnimationFrame},a.IsTouchDevice=function(){return a.ua.Touch},a.ua=function(){return{ltIE6:"undefined"==typeof window.addEventListener&&"undefined"==typeof document.documentElement.style.maxHeight,ltIE7:"undefined"==typeof window.addEventListener&&"undefined"==typeof document.querySelectorAll,ltIE8:"undefined"==typeof window.addEventListener&&"undefined"==typeof document.getElementsByClassName,ltIE9:document.uniqueID&&!window.matchMedia,gtIE10:document.uniqueID&&document.documentMode>=10,Trident:document.uniqueID,Gecko:"MozAppearance"in document.documentElement.style,Presto:window.opera,Blink:window.chrome,Webkit:!window.chrome&&"WebkitAppearance"in document.documentElement.style,Touch:"undefined"!=typeof document.ontouchstart,Mobile:"undefined"!=typeof document.orientation,Pointer:"undefined"!=typeof document.navigator&&!!document.navigator.pointerEnabled,MSPoniter:"undefined"!=typeof document.navigator&&!!document.navigator.msPointerEnabled,Performance:"undefined"!=typeof window.performance,AnimationFrame:"undefined"!=typeof window.requestAnimationFrame}}(),a}();b.UserAgant=x,b.RequestAnimationFrame=x.IsAnimationFrameEnabled()?function(a){return requestAnimationFrame(a)}:function(a){return setTimeout(a,16.7)},b.CancelAnimationFrame=x.IsAnimationFrameEnabled()?function(a){return cancelAnimationFrame(a)}:function(a){return clearTimeout(a)},b.GetTime=x.IsPerformanceEnabled()?function(){return performance.now()}:function(){return Date.now()},b.DefineColorStyle=o,b.isValidURL=p,b.SetTransformOriginToElement=q("transformOrigin"),b.SetTransformToElement=q("transform")}(a.AssureNoteUtils||(a.AssureNoteUtils={}));var c=a.AssureNoteUtils,d=function(){function a(){}return a.prototype.Start=function(a,b){var d=this;this.Cancel(),this.LastTime=this.StartTime=c.GetTime(),this.EndTime=this.StartTime+a,this.Callback=b;var e=function(){var a=c.GetTime(),b=a-d.LastTime;a<d.EndTime?d.TimerHandle=c.RequestAnimationFrame(e):(b=d.EndTime-d.LastTime,d.TimerHandle=0),d.Callback(b,a,d.StartTime),d.LastTime=a};e()},a.prototype.StartMany=function(a,b){b&&b.length>0&&this.Start(a,function(a,c,d){for(var e=0;e<b.length;++e)b[e](a,c,d)})},a.prototype.IsRunning=function(){return 0!=this.TimerHandle},a.prototype.Cancel=function(a){if(this.TimerHandle&&(c.CancelAnimationFrame(this.TimerHandle),this.TimerHandle=0,a)){var b=this.EndTime-this.LastTime;this.Callback(b,this.EndTime,this.StartTime)}},a}();a.AnimationFrameTask=d;var e=function(){function a(){}return a.prototype.PreventDefault=function(){this.DefaultPrevented=!0},a}();a.AssureNoteEvent=e;var f=function(){function a(){this.Listeners={}}return a.prototype.RemoveEventListener=function(a,b){var c=this.Listeners[a];if(null!=c){var d=c.indexOf(b);-1!==d&&c.splice(d,1)}},a.prototype.AddEventListener=function(a,b){var c=this.Listeners[a];null==c?this.Listeners[a]=[b]:-1===c.indexOf(b)&&c.unshift(b)},a.prototype.DispatchEvent=function(a){a.Target=this,null!=this["on"+a.Type]&&this["on"+a.Type](a),null!=this["On"+a.Type]&&this["On"+a.Type](a);var b=this.Listeners[a.Type];if(null!=b){b=b.slice(0);for(var c=0,d=b.length;d>c;c++)b[c].call(this,a)}return!a.DefaultPrevented},a}();a.EventTarget=f;var g=function(){function a(){}return a.Default="assurenote-default",a.Highlight="assurenote-default-highlight",a.ToDo="assurenote-todo",a.Searched="assurenote-search",a.Danger="assurenote-danger",a.SingleEdit="assurenote-singleedit",a.Locked="assurenote-locked",a.Useless="assurenote-useless",a}();a.ColorStyle=g;var h=function(){function a(a,b,c,d){this.X=a,this.Y=b,this.Width=c,this.Height=d}return a.prototype.toString=function(){return"("+[this.X,this.Y,this.Width,this.Height].join(", ")+")"},a.prototype.Clone=function(){return new a(this.X,this.Y,this.Width,this.Height)},a}();a.Rect=h;var i=function(){function a(a,b){this.X=a,this.Y=b}return a.prototype.Clone=function(){return new a(this.X,this.Y)},a.prototype.toString=function(){return"("+this.X+", "+this.Y+")"},a}();a.Point=i,function(a){a[a.Left=0]="Left",a[a.Top=1]="Top",a[a.Right=2]="Right",a[a.Bottom=3]="Bottom"}(a.Direction||(a.Direction={}));a.Direction;a.ReverseDirection=b,function(a){a[a.Edit=0]="Edit",a[a.View=1]="View"}(a.AssureNoteMode||(a.AssureNoteMode={}));a.AssureNoteMode}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(){function a(b){this.IsVisible=!1,this.App=b,a.Initialized||(a.ActivePanel=this,document.addEventListener("keydown",function(b){a.ActivePanel.OnKeyDown(b)},!0),a.Initialized=!0)}return a.prototype.Create=function(){},a.prototype.OnKeyDown=function(){},a.prototype.OnActivate=function(){},a.prototype.OnDeactivate=function(){},a.prototype.Remove=function(){},a.prototype.Show=function(){this.IsEnable=!0},a.prototype.Hide=function(){this.IsVisible=!1},a.prototype.Activate=function(){this.IsActive()||(a.ActivePanel.OnDeactivate(),a.ActivePanel=this,this.OnActivate())},a.prototype.IsActive=function(){return a.ActivePanel==this},a.Initialized=!1,a}();a.Panel=b}(AssureNote||(AssureNote={}));var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},AssureNote;!function(a){var b=function(){function a(a){this.Text=a,this.CurrentPos=0,this.PreviousPos=0,this.Linenum=0}return a.prototype.HasNext=function(){return this.CurrentPos<this.Text.length},a.prototype.ReadLine=function(){var a,b=this.CurrentPos;for(this.PreviousPos=this.CurrentPos,a=this.CurrentPos;a<this.Text.length;a++){var c=this.Text.charCodeAt(a);if(10==c){var d=a;return this.CurrentPos=a+1,this.Linenum+=1,this.Text.substring(b,d).trim()}if(92==c){var d=a;return a+1<this.Text.length&&10==this.Text.charCodeAt(a+1)&&a++,this.Linenum+=1,this.CurrentPos=a+1,this.Text.substring(b,d).trim()}}return this.CurrentPos=a,b==this.CurrentPos?null:(this.Linenum+=1,this.Text.substring(b,this.CurrentPos).trim())},a.prototype.RollbackLineFeed=function(){this.CurrentPos=this.PreviousPos,this.Linenum-=1},a.prototype.ReadLineList=function(a,b){for(;this.HasNext();){var c=this.ReadLine();if(b&&v.String_startsWith(c,"*")){this.RollbackLineFeed();break}v.Array_add(a,c)}},a.prototype.GetLineList=function(a){var b=new Array;return this.ReadLineList(b,a),b},a.prototype.LogError=function(a,b){console.log("(error:"+this.Linenum+") "+a+": "+b)},a.prototype.LogWarning=function(a,b){console.log("(warning:"+this.Linenum+") "+a+": "+b)},a}();a.StringReader=b;var c=function(){function a(){this.sb=new o}return a.prototype.print=function(a){this.sb.append(a)},a.prototype.println=function(a){this.sb.append(a),this.sb.append(v.LineFeed)},a.prototype.newline=function(){this.sb.append(v.LineFeed)},a.prototype.toString=function(){return this.sb.toString()},a}();a.StringWriter=c,function(a){a[a.Goal=0]="Goal",a[a.Context=1]="Context",a[a.Strategy=2]="Strategy",a[a.Evidence=3]="Evidence",a[a.Undefined=4]="Undefined"}(a.GSNType||(a.GSNType={}));var d=(a.GSNType,function(){function a(a,b,c,d,e,f){this.UpdateHistory(a,b,c,d,e,f),this.IsCommitRevision=!0}return a.prototype.toString=function(){return this.DateString+";"+this.Author+";"+this.Role+";"+this.Process},a.prototype.EqualsHistory=function(a){return v.Object_equals(this.DateString,a.DateString)&&v.Object_equals(this.Author,a.Author)},a.prototype.CompareDate=function(a){return v.String_compareTo(this.DateString,a.DateString)},a.prototype.UpdateHistory=function(a,b,c,d,f,g){this.Rev=a,this.Author=b,this.Role=c,this.Process=f,this.Doc=g,this.DateString=e.FormatDateString(d)},a.prototype.GetCommitMessage=function(){return f.GetString(this.Doc.DocTagMap,"CommitMessage","")},a}());a.GSNHistory=d;var e=function(){function a(){}return a.ParseInt=function(a,b){try{return v.parseInt(a)}catch(c){}return b},a.ParseGoalLevel=function(a){for(var b=0,c=0;c<a.length&&42==a.charCodeAt(c);c++)b++;return b},a.FormatGoalLevel=function(a){for(var b=new o,c=0;a>c;c++)b.append("*");return b.toString()},a.GetLabelPos=function(a){var b;for(b=0;b<a.length&&42==a.charCodeAt(b);b++);for(;b<a.length&&32==a.charCodeAt(b);b++);return b},a.ParseNodeType=function(b){var c=a.GetLabelPos(b);if(c<b.length){var d=b.charCodeAt(c);if(71==d)return 0;if(83==d)return 2;if(69==d||77==d||65==d)return 3;if(67==d||74==d||82==d)return 1}return 4},a.ParseLabelName=function(b){var c=a.GetLabelPos(b),d=new o;if(c+=1,c>=b.length||58!=b.charCodeAt(c))return null;for(d.append(b.substring(c-1,c));c<b.length&&32!=b.charCodeAt(c);)d.append(b.substring(c,c+1)),c+=1;return d.toString()},a.FormatNodeType=function(a){switch(a){case 0:return"G";case 1:return"C";case 2:return"S";case 3:return"E";case 4:}return"U"},a.ParseLabelNumber=function(b){var c=a.GetLabelPos(b)+1;if(c>=b.length||58==b.charCodeAt(c))return null;for(var d=c;d<b.length;d++)if(!p.isWhitespace(b.charCodeAt(d))){if(38==b.charCodeAt(d))return null;if(p.isDigit(b.charCodeAt(d))){c=d;break}}if(-1!=c){for(var d=c+1;d<b.length;d++)if(p.isWhitespace(b.charCodeAt(d)))return b.substring(c,d);return b.substring(c)}return null},a.ParseUID=function(a){var b=a.indexOf("&")+1;if(0==b)return null;for(var c=b;c<a.length&&32!=a.charCodeAt(c);)c++;var d=a.substring(b,c);return d},a.ParseRevisionHistory=function(a){var b=a.indexOf("#");return-1!=b?a.substring(b).trim():null},a.ParseHistory=function(b,c){if(null!=c){var d=b.indexOf("#");try{if(-1!=d){var e=new Array(2),f=b.substring(d+1).trim(),g=f.split(":");return e[0]=c.Record.GetHistory(a.ParseInt(g[0],-1)),e[1]=c.Record.GetHistory(a.ParseInt(g[1],-1)),null==e[0]||null==e[1]?null:e}}catch(h){}}return null},a.FormatRefKey=function(b,c){return a.FormatNodeType(b)+c},a.CommentOutAll=function(a){for(var d=new b(a),e=new c;d.HasNext();){var f=d.ReadLine();f="#"+f,e.print(f),e.newline()}return e.toString()},a.CommentOutSubNode=function(a){for(var d=new b(a),e=new c,f=0;d.HasNext();){var g=d.ReadLine();v.String_startsWith(g,"*")&&f++,f>=2&&(g="#"+g),e.print(g),e.newline()}return e.toString()},a.FormatDateString=function(a){var b=new q("yyyy-MM-dd84HH:mm:ssZ");if(null!=a)try{return b.format(b.parse(a))}catch(c){c.printStackTrace()}var d=new Date;return b.format(d)},a}();a.WikiSyntax=e;var f=function(){function a(){}return a.ParseTag=function(a,b){var c=b.indexOf("::");if(-1!=c){var d=b.substring(0,c).trim(),e=b.substring(c+2).trim();a.put(d,e)}},a.FormatTag=function(a,b){if(null!=a)for(var c=a.keySet(),d=0;d<c.length;d++){var e=c[d];b.println(e+":: "+a.get(e))}},a.FormatHistoryTag=function(a,b,c){var d=v.Array_get(a,b);null!=d&&c.println("#"+b+"::"+d)},a.GetString=function(a,b,c){if(null!=a){var d=a.get(b);if(null!=d)return d}return c},a.GetInteger=function(a,b,c){return null!=a?e.ParseInt(a.get(b),c):c},a}();a.TagUtils=f;var g=function(){function a(a,b,c,d,e,f){this.BaseDoc=a,this.ParentNode=b,this.NodeType=c,this.LabelName=d,this.AssignedLabelNumber="",this.UID=e,this.SectionCount=0,this.SubNodeList=null,null!=f?(this.Created=f[0],this.LastModified=f[1]):(this.Created=null!=a?a.DocHistory:null,this.LastModified=this.Created),this.Digest=null,this.NodeDoc=v.LineFeed.trim(),this.HasTag=!1,null!=this.ParentNode&&b.AppendSubNode(this)}return a.prototype.DeepCopy=function(b,c){var d=new a(b,c,this.NodeType,this.LabelName,this.UID,null);d.Created=this.Created,d.LastModified=this.LastModified,d.Digest=this.Digest,d.NodeDoc=this.NodeDoc,d.HasTag=this.HasTag,null!=b&&b.UncheckAddNode(d);for(var e=0;e<v.Array_size(this.NonNullSubNodeList());e++){var f=v.Array_get(this.NonNullSubNodeList(),e);f.DeepCopy(b,d)}return d},a.prototype.IsGoal=function(){return 0==this.NodeType},a.prototype.IsStrategy=function(){return 2==this.NodeType},a.prototype.IsContext=function(){return 1==this.NodeType},a.prototype.IsEvidence=function(){return 3==this.NodeType},a.prototype.NonNullSubNodeList=function(){return null==this.SubNodeList?v.EmptyNodeList:this.SubNodeList},a.prototype.Remap=function(a){a.put(this.UID,this);for(var b=0;b<v.Array_size(this.NonNullSubNodeList());b++){var c=v.Array_get(this.NonNullSubNodeList(),b);c.Remap(a)}},a.prototype.GetGoalLevel=function(){for(var a=this.IsGoal()?1:0,b=this.ParentNode;null!=b;)b.IsGoal()&&(a+=1),b=b.ParentNode;return a},a.prototype.GetLabel=function(){return e.FormatNodeType(this.NodeType)+this.GetLabelNumber()},a.prototype.GetHistoryTaple=function(){return"#"+this.Created.Rev+":"+this.LastModified.Rev},a.prototype.GetLabelNumber=function(){return this.AssignedLabelNumber},a.prototype.IsModified=function(){return this.LastModified==this.BaseDoc.DocHistory},a.prototype.SetContent=function(a){for(var b=(this.Digest,0),d=new c,e=v.GetMD5(),f=0;f<v.Array_size(a);f++){var g=v.Array_get(a,f),h=g.indexOf("::");h>0&&(this.HasTag=!0),d.newline(),d.print(g),g.length>0&&(v.UpdateMD5(e,g),b+=1)}b>0?(this.Digest=e.digest(),this.NodeDoc=d.toString().trim()):(this.Digest=null,this.NodeDoc=v.LineFeed.trim())},a.prototype.UpdateContent=function(a){this.SetContent(new b(a).GetLineList(!0))},a.prototype.GetHtmlContent=function(){if(null!=this.Digest)for(var a=new b(this.NodeDoc),d=new c,e="";a.HasNext();){var f=a.ReadLine();if(e+=f,0==f.length&&e.length>0)d.println("<p>"+e+"</p>");else{var g=f.indexOf("::");g>0&&d.println("<p class='tag'>"+f+"</p>")}}},a.prototype.GetNodeHistoryList=function(){for(var a=new Array,b=null,c=0;c<v.Array_size(this.BaseDoc.Record.HistoryList);c++){var d=v.Array_get(this.BaseDoc.Record.HistoryList,c);if(null!=d.Doc){var e=d.Doc.GetNode(this.UID);null!=e&&e.Created==this.Created&&(null==b||b.LastModified!=this.LastModified)&&(v.Array_add(a,e),b=e)}}return a},a.prototype.AppendSubNode=function(a){a.BaseDoc==this.BaseDoc,null==this.SubNodeList&&(this.SubNodeList=new Array),v.Array_add(this.SubNodeList,a)},a.prototype.HasSubNode=function(a){for(var b=0;b<v.Array_size(this.NonNullSubNodeList());b++){var c=v.Array_get(this.NonNullSubNodeList(),b);if(c.NodeType==a)return!0}return!1},a.prototype.GetCloseGoal=function(){for(var a=this;0!=a.NodeType;)a=a.ParentNode;return a},a.prototype.GetTagMap=function(){if(null==this.TagMap&&this.HasTag){this.TagMap=new t;for(var a=new b(this.NodeDoc);a.HasNext();){var c=a.ReadLine(),d=c.indexOf("::");d>0&&f.ParseTag(this.TagMap,c)}}return this.TagMap},a.prototype.MergeTagMap=function(a,b){if(null==a)return b;if(null==b)return a;for(var c=new t,d=a.keySet(),e=0;e<d.length;e++)c.put(d[e],a.get(d[e]));d=b.keySet();for(var e=0;e<d.length;e++)c.put(d[e],b.get(d[e]));return c},a.prototype.GetTagMapWithLexicalScope=function(){var a=null;if(a=null!=this.ParentNode?this.MergeTagMap(this.ParentNode.GetTagMapWithLexicalScope(),this.GetTagMap()):this.GetTagMap(),null!=this.SubNodeList)for(var b=0;b<v.Array_size(this.SubNodeList);b++){var c=v.Array_get(this.SubNodeList,b);c.IsContext()&&(a=this.MergeTagMap(a,c.GetTagMap()))}return a},a.prototype.GetLastNode=function(b,c){if(null!=this.SubNodeList)for(var d=v.Array_size(this.SubNodeList)-1;d>=0;d--){var e=v.Array_get(this.SubNodeList,d);if(e.NodeType==b)return e}return 2==b&&c?new a(this.BaseDoc,this,2,this.LabelName,this.UID,null):null},a.prototype.FormatNode=function(a){if(a.print(e.FormatGoalLevel(this.GetGoalLevel())),a.print(" "),a.print(null!=this.LabelName?this.LabelName:e.FormatNodeType(this.NodeType)),a.print(" &"),a.print(v.DecToHex(this.UID)),null!=this.Created){var b=this.GetHistoryTaple();a.print(" "+b)}a.newline(),null==this.NodeDoc||v.Object_equals(this.NodeDoc,"")||(a.print(this.NodeDoc),a.newline()),a.newline();for(var c=0;c<v.Array_size(this.NonNullSubNodeList());c++){var d=v.Array_get(this.NonNullSubNodeList(),c);d.IsContext()&&d.FormatNode(a)}for(var c=0;c<v.Array_size(this.NonNullSubNodeList());c++){var d=v.Array_get(this.NonNullSubNodeList(),c);d.IsContext()||d.FormatNode(a)}},a.prototype.FormatSubNode=function(a,b,c){if(b.print(e.FormatGoalLevel(a)),b.print(" "),b.print(null!=this.LabelName?this.LabelName:e.FormatNodeType(this.NodeType)),b.print(" &"),b.print(v.DecToHex(this.UID)),b.newline(),null==this.NodeDoc||v.Object_equals(this.NodeDoc,"")||(b.print(this.NodeDoc),b.newline()),c&&(b.newline(),null!=this.NonNullSubNodeList())){for(var d=0;d<v.Array_size(this.NonNullSubNodeList());d++){var f=v.Array_get(this.NonNullSubNodeList(),d);f.IsContext()&&f.FormatSubNode(f.IsGoal()?a+1:a,b,c)}for(var d=0;d<v.Array_size(this.NonNullSubNodeList());d++){var f=v.Array_get(this.NonNullSubNodeList(),d);f.IsContext()||f.FormatSubNode(f.IsGoal()?a+1:a,b,c)}}},a.prototype.ReplaceSubNode=function(a,b){if(this.MergeDocHistory(a),null!=this.ParentNode)for(var c=0;c<v.Array_size(this.ParentNode.SubNodeList);c++)v.Array_get(this.ParentNode.SubNodeList,c)==this&&(v.Array_set(this.ParentNode.SubNodeList,c,a),a.ParentNode=this.ParentNode);else a.IsGoal(),this.BaseDoc.TopNode=a;return b||(a.SubNodeList=this.SubNodeList),a},a.prototype.ReplaceSubNodeAsText=function(a,d){d||(a=e.CommentOutSubNode(a));var f=new b(a),g=new j(null),h=g.ParseNode(f);if(h.NodeType!=this.NodeType){var i=new c;h.FormatNode(i),this.NodeDoc=e.CommentOutAll(i.toString()),h=this}return null!=h&&(h=this.ReplaceSubNode(h,d)),h},a.prototype.HasSubNodeUID=function(a){if(a==this.UID)return!0;for(var b=0;b<v.Array_size(this.NonNullSubNodeList());b++){var c=v.Array_get(this.NonNullSubNodeList(),b);if(c.HasSubNodeUID(a))return!0}return!1},a.prototype.Merge=function(a,b){if(a.LastModified.Rev>b)return this.ReplaceSubNode(a,!0),this;for(var c=0,d=0;null!=a.SubNodeList&&c<v.Array_size(a.SubNodeList);c++){for(var e=v.Array_get(a.SubNodeList,c);null!=this.SubNodeList&&d<v.Array_size(this.SubNodeList);d++){var f=v.Array_get(this.SubNodeList,d);if(f.UID==e.UID){f.Merge(e,b);break}}d==v.Array_size(this.SubNodeList)&&v.Array_add(this.SubNodeList,e)}return this},a.prototype.MergeDocHistory=function(a){null!=this.BaseDoc,a.LastModified=null;var b=a.UID,c=this.BaseDoc.GetNode(b);null!=c&&this.HasSubNodeUID(b)&&(a.Created=c.Created,a.LastModified=v.EqualsDigest(c.Digest,a.Digest)?c.LastModified:this.BaseDoc.DocHistory),null==a.LastModified&&(a.Created=this.BaseDoc.DocHistory,a.LastModified=this.BaseDoc.DocHistory),a.BaseDoc=this.BaseDoc;for(var d=0;d<v.Array_size(a.NonNullSubNodeList());d++){var e=v.Array_get(a.NonNullSubNodeList(),d);this.MergeDocHistory(e)}},a.prototype.IsNewerTree=function(a){if(a<=this.LastModified.Rev){for(var b=0;b<v.Array_size(this.NonNullSubNodeList());b++){var c=v.Array_get(this.NonNullSubNodeList(),b);if(!c.IsNewerTree(a))return!1}return!0}return!1},a.prototype.ListSubGoalNode=function(a){for(var b=0;b<v.Array_size(this.NonNullSubNodeList());b++){var c=v.Array_get(this.NonNullSubNodeList(),b);c.IsGoal()&&v.Array_add(a,c),c.IsStrategy()&&c.ListSubGoalNode(a)}},a.prototype.ListSectionNode=function(a){for(var b=0;b<v.Array_size(this.NonNullSubNodeList());b++){var c=v.Array_get(this.NonNullSubNodeList(),b);c.IsGoal()||v.Array_add(a,c),(c.IsStrategy()||c.IsEvidence())&&c.ListSectionNode(a)}},a.prototype.RenumberGoalRecursive=function(a,b,c){this.IsGoal();var d=new s;d.add(this);for(var e;null!=(e=d.poll());){for(;null!=c.get(""+a);)a++;e.AssignedLabelNumber=""+a,a++;var f=new Array;e.ListSectionNode(f);for(var g=1,h=0;h<v.Array_size(f);h++,g+=1){var i=v.Array_get(f,h),j=e.GetLabelNumber()+"."+g;null==c.get(j)&&(i.AssignedLabelNumber=e.GetLabelNumber()+"."+g)}v.Array_clear(f),e.ListSubGoalNode(f);for(var h=0;h<v.Array_size(f);h++){var k=v.Array_get(f,h);d.add(k),b+=1}}},a.prototype.RenumberGoal=function(a,b){var c=new t;this.RenumberGoalRecursive(a,b,c)},a.prototype.SearchNode=function(a){var b=new Array;v.String_matches(this.NodeDoc,a)&&v.Array_add(b,this);for(var c=0;c<v.Array_size(this.NonNullSubNodeList());c++){var d=v.Array_get(this.NonNullSubNodeList(),c);v.Array_addAll(b,d.SearchNode(a))}return b},a.prototype.GetNodeCount=function(){for(var a=1,b=0;b<v.Array_size(this.NonNullSubNodeList());b++)a+=v.Array_get(this.NonNullSubNodeList(),b).GetNodeCount();return a},a.prototype.GetNodeCountTypeOf=function(a){for(var b=this.NodeType==a?1:0,c=0;c<v.Array_size(this.NonNullSubNodeList());c++)b+=v.Array_get(this.NonNullSubNodeList(),c).GetNodeCountTypeOf(a);return b},a}();a.GSNNode=g;var h=function(){function a(a){this.Record=a,this.TopNode=null,this.NodeMap=new t,this.DocTagMap=new t,this.DocHistory=null,this.GoalCount=0}return a.prototype.DeepCopy=function(b,c,d,e){var f=new a(this.Record);return f.GoalCount=this.GoalCount,f.DocHistory=this.Record.NewHistory(b,c,d,e,f),f.DocTagMap=this.DuplicateTagMap(this.DocTagMap),null!=this.TopNode&&(f.TopNode=this.TopNode.DeepCopy(f,null)),f},a.prototype.DuplicateTagMap=function(a){return null!=a?new t(a):null},a.prototype.UpdateDocHeader=function(){var a=f.GetInteger(this.DocTagMap,"Revision",-1);if(-1!=a&&(this.DocHistory=this.Record.GetHistory(a),null!=this.DocHistory&&(this.DocHistory.Doc=this)),null==this.DocHistory){var b=f.GetString(this.DocTagMap,"Author","unknown"),c=f.GetString(this.DocTagMap,"Role","converter"),d=f.GetString(this.DocTagMap,"Date",null),e=f.GetString(this.DocTagMap,"Process","-");this.DocHistory=this.Record.NewHistory(b,c,d,e,this)}},a.prototype.GetNode=function(a){return this.NodeMap.get(a)},a.prototype.UncheckAddNode=function(a){this.NodeMap.put(a.UID,a)},a.prototype.AddNode=function(a){var b=a.UID,c=this.NodeMap.get(b);null!=c&&v.EqualsDigest(c.Digest,a.Digest)&&(a.Created=c.Created),this.NodeMap.put(b,a),0==a.NodeType&&1==a.GetGoalLevel()&&(this.TopNode=a)},a.prototype.RemapNodeMap=function(){var a=new t;null!=this.TopNode&&this.TopNode.Remap(a),this.NodeMap=a},a.prototype.RemoveNode=function(a){this==a.BaseDoc,null!=a.ParentNode&&v.Array_remove(a.ParentNode.SubNodeList,a),this.RemapNodeMap()},a.prototype.FormatDoc=function(a){null!=this.TopNode&&(a.println("Revision:: "+this.DocHistory.Rev),null!=f.GetString(this.DocTagMap,"CommitMessage",null)&&a.println("CommitMessage:: "+f.GetString(this.DocTagMap,"CommitMessage",null)),this.TopNode.FormatNode(a))},a.prototype.GetLabelMap=function(){var a,b=new t,c=new s;for(c.add(this.TopNode);null!=(a=c.poll());){null!=a.LabelName&&b.put(a.LabelName,a.GetLabel());for(var d=0;null!=a.SubNodeList&&d<v.Array_size(a.SubNodeList);d++)c.add(v.Array_get(a.SubNodeList,d))}return b},a.prototype.GetNodeCount=function(){return this.TopNode.GetNodeCount()},a.prototype.GetNodeCountTypeOf=function(a){return this.TopNode.GetNodeCountTypeOf(a)},a.prototype.RenumberAll=function(){null!=this.TopNode&&this.TopNode.RenumberGoal(1,2)},a}();a.GSNDoc=h;var i=function(){function a(){this.HistoryList=new Array,this.EditingDoc=null}return a.prototype.DeepCopy=function(){for(var b=new a,c=0;c<v.Array_size(this.HistoryList);c++){var d=v.Array_get(this.HistoryList,c);v.Array_add(b.HistoryList,d)}return b.EditingDoc=this.EditingDoc,b},a.prototype.GetHistory=function(a){return a<v.Array_size(this.HistoryList)?v.Array_get(this.HistoryList,a):null},a.prototype.GetHistoryDoc=function(a){var b=this.GetHistory(a);return null!=b?b.Doc:null},a.prototype.NewHistory=function(a,b,c,e,f){var g=new d(v.Array_size(this.HistoryList),a,b,c,e,f);return v.Array_add(this.HistoryList,g),g},a.prototype.AddHistory=function(a,b,c,e,f,g){if(a>=0){for(var h=new d(a,b,c,e,f,g);!(a<v.Array_size(this.HistoryList));)v.Array_add(this.HistoryList,new d(a,b,c,e,f,g));if(a>=0&&a<v.Array_size(this.HistoryList)){var i=v.Array_get(this.HistoryList,a);i.UpdateHistory(a,b,c,e,f,g)}v.Array_set(this.HistoryList,a,h),null!=g&&(g.DocHistory=h)}},a.prototype.ParseHistoryTag=function(a,b){var c=a.indexOf("::");if(-1!=c){var d=a.substring(0,c).trim();try{var f=a.substring(c+2).trim(),g=f.split(";");this.AddHistory(e.ParseInt(d.substring(1),-1),g[1],g[2],g[0],g[3],null)}catch(h){b.LogError("Invalid format of history tag",h.getMessage())}}},a.prototype.Parse=function(a){for(var c=new b(a);c.HasNext();){var d=new h(this),e=new j(d);d.TopNode=e.ParseNode(c),d.RenumberAll()}for(var g=0;g<v.Array_size(this.HistoryList);g++){var i=v.Array_get(this.HistoryList,g);0!=g&&null==f.GetString(i.Doc.DocTagMap,"CommitMessage",null)&&(i.IsCommitRevision=!1)}},a.prototype.RenumberAll=function(){var a=this.GetLatestDoc();null!=a&&null!=a.TopNode&&a.RenumberAll()},a.prototype.OpenEditor=function(a,b,c,d){if(null==this.EditingDoc){var e=this.GetLatestDoc();null!=e?this.EditingDoc=e.DeepCopy(a,b,c,d):(this.EditingDoc=new h(this),this.EditingDoc.DocHistory=this.NewHistory(a,b,c,d,this.EditingDoc))}this.EditingDoc.DocHistory.IsCommitRevision=!1},a.prototype.CloseEditor=function(){this.EditingDoc=null},a.prototype.DiscardEditor=function(){this.EditingDoc=null,v.Array_remove(this.HistoryList,v.Array_size(this.HistoryList)-1)},a.prototype.Merge=function(a){for(var b=-1,c=0;c<v.Array_size(this.HistoryList);c++){var d=this.GetHistory(c),e=a.GetHistory(c);if(null==e||!d.EqualsHistory(e))break;b=c}-1==b?this.MergeAsReplaceTopGoal(a):b==v.Array_size(this.HistoryList)-1?this.MergeAsFastFoward(a):b!=v.Array_size(a.HistoryList)-1&&this.MergeConflict(a,b)},a.prototype.MergeConflict=function(a,b){for(var c=v.Array_get(this.HistoryList,v.Array_size(this.HistoryList)-1),d=null,e=b+1;e<v.Array_size(a.HistoryList);e++)d=v.Array_get(a.HistoryList,e),v.Array_add(this.HistoryList,d);var f=new h(this);f.TopNode=c.Doc.TopNode.Merge(d.Doc.TopNode,b),f.DocHistory=this.NewHistory(d.Author,d.Role,null,"merge",f)},a.prototype.MergeAsFastFoward=function(a){for(var b=v.Array_size(this.HistoryList);b<v.Array_size(a.HistoryList);b++){var c=a.GetHistoryDoc(b);null!=c&&(c.Record=this,v.Array_add(this.HistoryList,c.DocHistory))}},a.prototype.MergeAsReplaceTopGoal=function(a){for(var b=0;b<v.Array_size(a.HistoryList);b++){var c=v.Array_get(a.HistoryList,b),d=null!=c?c.Doc:null;null!=d&&(this.OpenEditor(c.Author,c.Role,c.DateString,c.Process),this.EditingDoc.TopNode.ReplaceSubNode(d.TopNode,!0),this.CloseEditor())}},a.prototype.MergeAsIncrementalAddition=function(a,b,c,d){for(;a<v.Array_size(b.HistoryList)&&c<v.Array_size(d.HistoryList);){var e=b.GetHistory(a),f=d.GetHistory(c);(null==e||null==e.Doc)&&a<v.Array_size(b.HistoryList)?a++:(null==f||null==f.Doc)&&c<v.Array_size(d.HistoryList)?c++:e.CompareDate(f)<0?(this.OpenEditor(e.Author,e.Role,e.DateString,e.Process),a++,this.EditingDoc.TopNode.ReplaceSubNode(e.Doc.TopNode,!0),this.CloseEditor()):(this.OpenEditor(f.Author,f.Role,f.DateString,f.Process),c++,this.EditingDoc.TopNode.ReplaceSubNode(f.Doc.TopNode,!0),this.CloseEditor())}},a.prototype.GetLatestDoc=function(){for(var a=v.Array_size(this.HistoryList)-1;a>=0;a++){var b=this.GetHistoryDoc(a);if(null!=b)return b}return null},a.prototype.Commit=function(a){this.GetLatestDoc().DocHistory.IsCommitRevision=!0,this.GetLatestDoc().DocTagMap.put("CommitMessage",a)},a.prototype.FormatRecord=function(a){for(var b=0,c=v.Array_size(this.HistoryList)-1;c>=0;c--){var d=this.GetHistoryDoc(c);null!=d&&(b>0&&a.println(v.VersionDelim),f.FormatHistoryTag(this.HistoryList,c,a),d.FormatDoc(a),b+=1)}},a}();a.GSNRecord=i;var j=function(){function a(a){var b=new g(a,null,0,null,-1,null);this.NullableDoc=a,this.FirstNode=null,this.LastGoalNode=null,this.LastNonContextNode=null,this.GoalStack=new Array,this.random=new m(n.currentTimeMillis()),this.SetGoalStackAt(b)}return a.prototype.SetLastNode=function(a){a.IsGoal()&&(this.LastGoalNode=a,this.SetGoalStackAt(a)),a.IsContext()||(this.LastNonContextNode=a)},a.prototype.GetStrategyOfGoal=function(a){if(a-1<v.Array_size(this.GoalStack)){var b=this.GetGoalStackAt(a-1);if(null!=b)return b.GetLastNode(2,!0)}return null},a.prototype.GetGoalStackAt=function(a){return a>=0&&a<v.Array_size(this.GoalStack)?v.Array_get(this.GoalStack,a):null},a.prototype.SetGoalStackAt=function(a){for(var b=a.GetGoalLevel();!(b-1<v.Array_size(this.GoalStack));)v.Array_add(this.GoalStack,null);v.Array_set(this.GoalStack,b-1,a)},a.prototype.IsValidSection=function(a,b){var c=e.ParseNodeType(a),d=e.ParseGoalLevel(a);if(0==c){var f=this.GetStrategyOfGoal(d);return null!=f?!0:(b.LogError("Mismatched goal level < "+v.Array_size(this.GoalStack),a),!1)}return null!=this.LastGoalNode&&v.Array_size(this.GoalStack)<=d?(b.LogError("Mismatched goal level < "+v.Array_size(this.GoalStack),a),!1):!0},a.prototype.CreateNewNode=function(a){var b=e.ParseNodeType(a),c=e.ParseLabelName(a),d=(e.ParseLabelNumber(a),null==e.ParseUID(a)?this.random.nextInt():v.HexToDec(e.ParseUID(a))),f=null,h=null,i=e.ParseHistory(a,this.NullableDoc),j=e.ParseGoalLevel(a);return h=0==b?this.GetStrategyOfGoal(j):1==b?this.LastNonContextNode:this.GetGoalStackAt(j),f=new g(this.NullableDoc,h,b,c,d,i),null==this.FirstNode&&(this.FirstNode=f),this.SetLastNode(f),null!=this.NullableDoc&&this.NullableDoc.AddNode(f),f
},a.prototype.RemoveSentinel=function(){null!=this.FirstNode&&null!=this.FirstNode.ParentNode&&(this.FirstNode.ParentNode=null)},a.prototype.ParseNode=function(a){for(;a.HasNext();){var b=a.ReadLine();if(v.String_startsWith(b,"*")){a.RollbackLineFeed();break}null!=this.NullableDoc&&(v.String_startsWith(b,"#")?this.NullableDoc.Record.ParseHistoryTag(b,a):f.ParseTag(this.NullableDoc.DocTagMap,b))}null!=this.NullableDoc&&this.NullableDoc.UpdateDocHeader(a);for(var c=null,d=new Array;a.HasNext();){var b=a.ReadLine();if(v.String_startsWith(b,"*")){if(v.String_startsWith(b,v.VersionDelim))break;if(this.IsValidSection(b,a)){this.UpdateContent(c,d),c=this.CreateNewNode(b,a);continue}}v.Array_add(d,b)}return this.UpdateContent(c,d),this.RemoveSentinel(),this.FirstNode},a.prototype.UpdateContent=function(a,b){null!=a&&a.SetContent(b),v.Array_clear(b)},a}();a.ParserContext=j;var k=function(){function a(){}return a.merge=function(a,b){var d=new i;if(d.Parse(v.ReadFile(a)),null!=b){var e=new i;e.Parse(v.ReadFile(b)),d.Merge(e)}var f=new c;d.FormatRecord(f),console.log(f.toString())},a.ts_merge=function(){var a=v.Input.length>0?v.Input[0]:null,b=v.Input.length>1?v.Input[1]:null,d=new i;if(d.Parse(a),null!=b){var e=new i;e.Parse(v.ReadFile(b)),d.Merge(e)}else d.RenumberAll();var f=new c;d.FormatRecord(f),console.log(f.toString())},a.main=function(b){if(2==b.length){var d=new i;d.Parse(v.ReadFile(b[0]));var e=d.GetLatestDoc().TopNode.ReplaceSubNodeAsText(v.ReadFile(b[1]),!0),f=new c;e.FormatNode(f),console.log(f.toString())}1==b.length&&a.merge(b[0],null),console.log("Usage: AssureNoteParser file [margingfile]")},a}();a.AssureNoteParser=k;var l=function(){function a(){}return a.main=function(){},a}();a.PdfConverter=l;var m=function(){function a(){}return a.prototype.nextInt=function(){return Math.floor(2147483647*Math.random())},a}();a.Random=m;var n=function(){function a(){}return a.currentTimeMillis=function(){return(new Date).getTime()},a}();a.System=n;var o=function(){function a(){this.str=""}return a.prototype.append=function(a){this.str+=a},a.prototype.toString=function(){return this.str},a}();a.StringBuilder=o;var p=function(){function a(){}return a.isDigit=function(a){return a>=48&&57>=a},a.isWhitespace=function(a){return 9==a||10==a||12==a||13==a||32==a},a}();a.Character=p;var q=function(){function a(){}return a.prototype.fillZero=function(a){return 10>a?"0"+a:""+a},a.prototype.parse=function(a){return new Date(a)},a.prototype.formatTimezone=function(a){var b="",c=a/-60;return b=Math.abs(c)<10?"0"+Math.abs(c)+"00":Math.abs(c)+"00",c>0?"+"+b:"-"+b},a.prototype.format=function(a){var b=this.fillZero(a.getFullYear()),c=this.fillZero(a.getMonth()+1),d=this.fillZero(a.getDate()),e=this.fillZero(a.getHours()),f=this.fillZero(a.getMinutes()),g=this.fillZero(a.getSeconds()),h=this.formatTimezone(a.getTimezoneOffset());return b+"-"+c+"-"+d+"T"+e+":"+f+":"+g+h},a}();a.SimpleDateFormat=q;var r=function(){function a(){this.list=[]}return a.prototype.add=function(a){this.list.push(a)},a.prototype.poll=function(){if(0==this.list.length)return null;var a=this.list[0];return this.list=this.list.slice(1),a},a}();a.Queue=r;var s=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b}(r);a.LinkedList=s;var t=function(){function a(a){if(this.hash={},null!=a)for(var b=a.keySet(),c=0;c<b.length;c++)this.hash[b[c]]=a[b[c]]}return a.prototype.put=function(a,b){this.hash[String(a)]=b},a.prototype.get=function(a){return this.hash[String(a)]},a.prototype.size=function(){return Object.keys(this.hash).length},a.prototype.clear=function(){this.hash={}},a.prototype.keySet=function(){return Object.keys(this.hash)},a.prototype.toArray=function(){var a=[];for(var b in Object.keys(this.hash))a.push(this.hash[b]);return a},a}();a.HashMap=t;var u=function(){function a(){this.digestString=null}return a.prototype.digest=function(){return this.digestString},a}();a.MessageDigest=u;var v=function(){function a(){}return a.GetMD5=function(){return new u},a.UpdateMD5=function(b,c){b.digestString=a.md5(c)},a.EqualsDigest=function(a,b){return a==b},a.ReadFile=function(){return""},a.parseInt=function(a){return Number(a)},a.HexToDec=function(a){return parseInt(a,16)},a.DecToHex=function(a){return a.toString(16)},a.String_startsWith=function(a,b){return 0==a.indexOf(b,0)},a.String_compareTo=function(a,b){return b>a?-1:a>b?1:0},a.String_endsWith=function(a,b){return 0==a.lastIndexOf(b,0)},a.String_matches=function(a,b){return null!=a.match(b)},a.Array_get=function(a,b){if(b>=a.length)throw new RangeError("invalid array index");return a[b]},a.Array_set=function(a,b,c){a[b]=c},a.Array_add=function(a,b){a.push(b)},a.Array_add2=function(a,b,c){a.splice(b,0,c)},a.Array_addAll=function(a,b){Array.prototype.push.apply(a,b)},a.Array_size=function(a){return a.length},a.Array_clear=function(a){a.length=0},a.Array_remove=function(a,b){if("number"==typeof b){if(b>=a.length)throw new RangeError("invalid array index")}else{b=0;for(var c in a)if(a[c]===b)break;if(c==a.length)return null}var d=a[b];return a.splice(b,1),d},a.Object_equals=function(a,b){return a===b},a.Object_InstanceOf=function(a,b){return a.constructor==b},a.Input=[],a.EmptyNodeList=new Array,a.LineFeed="\n",a.VersionDelim="*=====",a}();a.Lib=v;var w=function(){function a(){}return a}();a.Iterator=w,Object.defineProperty(Array.prototype,"addAll",{enumerable:!1,value:function(a){Array.prototype.push.apply(this,a)}}),Object.defineProperty(Array.prototype,"size",{enumerable:!1,value:function(){return this.length}}),Object.defineProperty(Array.prototype,"add",{enumerable:!1,value:function(a){if(1==arguments.length)this.push(a);else{var b=arguments[1];this.splice(a,0,b)}}}),Object.defineProperty(Array.prototype,"get",{enumerable:!1,value:function(a){if(a>=this.length)throw new RangeError("invalid array index");return this[a]}}),Object.defineProperty(Array.prototype,"set",{enumerable:!1,value:function(a,b){this[a]=b}}),Object.defineProperty(Array.prototype,"remove",{enumerable:!1,value:function(a){if("number"==typeof a){if(a>=this.length)throw new RangeError("invalid array index")}else{a=0;for(var b in this)if(this[b]===a)break;if(b==this.length)return null}var c=this[a];return this.splice(a,1),c}}),Object.defineProperty(Array.prototype,"clear",{enumerable:!1,value:function(){this.length=0}}),Object.defineProperty(Object.prototype,"equals",{enumerable:!1,value:function(a){return this===a}}),Object.defineProperty(Object.prototype,"InstanceOf",{enumerable:!1,value:function(a){return this.constructor==a}}),Object.defineProperty(String.prototype,"compareTo",{enumerable:!1,value:function(a){return a>this?-1:this>a?1:0}}),Object.defineProperty(String.prototype,"startsWith",{enumerable:!1,value:function(a){return 0==this.indexOf(a,0)}}),Object.defineProperty(String.prototype,"endsWith",{enumerable:!1,value:function(a){return 0==this.lastIndexOf(a,0)}}),Object.defineProperty(String.prototype,"equals",{enumerable:!1,value:function(a){return this==a}}),Object.defineProperty(String.prototype,"matches",{enumerable:!1,value:function(a){return null!=this.match(a)}}),function(a){"use strict";function b(a,b){var c=(65535&a)+(65535&b),d=(a>>16)+(b>>16)+(c>>16);return d<<16|65535&c}function c(a,b){return a<<b|a>>>32-b}function d(a,d,e,f,g,h){return b(c(b(b(d,a),b(f,h)),g),e)}function e(a,b,c,e,f,g,h){return d(b&c|~b&e,a,b,f,g,h)}function f(a,b,c,e,f,g,h){return d(b&e|c&~e,a,b,f,g,h)}function g(a,b,c,e,f,g,h){return d(b^c^e,a,b,f,g,h)}function h(a,b,c,e,f,g,h){return d(c^(b|~e),a,b,f,g,h)}function i(a,c){a[c>>5]|=128<<c%32,a[(c+64>>>9<<4)+14]=c;var d,i,j,k,l,m=1732584193,n=-271733879,o=-1732584194,p=271733878;for(d=0;d<a.length;d+=16)i=m,j=n,k=o,l=p,m=e(m,n,o,p,a[d],7,-680876936),p=e(p,m,n,o,a[d+1],12,-389564586),o=e(o,p,m,n,a[d+2],17,606105819),n=e(n,o,p,m,a[d+3],22,-1044525330),m=e(m,n,o,p,a[d+4],7,-176418897),p=e(p,m,n,o,a[d+5],12,1200080426),o=e(o,p,m,n,a[d+6],17,-1473231341),n=e(n,o,p,m,a[d+7],22,-45705983),m=e(m,n,o,p,a[d+8],7,1770035416),p=e(p,m,n,o,a[d+9],12,-1958414417),o=e(o,p,m,n,a[d+10],17,-42063),n=e(n,o,p,m,a[d+11],22,-1990404162),m=e(m,n,o,p,a[d+12],7,1804603682),p=e(p,m,n,o,a[d+13],12,-40341101),o=e(o,p,m,n,a[d+14],17,-1502002290),n=e(n,o,p,m,a[d+15],22,1236535329),m=f(m,n,o,p,a[d+1],5,-165796510),p=f(p,m,n,o,a[d+6],9,-1069501632),o=f(o,p,m,n,a[d+11],14,643717713),n=f(n,o,p,m,a[d],20,-373897302),m=f(m,n,o,p,a[d+5],5,-701558691),p=f(p,m,n,o,a[d+10],9,38016083),o=f(o,p,m,n,a[d+15],14,-660478335),n=f(n,o,p,m,a[d+4],20,-405537848),m=f(m,n,o,p,a[d+9],5,568446438),p=f(p,m,n,o,a[d+14],9,-1019803690),o=f(o,p,m,n,a[d+3],14,-187363961),n=f(n,o,p,m,a[d+8],20,1163531501),m=f(m,n,o,p,a[d+13],5,-1444681467),p=f(p,m,n,o,a[d+2],9,-51403784),o=f(o,p,m,n,a[d+7],14,1735328473),n=f(n,o,p,m,a[d+12],20,-1926607734),m=g(m,n,o,p,a[d+5],4,-378558),p=g(p,m,n,o,a[d+8],11,-2022574463),o=g(o,p,m,n,a[d+11],16,1839030562),n=g(n,o,p,m,a[d+14],23,-35309556),m=g(m,n,o,p,a[d+1],4,-1530992060),p=g(p,m,n,o,a[d+4],11,1272893353),o=g(o,p,m,n,a[d+7],16,-155497632),n=g(n,o,p,m,a[d+10],23,-1094730640),m=g(m,n,o,p,a[d+13],4,681279174),p=g(p,m,n,o,a[d],11,-358537222),o=g(o,p,m,n,a[d+3],16,-722521979),n=g(n,o,p,m,a[d+6],23,76029189),m=g(m,n,o,p,a[d+9],4,-640364487),p=g(p,m,n,o,a[d+12],11,-421815835),o=g(o,p,m,n,a[d+15],16,530742520),n=g(n,o,p,m,a[d+2],23,-995338651),m=h(m,n,o,p,a[d],6,-198630844),p=h(p,m,n,o,a[d+7],10,1126891415),o=h(o,p,m,n,a[d+14],15,-1416354905),n=h(n,o,p,m,a[d+5],21,-57434055),m=h(m,n,o,p,a[d+12],6,1700485571),p=h(p,m,n,o,a[d+3],10,-1894986606),o=h(o,p,m,n,a[d+10],15,-1051523),n=h(n,o,p,m,a[d+1],21,-2054922799),m=h(m,n,o,p,a[d+8],6,1873313359),p=h(p,m,n,o,a[d+15],10,-30611744),o=h(o,p,m,n,a[d+6],15,-1560198380),n=h(n,o,p,m,a[d+13],21,1309151649),m=h(m,n,o,p,a[d+4],6,-145523070),p=h(p,m,n,o,a[d+11],10,-1120210379),o=h(o,p,m,n,a[d+2],15,718787259),n=h(n,o,p,m,a[d+9],21,-343485551),m=b(m,i),n=b(n,j),o=b(o,k),p=b(p,l);return[m,n,o,p]}function j(a){var b,c="";for(b=0;b<32*a.length;b+=8)c+=String.fromCharCode(a[b>>5]>>>b%32&255);return c}function k(a){var b,c=[];for(c[(a.length>>2)-1]=void 0,b=0;b<c.length;b+=1)c[b]=0;for(b=0;b<8*a.length;b+=8)c[b>>5]|=(255&a.charCodeAt(b/8))<<b%32;return c}function l(a){return j(i(k(a),8*a.length))}function m(a,b){var c,d,e=k(a),f=[],g=[];for(f[15]=g[15]=void 0,e.length>16&&(e=i(e,8*a.length)),c=0;16>c;c+=1)f[c]=909522486^e[c],g[c]=1549556828^e[c];return d=i(f.concat(k(b)),512+8*b.length),j(i(g.concat(d),640))}function n(a){var b,c,d="0123456789abcdef",e="";for(c=0;c<a.length;c+=1)b=a.charCodeAt(c),e+=d.charAt(b>>>4&15)+d.charAt(15&b);return e}function o(a){return unescape(encodeURIComponent(a))}function p(a){return l(o(a))}function q(a){return n(p(a))}function r(a,b){return m(o(a),o(b))}function s(a,b){return n(r(a,b))}function t(a,b,c){return b?c?r(b,a):s(b,a):c?p(a):q(a)}a.md5=t}(v)}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(){function b(b){this.NodeIndex=0,this.NodeList=[],this.Visiting=!1,this.ColorStyle=a.ColorStyle.Searched,this.Panel=b}return b.prototype.StartVisit=function(a){this.IsVisiting()&&this.FinishVisit(),this.NodeList=a,this.NodeList.length>0&&(this.Visiting=!0,this.UnfoldAllFoundNode(),this.AddColorToAllHitNodes(this.ColorStyle),this.Panel.FocusAndMoveToNode(this.NodeList[0].GetLabel()))},b.prototype.VisitNext=function(a){if(this.IsVisiting()&&this.NodeList.length>1){var b=this.NodeList.length;this.NodeIndex=(b+this.NodeIndex+(a?-1:1))%b,this.Panel.FocusAndMoveToNode(this.NodeList[this.NodeIndex].GetLabel())}},b.prototype.UnfoldAllFoundNode=function(){for(var a=this.Panel.ViewMap,b=0;b<this.NodeList.length;b++)for(var c=a[this.NodeList[b].GetLabel()];null!=c;)c.SetIsFolded(!1),c=c.Parent;this.Panel.Draw(this.Panel.TopNodeView.Label,300)},b.prototype.IsVisiting=function(){return this.Visiting},b.prototype.FinishVisit=function(){this.RemoveColorFromAllHitNodes(this.ColorStyle),this.NodeList=[],this.NodeIndex=0,this.Visiting=!1},b.prototype.AddColorToAllHitNodes=function(a){for(var b=this.Panel.ViewMap,c=0;c<this.NodeList.length;c++){var d=b[this.NodeList[c].GetLabel()];null!=d&&d.GetShape().AddColorStyle(a)}},b.prototype.RemoveColorFromAllHitNodes=function(a){for(var b=this.Panel.ViewMap,c=0;c<this.NodeList.length;c++){var d=b[this.NodeList[c].GetLabel()];null!=d&&d.GetShape().RemoveColorStyle(a)}},b}();a.VisitableNodeList=b;var c=function(a){function b(b){a.call(this,b)}return __extends(b,a),b.prototype.Search=function(a,b){this.StartVisit(a.Model.SearchNode(b))},b}(b);a.SearchResultNodeList=c}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(){function a(a){this.AssureNoteApp=a}return a.prototype.DoLayout=function(){},a}();a.LayoutEngine=b;var c=function(b){function c(a){b.call(this,a),this.AssureNoteApp=a}return __extends(c,b),c.prototype.Render=function(a,b,c,d){var e=this;a.IsVisible&&(a.GetShape().PrerenderContent(this.AssureNoteApp.PluginManager),a.Render(b,c,d),a.IsFolded()||a.ForEachVisibleAllSubNodes(function(a){e.Render(a,b,c,d)}))},c.prototype.DoLayout=function(b,c){var d=document.createDocumentFragment(),e=document.createDocumentFragment(),f=document.createDocumentFragment(),g=document.createDocumentFragment(),h=a.AssureNoteUtils.GetTime();this.Render(c,d,e,f);var i=a.AssureNoteUtils.GetTime();console.log("Render: "+(i-h)),b.ContentLayer.appendChild(d),b.SVGLayerConnectorGroup.appendChild(f),b.SVGLayerNodeGroup.appendChild(e),this.PrepareNodeSize(c),g.appendChild(d),g.appendChild(f),g.appendChild(e);var j=a.AssureNoteUtils.GetTime();console.log("NodeSize: "+(j-i)),this.Layout(c),b.ContentLayer.appendChild(d),b.SVGLayer.appendChild(f),b.SVGLayer.appendChild(e);var k=a.AssureNoteUtils.GetTime();console.log("Layout: "+(k-j))},c.prototype.PrepareNodeSize=function(a){var b=this,c=a.GetShape();c.GetNodeWidth(),c.GetNodeHeight(),a.IsFolded()||(a.ForEachVisibleLeftNodes(function(a){b.PrepareNodeSize(a)}),a.ForEachVisibleRightNodes(function(a){b.PrepareNodeSize(a)}),a.ForEachVisibleChildren(function(a){b.PrepareNodeSize(a)}))},c.prototype.Layout=function(a){var b=this;if(a.IsVisible){var d=a.GetShape();if(!a.ShouldReLayout())return void a.TraverseVisibleNode(function(a){a.Shape.FitSizeToContent()});a.SetShouldReLayout(!1),d.FitSizeToContent();var e=0,f=d.GetNodeWidth(),g=f,h=d.GetNodeHeight();if(a.IsFolded())return d.SetHeadRect(0,0,f,h),void d.SetTreeRect(0,0,f,h);if(null!=a.Left){var i=0,j=-c.ContextVerticalMargin;a.ForEachVisibleLeftNodes(function(a){a.GetShape().FitSizeToContent(),j+=c.ContextVerticalMargin,a.RelativeX=-(a.Shape.GetNodeWidth()+c.ContextHorizontalMargin),a.RelativeY=j,i=Math.max(i,a.Shape.GetNodeWidth()),j+=a.Shape.GetNodeHeight()});var k=(a.Shape.GetNodeHeight()-j)/2;k>0&&a.ForEachVisibleLeftNodes(function(a){a.RelativeY+=k}),j>0&&(e=-(i+c.ContextHorizontalMargin),h=Math.max(h,j))}if(null!=a.Right){var l=0,m=-c.ContextVerticalMargin;a.ForEachVisibleRightNodes(function(a){a.GetShape().FitSizeToContent(),m+=c.ContextVerticalMargin,a.RelativeX=f+c.ContextHorizontalMargin,a.RelativeY=m,l=Math.max(l,a.Shape.GetNodeWidth()),m+=a.Shape.GetNodeHeight()});var n=(a.Shape.GetNodeHeight()-m)/2;n>0&&a.ForEachVisibleRightNodes(function(a){a.RelativeY+=n}),m>0&&(g+=l+c.ContextHorizontalMargin,h=Math.max(h,m))}var o=g,p=g-e;d.SetHeadRect(e,0,p,h),h+=c.ChildrenVerticalMargin;var q=0,r=0,s=0,t=1/0,u=[],v=0;if(null!=a.Children&&a.Children.length>0){var w=!1;a.ForEachVisibleChildren(function(a){v++,b.Layout(a);var d=a.Shape.GetTreeWidth(),e=a.IsFolded()?a.Shape.GetNodeWidth():a.Shape.GetHeadWidth(),f=a.IsFolded()?a.Shape.GetNodeHeight():a.Shape.GetHeadHeight(),g=a.Shape.GetHeadLeftLocalX()-a.Shape.GetTreeLeftLocalX(),i=g+e,j=a.Shape.GetTreeHeight(),k=c.ChildrenHorizontalMargin,l=null==a.Children||0==a.Children.length,m=(a.IsFolded()||l)&&t>=f;if(m)a.RelativeX=q,q=q+e+k,u.push(a);else{if(w){var n=q-r;if(g>n)if(a.RelativeX=r,q=r+i+k,r=r+d+k,0==a.RelativeX)for(var o=0;o<u.length;o++)u[o].RelativeX+=g-n;else for(var p=(g-n)/(u.length+1),o=0;o<u.length;o++)u[o].RelativeX+=p*(o+1);else a.RelativeX=q-g,r=q+d-g+k,q=q+e+k}else{var x=Math.max(q,r);a.RelativeX=x,q=x+i+k,r=x+d+k}u=[],t=f,a.RelativeX+=-a.Shape.GetTreeLeftLocalX()}a.RelativeY=h,w=m,s=Math.max(s,j)});var x=Math.max(q,r)-c.ChildrenHorizontalMargin,y=(x-f)/2;1==v&&a.ForEachVisibleChildren(function(b){if(y=-b.Shape.GetTreeLeftLocalX(),!b.HasSideNode()||b.IsFolded()){var d=0,e=b.Shape.GetNodeHeight(),f=a.Shape.GetNodeHeight(),g=c.ChildrenVerticalMargin;d=!b.HasChildren()||f+2*g+e>h?h-(f+g):e+g,b.RelativeY-=d,s-=d}}),e=Math.min(e,-y),a.ForEachVisibleChildren(function(a){a.RelativeX-=y}),h+=s,g=Math.max(e+x,o)}d.SetTreeRect(e,0,g-e,h)}},c.ContextHorizontalMargin=32,c.ContextVerticalMargin=10,c.ChildrenVerticalMargin=64,c.ChildrenHorizontalMargin=12,c}(b);a.SimpleLayoutEngine=c}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(){function a(a,b,c,d){this.ElementId=a,this.ImagePath=b,this.Title=c,this.EventHandler=d,this.boolean=!1}return a.prototype.EnableEventHandler=function(a){var b=this;a.Menu.append('<a href="#" ><img id="'+this.ElementId+'" src="'+Config.BASEPATH+this.ImagePath+'" title="'+this.Title+'" alt="'+this.Title+'" /></a>'),$("#"+this.ElementId).click(function(c){b.EventHandler(c,a.CurrentView),a.Remove()})},a}();a.NodeMenuItem=b;var c=function(b){function c(a){b.call(this,a),this.AssureNoteApp=a,this.IsEnable=!1}return __extends(c,b),c.prototype.CreateButtons=function(a){for(var b=0,c=0;c<a.length;c++){var d=a[c];(1!=this.App.ModeManager.GetMode()||d.IsEnableOnViewOnlyMode)&&(d.EnableEventHandler(this),b++)}return b},c.prototype.Create=function(b,c,d){var e=this;this.IsEnable=!0,this.CurrentView=b,$("#menu").remove(),this.Menu=$('<div id="menu" style="display: none;"></div>'),this.Menu.appendTo(c);var f=this.CreateButtons(d);if(f>0){var g=function(){a.AssureNoteApp.Assert(null!=e.CurrentView);var b=e.CurrentView,c=b.GetGY()+b.Shape.GetNodeHeight()+5,d=b.GetGX()+(b.Shape.GetNodeWidth()-e.Menu.width())/2;e.Menu.css({position:"absolute",top:c,left:d,display:"block",opacity:0})};this.Menu.jqDock({align:"bottom",idle:1500,size:45,distance:60,labels:"tc",duration:200,fadeIn:200,source:function(){return this.src.replace(/(jpg|gif)$/,"png")},onReady:g})}},c.prototype.Remove=function(){this.Menu.remove(),this.Menu=null,this.CurrentView=null,this.IsEnable=!1},c}(a.Panel);a.NodeMenu=c}(AssureNote||(AssureNote={}));var AssureNote;!function(a){function b(a){d.OnLoadPlugin.push(a),null!=d.Current&&d.Current.LoadPlugin()}var c=function(){function a(){this.hasMenuBarButton=!1,this.hasEditor=!1,this.hasDoubleClicked=!1}return a.prototype.Display=function(){},a.prototype.OnNodeDoubleClicked=function(){},a.prototype.CreateMenuBarButton=function(){return null},a.prototype.CreateMenuBarButtons=function(){return null},a.prototype.CreateTooltipContents=function(){return null},a.prototype.RenderHTML=function(a){return a},a.prototype.RenderSVG=function(){},a.prototype.SetHasMenuBarButton=function(a){this.hasMenuBarButton=a},a.prototype.HasMenuBarButton=function(){return this.hasMenuBarButton},a.prototype.SetHasEditor=function(a){this.hasEditor=a},a.prototype.HasEditor=function(){return this.hasEditor},a.prototype.SetHasDoubleClicked=function(a){this.hasDoubleClicked=a},a.prototype.HasDoubleClicked=function(){return this.hasDoubleClicked},a}();a.Plugin=c,a.OnLoadPlugin=b;var d=function(){function a(b){this.AssureNoteApp=b,this.PluginMap={},a.Current=this}return a.prototype.LoadPlugin=function(){for(var b=0;b<a.OnLoadPlugin.length;b++)a.OnLoadPlugin[b](this.AssureNoteApp);a.OnLoadPlugin=[]},a.prototype.SetPlugin=function(a,b){this.PluginMap[a]?this.AssureNoteApp.DebugP("Plugin "+name+" already defined."):this.PluginMap[a]=b},a.prototype.GetPanelPlugin=function(a){return this.PluginMap[a]},a.prototype.GetCommandPlugin=function(a){return this.PluginMap[a]},a.prototype.GetMenuBarButtons=function(a){var b=this,c=[];return $.each(this.PluginMap,function(d,e){if(e.HasMenuBarButton()){b.AssureNoteApp.DebugP("Menu: key="+d);var f=e.CreateMenuBarButton(a);null!=f&&c.push(f);var g=e.CreateMenuBarButtons(a);null!=g&&(c=c.concat(g))}}),c},a.prototype.GetTooltipContents=function(a){var b=[];return $.each(this.PluginMap,function(c,d){var e=d.CreateTooltipContents(a);e&&(b=b.concat(e))}),b},a.prototype.GetDoubleClicked=function(){var a=[];return $.each(this.PluginMap,function(b,c){c.HasDoubleClicked()&&a.push(c)}),a},a.prototype.InvokeHTMLRenderPlugin=function(a,b){return $.each(this.PluginMap,function(c,d){a=d.RenderHTML(a,b)}),a},a.prototype.InvokeSVGRenderPlugin=function(a,b){$.each(this.PluginMap,function(c,d){d.RenderSVG(a,b)})},a.OnLoadPlugin=[],a}();a.PluginManager=d}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(b){function c(a,c,d,e,f,g){b.call(this,a),this.App=a,this.IsEditRecursive=c,this.Wrapper=f,this.WrapperCSS=g,this.Editor=CodeMirror.fromTextArea(d,e),$(this.Editor.getWrapperElement()).css({height:"100%",width:"100%",background:"rgba(255, 255, 255, 0.85)"}),this.Element=$(f),this.Element.css(g),this.Element.css({display:"none"})}return __extends(c,b),c.prototype.UpdateCSS=function(a){this.Element.css(a)},c.prototype.EnableEditor=function(a,b,c){var d=this;if(this.Timeout&&(this.Element.removeClass(),clearInterval(this.Timeout)),!c||1!=b.Status){this.Timeout=null;var e=b.Model;this.App.FullScreenEditorPanel.IsVisible=!1,this.App.SocketManager.StartEdit({UID:e.UID,IsRecursive:c,UserName:this.App.GetUserName()});{this.App}this.Editor.getDoc().setValue(a),this.OnOutSideClicked=function(){d.DisableEditor(b,a)},$("#editor-background").off("click").on("click",this.OnOutSideClicked),$("#editor-background").off("contextmenu").on("contextmenu",this.OnOutSideClicked),$("#editor-background").stop(!0,!0).css("opacity",this.DarkenBackGround()?.4:0).show(),this.Element.stop(!0,!0).css("opacity",1).show(),this.Editor.refresh(),this.Editor.focus(),this.Activate()}},c.prototype.DisableEditor=function(b,c){var d=this.Editor.getDoc().getValue();this.App.MasterRecord.OpenEditor(this.App.GetUserName(),"todo",null,"test");var e,f=this.App.MasterRecord.EditingDoc.GetNode(b.Model.UID);e=f.ReplaceSubNodeAsText(d,this.IsEditRecursive);var g=new a.StringWriter;if(e&&e.FormatSubNode(1,g,!0),g.toString().trim()!=c.trim()){this.App.MasterRecord.EditingDoc.RenumberAll();var h=this.App.MasterRecord.EditingDoc.TopNode,i=new a.NodeView(h,!0);i.SaveFlags(this.App.PictgramPanel.ViewMap),this.App.PictgramPanel.InitializeView(i),this.App.PictgramPanel.Draw(null),this.App.FullScreenEditorPanel.IsVisible=!0,this.App.SocketManager.UpdateWGSN(),this.App.MasterRecord.CloseEditor()}else this.App.MasterRecord.DiscardEditor();this.App.SocketManager.Emit("finishedit",b.Model.UID),$(this.Wrapper).animate({opacity:0},300).hide(0),$("#editor-background").animate({opacity:0},300).hide(0);var j=this.App.PictgramPanel;j.Activate()},c.prototype.OnKeyDown=function(a){this.Editor.focus(),27==a.keyCode&&(a.stopPropagation(),this.OnOutSideClicked())},c.prototype.DarkenBackGround=function(){return!0},c}(a.Panel);a.CodeMirrorEditorPanel=b;var c=function(a){function b(b){var c=document.getElementById("singlenode-editor"),d=document.getElementById("singlenode-editor-wrapper");a.call(this,b,!1,c,{lineNumbers:!1,mode:"wgsn",lineWrapping:!0},d,{position:"absolute"})}return __extends(b,a),b.prototype.DarkenBackGround=function(){return!1},b}(b);a.SingleNodeEditorPanel=c;var d=function(a){function b(b){var c=document.getElementById("editor"),d=document.getElementById("editor-wrapper");a.call(this,b,!0,c,{lineNumbers:!0,mode:"wgsn",lineWrapping:!0,extraKeys:{"Shift-Space":"autocomplete"}},d,{position:"fixed",top:"5%",left:"5%",width:"90%",height:"90%"})}return __extends(b,a),b}(b);a.WGSNEditorPanel=d}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(){function a(a){this.App=a}return a.prototype.GetCommandLineNames=function(){return[]},a.prototype.Invoke=function(){},a.prototype.GetHelpHTML=function(){return"<code>"+this.GetCommandLineNames().pop()+"</code>"},a.prototype.CanUseOnViewOnlyMode=function(){return!1},a}();a.Command=b;var c=function(a){function b(b){a.call(this,b)}return __extends(b,a),b.prototype.Invoke=function(a){if(null!=a){var b=a.toUpperCase();if(null==this.App.PictgramPanel.ViewMap)return void this.App.DebugP("Jump is diabled.");var c=this.App.PictgramPanel.ViewMap[b];return""==a&&null==c&&(b=this.App.PictgramPanel.GetFocusedLabel(),c=this.App.PictgramPanel.ViewMap[b]),null!=c?void($("#"+b.replace(/\./g,"\\.")).length>0?(this.App.PictgramPanel.Viewport.SetCameraPosition(c.GetCenterGX(),c.GetCenterGY()),this.App.PictgramPanel.ChangeFocusedLabel(b)):this.App.DebugP("Invisible node "+b+" Selected.")):void this.App.DebugP("undefined command: "+a)}},b}(b);a.CommandMissingCommand=c;var d=function(b){function c(a){b.call(this,a)}return __extends(c,b),c.prototype.GetCommandLineNames=function(){return["w","save"]},c.prototype.Invoke=function(b,c){var d=c.length>0?c[0]:this.App.WGSNName.replace(/(\.\w+)?$/,".wgsn"),e=d.split(".").pop(),f=this.App.FindCommandByCommandLineName("save-as-"+e);if(f)return void f.Invoke(b,c);var g=new a.StringWriter;this.App.MasterRecord.FormatRecord(g),a.AssureNoteUtils.SaveAs(g.toString(),d)},c.prototype.GetHelpHTML=function(){return"<code>save [name]</code><br>Save editing GSN."},c.prototype.CanUseOnViewOnlyMode=function(){return!0},c}(b);a.SaveCommand=d;var e=function(b){function c(a){b.call(this,a),this.App=a}return __extends(c,b),c.prototype.GetCommandLineNames=function(){return["save-as-wgsn","SaveAsWgsn"]},c.prototype.GetHelpHTML=function(){return"<code>"+this.GetCommandLineNames()[0]+" [name]</code><br>Save editing GSN as WGSN file."},c.prototype.Invoke=function(b,c){var d=c.length>0?c[0]:this.App.WGSNName.replace(/(\.\w+)?$/,".wgsn"),e=new a.StringWriter;this.App.MasterRecord.FormatRecord(e),a.AssureNoteUtils.SaveAs(e.toString(),d)},c.prototype.CanUseOnViewOnlyMode=function(){return!0},c}(b);a.SaveWGSNCommand=e;var f=function(b){function c(a){b.call(this,a),this.App=a}return __extends(c,b),c.prototype.GetCommandLineNames=function(){return["save-as-dcase_model","SaveAsDCaseModel"]},c.prototype.Invoke=function(b,c){var d=c.length>0?c[0]:this.App.WGSNName.replace(/(\.\w+)?$/,".dcase_model");a.AssureNoteUtils.SaveAs(this.ConvertToDCaseXML(this.App.MasterRecord.GetLatestDoc().TopNode),d)},c.prototype.GetHelpHTML=function(){return"<code>"+this.GetCommandLineNames()[0]+" [name]</code><br>Save editing GSN as dcase_model file."},c.prototype.ConvertToDCaseXML=function(a){function b(a){switch(a){case 0:return"Goal";case 2:return"Strategy";case 3:return"Evidence";case 1:return"Context";default:return""}}function c(e){var f=e.GetLabel(),i=e.UID.toString(),j=document.createElementNS(d,"rootBasicNode");if(j.setAttribute("xsi:type","dcase:"+b(e.NodeType)),j.setAttribute("id",i),j.setAttribute("name",f),j.setAttribute("desc",e.NodeDoc.replace(/^\s*(.*?)\s*$/,"$1").replace(/\r/g,"&#xD;").replace(/\n/g,"&#xA;")),g.appendChild(j),null!=e.ParentNode&&e!=a){var k=e.ParentNode.UID.toString(),l="LINK_"+k+"_"+i,m=document.createElementNS(d,"rootBasicLink");1==e.NodeType?m.setAttribute("xsi:type","dcase:InContextOf"):m.setAttribute("xsi:type","dcase:SupportedBy"),m.setAttribute("id",l),m.setAttribute("name",l),m.setAttribute("source","#"+k),m.setAttribute("target","#"+i),h.appendChild(m)}if(e.SubNodeList)for(var n=0;n<e.SubNodeList.length;n++)c(e.SubNodeList[n])}var d="http://www.dependable-os.net/2013/11/dcase_model/",e="http://www.w3.org/2001/XMLSchema-instance",f=document.createElementNS(d,"dcase:Argument");f.setAttribute("xmlns:dcase",d),f.setAttribute("xmlns:xsi",e),f.setAttribute("id","_6A0EENScEeKCdP-goLYu9g");var g=document.createDocumentFragment(),h=document.createDocumentFragment();c(a),f.appendChild(g),f.appendChild(h);var i=document.createElement("div");return i.appendChild(f),'<?xml version="1.0" encoding="UTF-8"?>\n'+i.innerHTML.replace(/>/g,">\n").replace(/&amp;#x/g,"&#x")},c.prototype.CanUseOnViewOnlyMode=function(){return!0},c}(b);a.SaveDCaseCommand=f;var g=function(b){function c(a){b.call(this,a)}return __extends(c,b),c.prototype.GetCommandLineNames=function(){return["saveassvg","save-as-svg"]},c.prototype.Invoke=function(b,c){var d=c.length>0?c[0]:this.App.WGSNName.replace(/(\.\w+)?$/,".svg");a.AssureNoteUtils.SaveAs(this.ConvertToSVG(this.App.PictgramPanel.TopNodeView),d)},c.prototype.GetHelpHTML=function(){return"<code>save-as-svg [name]</code><br>Save editing GSN as SVG file."},c.prototype.ConvertToSVG=function(b){var c="http://www.w3.org/2000/svg",d=$('<svg width="'+(b.Shape.GetTreeWidth()+20)+'px" height="'+(b.Shape.GetTreeHeight()+20)+'px" version="1.1" xmlns="'+c+'">');d.append($("svg defs").clone(!1)),this.App.PictgramPanel.ForceAppendAllOutOfScreenNode();var e=$(a.AssureNoteUtils.CreateSVGElement("g")).attr("transform","translate("+(10-b.Shape.GetTreeLeftLocalX())+" 10) scale(1)").appendTo(d);b.TraverseVisibleNode(function(c){function d(b){return $(a.AssureNoteUtils.CreateSVGElement("tspan")).text(b)}var f=c.Shape.ShapeGroup,g=c.Shape.ArrowPath,h=(window.getComputedStyle(f,null),window.getComputedStyle(c.Shape.Content,null)),i=window.getComputedStyle($(c.Shape.Content).find("h4")[0],null);e.append($(f).clone(!1).attr({fill:"none",stroke:"#000000"})),c!=b&&e.append($(g).clone(!1));var j=c.GetGX()+parseInt(h.paddingLeft),k=c.GetGY()+parseInt(h.paddingTop),l=parseInt(i.marginTop)+parseInt(i.fontSize),m=parseInt(i.marginBottom)+parseInt(i.lineHeight),n=parseInt(h.lineHeight),o=parseInt(h.fontSize),p=$(a.AssureNoteUtils.CreateSVGElement("text")).attr({x:j,y:k});d(c.Label).attr({x:j,dy:l,"font-size":i.fontSize,"font-weight":"bold","font-family":"Arial, Meiryo"}).appendTo(p);var q=1+~~(2*(c.Shape.GetNodeWidth()-2*parseInt(h.paddingLeft))/o),r=!0;a.AssureNoteUtils.ForeachLine(c.NodeDoc,q,function(a){d(a).attr({x:j,dy:r?m:n,"font-size":h.fontSize,"font-family":"Arial, Meiryo"}).appendTo(p),r=!1}),e.append(p)});var f=$("<div>").append(d),g='<?xml version="1.0" standalone="no"?>\n<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n',h=g+f.html();return d.empty().remove(),h},c.prototype.CanUseOnViewOnlyMode=function(){return!0},c}(b);a.SaveSVGCommand=g;var h=function(b){function c(a){b.call(this,a)}return __extends(c,b),c.prototype.GetCommandLineNames=function(){return["new"]},c.prototype.GetDisplayName=function(){return"New"},c.prototype.GetHelpHTML=function(){return"<code>new [name]</code><br>Create new file."},c.prototype.Invoke=function(b,c){var d=new a.GSNHistory(0,this.App.GetUserName(),"todo",null,"test",null),e=new a.StringWriter;a.TagUtils.FormatHistoryTag([d],0,e),console.log(e.toString());var f=e.toString()+"Revision:: 0\n*G";if(c.length>0)this.App.LoadNewWGSN(c[0],f);else{var g=prompt("Enter the file name");null!=g&&(""==g&&(g="default.wgsn"),this.App.LoadNewWGSN(g,f))}},c}(b);a.NewCommand=h;var i=function(a){function b(b){a.call(this,b)}return __extends(b,a),b.prototype.GetCommandLineNames=function(){return["unfoldAll","unfold-all"]},b.prototype.GetHelpHTML=function(){return"<code>unfold-all</code><br>Unfold all folded Goals"},b.prototype.Invoke=function(){var a=this.App.PictgramPanel.TopNodeView,b=function(a){a.SetIsFolded(!1),a.ForEachVisibleChildren(function(a){b(a)})};b(a),this.App.PictgramPanel.Draw()},b.prototype.CanUseOnViewOnlyMode=function(){return!0},b}(b);a.UnfoldAllCommand=i;var j=function(a){function b(b){a.call(this,b)}return __extends(b,a),b.prototype.GetCommandLineNames=function(){return["setcolor","set-color"]},b.prototype.GetHelpHTML=function(){return"<code>set-color label color</code><br>Change node color."},b.prototype.Invoke=function(a,b){if(b.length>1){var c=b[0],d=b[1];if(null==this.App.PictgramPanel.ViewMap)console.log("'set color' is disabled.");else{var e=this.App.PictgramPanel.ViewMap[c];null!=e&&$("#"+c+" h4").css("background-color",d)}}},b}(b);a.SetColorCommand=j;var k=function(a){function b(b){a.call(this,b)}return __extends(b,a),b.prototype.GetCommandLineNames=function(){return["setscale","set-scale"]},b.prototype.GetHelpHTML=function(){return"<code>set-scale scale</code><br>Change scale."
},b.prototype.Invoke=function(a,b){b.length>0&&this.App.PictgramPanel.Viewport.SetCameraScale(b[0]-0)},b.prototype.CanUseOnViewOnlyMode=function(){return!0},b}(b);a.SetScaleCommand=k;var l=function(a){function b(b){a.call(this,b)}return __extends(b,a),b.prototype.GetCommandLineNames=function(){return["commit"]},b.prototype.GetHelpHTML=function(){return"<code>commit</code><br>Commit."},b.prototype.Invoke=function(a,b){var c="Default message";b.length>=1&&(c=b.join(" ")),this.App.MasterRecord.Commit(c)},b}(b);a.CommitCommand=l;var m=function(a){function b(b){a.call(this,b)}return __extends(b,a),b.prototype.GetCommandLineNames=function(){return["e","open"]},b.prototype.GetHelpHTML=function(){return"<code>open</code><br>Open a file."},b.prototype.Invoke=function(){var a=this;$("#file-open-dialog").change(function(b){var c=b.target||b.srcElement;a.App.LoadFiles(c.files)}),$("#file-open-dialog").click()},b}(b);a.OpenCommand=m;var n=function(a){function b(b){a.call(this,b)}return __extends(b,a),b.prototype.GetCommandLineNames=function(){return["help","?"]},b.prototype.GetHelpHTML=function(){return"<code>help [name]</code><br>Show this message."},b.prototype.Invoke=function(){var a=jQuery.map(this.App.Commands,function(a){return a.GetHelpHTML()}).sort();$("#help-modal ul").empty().append("<li>"+a.join("</li><li>")+"</li>"),$("#help-modal .modal-body").css({"overflow-y":"scroll",height:.6*this.App.PictgramPanel.Viewport.GetPageHeight()}),$("#help-modal").modal()},b.prototype.CanUseOnViewOnlyMode=function(){return!0},b}(b);a.HelpCommand=n;var o=function(b){function c(a){b.call(this,a)}return __extends(c,b),c.prototype.GetCommandLineNames=function(){return["share"]},c.prototype.GetHelpHTML=function(){return"<code>share</code><br>Share editing GSN to the server(online version only)."},c.prototype.Invoke=function(){var b=this,c=new a.StringWriter;this.App.MasterRecord.FormatRecord(c),this.App.SetLoading(!0),a.AssureNoteUtils.postJsonRPC("upload",{content:c.toString()},function(a){window.location.href=Config.BASEPATH+"/file/"+a.fileId},function(){b.App.SetLoading(!1)})},c.prototype.CanUseOnViewOnlyMode=function(){return!0},c}(b);a.ShareCommand=o;var p=function(a){function b(b){a.call(this,b)}return __extends(b,a),b.prototype.GetCommandLineNames=function(){return["set-user","setuser"]},b.prototype.Invoke=function(a,b){var c=b[0];c&&""!=c||(c=prompt("Enter the new name for guest","")),c&&""!=c||(c="Guest"),this.App.SetUserName(c)},b.prototype.GetHelpHTML=function(){return"<code>set-user [name]</code><br>Rename guest user."},b.prototype.CanUseOnViewOnlyMode=function(){return!0},b}(b);a.SetGuestUserNameCommand=p}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.GetCommandLineNames=function(){return["edit"]},c.prototype.GetHelpHTML=function(){return"<code>edit [label]</code><br>Open editor."},c.prototype.Invoke=function(b,c){var d;d=c.length<1?this.App.MasterRecord.GetLatestDoc().TopNode.GetLabel():c[0].toUpperCase();var e=(document.createEvent("UIEvents"),this.App.PictgramPanel.ViewMap[d]);if(null!=e){if(2==e.GetNodeType())return void this.App.DebugP("Strategy "+d+" cannot open FullScreenEditor.");var f=new a.StringWriter;e.Model.FormatSubNode(1,f,!0),this.App.FullScreenEditorPanel.EnableEditor(f.toString().trim(),e,!0)}else this.App.DebugP(d+" not found.")},c}(a.Command);a.FullScreenEditorCommand=b;var c=function(c){function d(a){c.call(this),this.AssureNoteApp=a,this.SetHasMenuBarButton(!0),this.SetHasEditor(!0),this.AssureNoteApp.RegistCommand(new b(this.AssureNoteApp))}return __extends(d,c),d.prototype.CreateMenuBarButton=function(b){var c=this;return 2==b.GetNodeType()?null:new a.NodeMenuItem("fullscreeneditor-id","/images/editor.png","fullscreeneditor",function(a,b){var d=c.AssureNoteApp.FindCommandByCommandLineName("edit");d&&d.Invoke(null,[b.Label])})},d.prototype.MoveBackgroundNode=function(b){for(var c=null,d=b.getCursor().line;d>=0;){var e=b.getLine(d);if(0==e.indexOf("*")){c=a.WikiSyntax.ParseUID(e);break}d-=1}if(null!=c){var f=Object.keys(this.AssureNoteApp.PictgramPanel.ViewMap);for(var g in f){var h=this.AssureNoteApp.PictgramPanel.ViewMap[f[g]];h&&h.Model&&a.Lib.DecToHex(h.Model.UID)==c&&(console.log(h.GetCenterGX()+" "+h.GetCenterGY()),this.AssureNoteApp.PictgramPanel.Viewport.SetCameraPosition(h.GetCenterGX(),h.GetCenterGY()))}}},d}(a.Plugin);a.FullScreenEditorPlugin=c}(AssureNote||(AssureNote={})),AssureNote.OnLoadPlugin(function(a){a.PluginManager.SetPlugin("open",new AssureNote.FullScreenEditorPlugin(a))});var AssureNote;!function(a){var b=function(b){function c(a){b.call(this,a)}return __extends(c,b),c.prototype.GetCommandLineNames=function(){return["singleedit"]},c.prototype.GetHelpHTML=function(){return"<code>singleedit [label]</code><br>Open single node editor."},c.prototype.Invoke=function(b,c){var d;d=c.length<1?this.App.MasterRecord.GetLatestDoc().TopNode.GetLabel():c[0].toUpperCase();var e=(document.createEvent("UIEvents"),this.App.PictgramPanel.ViewMap[d]);if(null!=e){var f=new a.StringWriter;e.Model.FormatSubNode(1,f,!1);var g=e.GetGY(),h=e.GetGX(),i=e.GetShape().GetNodeWidth(),j=Math.max(50,e.GetShape().GetNodeHeight()),k=Number($(e.Shape.ShapeGroup).css("stroke-width").charAt(0)),l={position:"fixed",top:g-k/2+"px",left:h-k/2+"px",width:i+k+"px",height:j+k+"px",background:"rgba(255, 255, 255, 1.00)"},m=this.App.PictgramPanel.Viewport.GetCameraScale();l.mozTransform=l.msTransform=l.webkitTransform=l.transform=1>m?"scale("+1/m+")":"",this.App.SingleNodeEditorPanel.UpdateCSS(l),this.App.SingleNodeEditorPanel.EnableEditor(f.toString().trim(),e,!1)}else this.App.DebugP(d+" not found.")},c}(a.Command);a.SingleNodeEditorCommand=b;var c=function(c){function d(a){c.call(this),this.App=a,this.SetHasMenuBarButton(!0),this.SetHasEditor(!0),this.SetHasDoubleClicked(!0),this.App.RegistCommand(new b(this.App))}return __extends(d,c),d.prototype.CreateMenuBarButton=function(){var b=this;return new a.NodeMenuItem("singlenodeeditor-id","/images/pencil.png","editor",function(a,c){var d=b.App.FindCommandByCommandLineName("SingleEdit");d&&d.Invoke(null,[c.Label])})},d.prototype.OnNodeDoubleClicked=function(b){if(0==a.AssureNoteApp.Current.ModeManager.GetMode()){var c=this.App.FindCommandByCommandLineName("SingleEdit");c&&c.Invoke(null,[b.Label])}},d}(a.Plugin);a.SingleNodeEditorPlugin=c}(AssureNote||(AssureNote={})),AssureNote.OnLoadPlugin(function(a){a.PluginManager.SetPlugin("open-single",new AssureNote.SingleNodeEditorPlugin(a))});var AssureNote;!function(a){var b=function(){function b(){}return b.prototype.Parse=function(a){var b=a.split(/\s+/);if(b.length>0){if(null==b[0][0])return void(this.Method="");if(this.RawString=a,null!=b[0][0].match(/\//))return this.Method="search",this.Args=[],void this.Args.push(a.slice(1));null!=b[0][0].match(/:/)?(this.Method=b[0].slice(1),b.length>1&&(this.Args=b.slice(1))):null!=b[0][0].match(/@/)&&(this.Method="message",this.Args=[],this.Args.push(a.slice(1)))}},b.prototype.GetRawString=function(){return this.RawString},b.prototype.GetMethod=function(){return a.AssureNoteApp.Assert(null!=this.Method),this.Method},b.prototype.GetArgs=function(){return null==this.Args&&(this.Args=[]),this.Args},b.prototype.GetArg=function(a){return this.Args[a]},b}();a.CommandParser=b;var c=function(a){function c(b){a.call(this,b),this.App=b,this.Element=$("#command-line"),this.IsEnable=!0,this.IsVisible=!1,this.HistoryList=[],this.HistoryIndex=0}return __extends(c,a),c.prototype.Enable=function(){this.IsEnable=!0},c.prototype.Disable=function(){this.IsEnable=!1,this.Hide()},c.prototype.Clear=function(){this.Element.val("")},c.prototype.Show=function(){this.Element.css("display","block"),this.Element.focus(),this.HistoryIndex=0,this.IsVisible=!0},c.prototype.Hide=function(){this.Element.css("display","none"),this.IsVisible=!1},c.prototype.GetValue=function(){return this.Element.val()},c.prototype.AddHistory=function(a){this.HistoryList.splice(0,0,a)},c.prototype.SaveHistory=function(){localStorage.setItem("commandline:history",JSON.stringify(this.HistoryList))},c.prototype.LoadHistory=function(){var a=localStorage.getItem("commandline:history");null!=a&&(this.HistoryList=JSON.parse(a))},c.prototype.OnActivate=function(){this.Show()},c.prototype.OnDeactivate=function(){this.Hide(),this.Clear()},c.prototype.ShowNextHistory=function(){this.HistoryIndex>0?(this.HistoryIndex-=1,this.Element.val(this.HistoryList[this.HistoryIndex])):0==this.HistoryIndex&&this.Element.val(":")},c.prototype.ShowPrevHistory=function(){this.HistoryIndex<this.HistoryList.length&&(this.Element.val(this.HistoryList[this.HistoryIndex]),this.HistoryIndex+=1)},c.prototype.IsEmpty=function(){return""==this.Element.val()},c.prototype.OnKeyDown=function(a){var c=!0;switch(a.keyCode){case 27:this.App.PictgramPanel.Activate(),a.preventDefault();break;case 38:this.ShowPrevHistory();break;case 40:this.ShowNextHistory();break;case 8:if(this.IsEmpty()){this.App.PictgramPanel.Activate(),a.preventDefault();break}break;case 13:a.preventDefault();var d=new b;d.Parse(this.GetValue()),"search"==d.GetMethod()&&this.App.PictgramPanel.Search.Search(this.App.PictgramPanel.TopNodeView,d.GetArgs()[0]),this.App.ExecCommand(d),this.AddHistory(d.GetRawString()),this.IsActive()&&this.App.PictgramPanel.Activate();break;default:c=!1}c&&a.stopPropagation()},c}(a.Panel);a.CommandLine=c}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(b){function c(c){var d=this;b.call(this,c),this.App=c,this.OnScreenNodeMap={},this.HiddenNodeMap={},this.FoldingAnimationTask=new a.AnimationFrameTask,this.SVGLayerBox=document.getElementById("svglayer-box"),this.SVGLayer=a.AssureNoteUtils.CreateSVGElement("g"),this.SVGLayerConnectorGroup=a.AssureNoteUtils.CreateSVGElement("g"),this.SVGLayerNodeGroup=a.AssureNoteUtils.CreateSVGElement("g"),this.SVGLayer.appendChild(this.SVGLayerConnectorGroup),this.SVGLayer.appendChild(this.SVGLayerNodeGroup),this.SVGLayer.id="svg-layer",this.SVGLayer.setAttribute("transform","translate(0,0)"),this.SVGLayerBox.appendChild(this.SVGLayer),this.HiddenNodeBuffer=document.createDocumentFragment(),this.EventMapLayer=document.getElementById("eventmap-layer"),this.ContentLayer=document.getElementById("content-layer"),this.ControlLayer=document.getElementById("control-layer"),this.Viewport=new a.ViewportManager(this.SVGLayer,this.EventMapLayer,this.ContentLayer,this.ControlLayer),this.LayoutEngine=new a.SimpleLayoutEngine(this.App),this.Viewport.AddEventListener("cameramove",function(){d.UpdateHiddenNodeList()}),this.ContextMenu=new a.NodeMenu(c),this.NodeTooltip=new a.Tooltip(c),this.ContentLayer.addEventListener("click",function(b){var c=a.AssureNoteUtils.GetNodeLabelFromEvent(b);d.App.DebugP("click:"+c),d.IsActive()?d.ChangeFocusedLabel(c):d.App.SocketManager.Emit("focusednode",c),d.ContextMenu.IsEnable&&d.ContextMenu.Remove(),d.NodeTooltip.IsEnable&&d.NodeTooltip.Remove(),b.stopPropagation(),b.preventDefault()}),this.EventMapLayer.addEventListener("pointerdown",function(){d.IsActive()&&d.ChangeFocusedLabel(null)}),this.ContentLayer.addEventListener("contextmenu",function(b){var c=a.AssureNoteUtils.GetNodeLabelFromEvent(b),e=d.ViewMap[c];if(null!=e)switch(d.ChangeFocusedLabel(c),e.Status){case 0:var f=d.App.PluginManager.GetMenuBarButtons(e);d.ContextMenu.Create(d.ViewMap[c],d.ControlLayer,f);break;case 1:var f=d.App.PluginManager.GetMenuBarButtons(e);d.ContextMenu.Create(d.ViewMap[c],d.ControlLayer,f);break;case 2:$.notify("Warning: currently edited","warn")}else d.FocusedLabel=null;b.preventDefault()}),this.ContentLayer.addEventListener("dblclick",function(b){var c=a.AssureNoteUtils.GetNodeLabelFromEvent(b),e=d.ViewMap[c];d.App.DebugP("double click:"+c),d.ContextMenu.IsEnable&&d.ContextMenu.Remove(),d.NodeTooltip.IsEnable&&d.NodeTooltip.Remove(),d.App.ExecDoubleClicked(e),b.stopPropagation(),b.preventDefault()}),this.CmdLine=new a.CommandLine(c),this.Search=new a.SearchResultNodeList(this);var e=null;this.ContentLayer.addEventListener("mouseover",function(b){if(!d.App.FullScreenEditorPanel.IsActive()){var c=a.AssureNoteUtils.GetNodeLabelFromEvent(b),f=d.ViewMap[c];if(null!=f&&e!=c){e=c;var g=d.App.PluginManager.GetTooltipContents(f);d.NodeTooltip.Create(f,d.ControlLayer,g)}}}),this.ContentLayer.addEventListener("mouseleave",function(){d.NodeTooltip.IsEnable&&(d.NodeTooltip.Remove(),e=null)});var f=function(a){a.stopPropagation(),a.preventDefault(),event.dataTransfer.dropEffect=d.IsActive()?"move":"none"};document.addEventListener("dragenter",f,!0),document.addEventListener("dragover",f,!0),document.addEventListener("dragleave",f,!0),document.addEventListener("drop",function(a){a.stopPropagation(),a.preventDefault(),d.IsActive()&&d.App.LoadFiles(a.dataTransfer.files)},!0),this.Viewport.ScrollManager.OnDragged=function(b){if(d.TopNodeView){var c=new a.Point(b.GXFromPageX(b.GetPageCenterX()),b.GYFromPageY(b.GetPageHeight()/3));d.TopNodeView.TraverseVisibleNode(function(a){if(a.IsFolded()){var b=c.X-a.GetCenterGX(),e=c.Y-a.GetCenterGY(),f=150/d.Viewport.GetCameraScale();if(f*f>b*b+e*e)return d.App.ExecCommandByName("fold",a.Label),!1}})}},this.Viewport.ScrollManager.OnStartDrag=function(){$("#auto-expand-area").stop(!0,!0).show(100),$(".dropdown.open > .dropdown-toggle").dropdown("toggle")},this.Viewport.ScrollManager.OnEndDrag=function(){$("#auto-expand-area").stop(!0,!0).hide(100)}}return __extends(c,b),c.prototype.OnKeyDown=function(a){var b=!0;switch(a.keyCode){case 58:case 186:case 191:case 219:this.Search.IsVisiting()&&this.Search.FinishVisit(),this.CmdLine.Activate();break;case 27:this.Search.IsVisiting()&&(this.Search.FinishVisit(),a.preventDefault()),this.App.HistoryPanel&&this.App.HistoryPanel.Hide();break;case 13:this.Search.IsVisiting()?(this.Search.VisitNext(event.shiftKey),a.preventDefault()):(this.FocusedLabel&&this.App.ExecCommandByName(a.shiftKey?"edit":"singleedit",this.FocusedLabel),a.preventDefault());break;case 72:case 37:this.NavigateLeft(),a.preventDefault();break;case 74:case 40:this.NavigateDown(),a.preventDefault();break;case 75:case 38:this.NavigateUp(),a.preventDefault();break;case 76:case 39:this.NavigateRight(),a.preventDefault();break;case 36:this.NavigateHome(),a.preventDefault();break;case 32:case 70:this.FocusedLabel&&this.App.ExecCommandByName("fold",this.FocusedLabel),a.preventDefault();break;case 65:case 73:this.FocusedLabel&&this.App.ExecCommandByName(a.shiftKey?"edit":"singleedit",this.FocusedLabel),a.preventDefault();break;case 187:a.shiftKey&&this.App.ExecCommandByName("set-scale",this.Viewport.GetCameraScale()+.1),a.preventDefault();break;case 189:a.shiftKey&&this.App.ExecCommandByName("set-scale",this.Viewport.GetCameraScale()-.1),a.preventDefault();break;default:b=!1}b&&a.stopPropagation()},c.prototype.OnActivate=function(){this.Viewport.IsPointerEnabled=!0},c.prototype.OnDeactivate=function(){this.Viewport.IsPointerEnabled=!1},c.prototype.MoveToNearestNode=function(a){var b=this.FocusedLabel?this.FindNearestNode(this.ViewMap[this.FocusedLabel],a):this.TopNodeView;this.FocusAndMoveToNode(b)},c.prototype.FocusAndMoveToNode=function(a){if(null!=a){var b=a.constructor==String?this.ViewMap[a]:a;null!=b&&(this.ChangeFocusedLabel(b.Label),this.Viewport.MoveTo(b.GetCenterGX(),b.GetCenterGY(),this.Viewport.GetCameraScale(),50))}},c.prototype.FindNearestNode=function(a,b){if(!a)return null;var c=1,d=1,e=1,f=1;switch(b){case 2:f=-1;break;case 0:c=-1,d=-1,e=-1;break;case 1:d=-1,e=-1,f=-1;break;case 3:c=-1}var g=null,h=1/0;return this.TopNodeView.TraverseVisibleNode(function(b){var i=b.GetCenterGX()-a.GetCenterGX(),j=b.GetCenterGY()-a.GetCenterGY(),k=i*c+j*d,l=i*e+j*f;if(k>0&&l>0){var m=i*i+j*j;h>m&&(h=m,g=b)}}),g},c.prototype.FoldDeepSubGoals=function(a){var b=this;a.ForEachVisibleChildren(function(a){b.FoldDeepSubGoals(a),0==a.GetNodeType()&&null!=a.Children&&(1!=a.Children.length||3!=a.Children[0].GetNodeType())&&a.SetIsFolded(!0)})},c.prototype.ChangeFocusedLabel=function(b){if(this.App.SocketManager.Emit("focusednode",b),a.AssureNoteUtils.UpdateHash(b),this.ContextMenu.IsEnable&&this.ContextMenu.Remove(),this.NodeTooltip.IsEnable&&this.NodeTooltip.Remove(),null==b){var c=this.ViewMap[this.FocusedLabel];return null!=c&&c.RemoveColorStyle(a.ColorStyle.Highlight),void(this.FocusedLabel=null)}var d=this.ViewMap[b];if(null!=d){var c=this.ViewMap[this.FocusedLabel];null!=c&&c.RemoveColorStyle(a.ColorStyle.Highlight),this.FocusedLabel=b,d.AddColorStyle(a.ColorStyle.Highlight)}},c.prototype.GetFocusedLabel=function(){return this.FocusedLabel},c.prototype.HasMonitorNode=function(){for(var a in this.ViewMap){var b=this.ViewMap[a];if(b.IsMonitorNode())return!0}return!1},c.prototype.InitializeView=function(a){this.TopNodeView=a,this.ViewMap={},this.TopNodeView.UpdateViewMap(this.ViewMap),this.HasMonitorNode()?this.App.TopMenu.SubMenuMap.monitor.Enable():this.App.TopMenu.SubMenuMap.monitor.Disable()},c.prototype.Draw=function(b,c,d){var e=this,f=a.AssureNoteUtils.GetTime();this.Clear();var g=a.AssureNoteUtils.GetTime();console.log("Clear: "+(g-f));var h=this.ViewMap[b];null==h&&(h=this.TopNodeView);var i,j,k,l;d&&(i=d.GetGX(),j=d.GetGY()),this.LayoutEngine.DoLayout(this,h),this.ContentLayer.style.display="none",this.SVGLayer.style.display="none",a.GSNShape.__Debug_Animation_SkippedNodeCount=0,a.GSNShape.__Debug_Animation_TotalNodeCount=0,this.FoldingAnimationTask.Cancel(!0),a.NodeView.SetGlobalPositionCacheEnabled(!0);var m=[],n=this.Viewport.GetPageRectInGxGy();if(d){k=d.GetGX()-i,l=d.GetGY()-j,k>0?n.Width+=k:(n.Width-=k,n.X+=k);var o=this.Viewport.GetCameraScale(),p=this.Viewport.CreateMoveTaskFunction(k,l,o,c);m.push(p?p:function(){e.UpdateHiddenNodeList()})}else m.push(function(){e.UpdateHiddenNodeList()});var q=a.AssureNoteUtils.GetTime();h.UpdateNodePosition(m,c,n),h.ClearAnimationCache();var r=a.AssureNoteUtils.GetTime();console.log("Update: "+(r-q)),this.FoldingAnimationTask.StartMany(c,m);var s=h.GetShape();this.Viewport.CameraLimitRect=new a.Rect(s.GetTreeLeftLocalX()-100,-100,s.GetTreeWidth()+200,s.GetTreeHeight()+200);var t=this.Viewport.GetPageRectInGxGy();this.TopNodeView.TraverseVisibleNode(function(a){a.IsInRect(t)?e.OnScreenNodeMap[a.Label]=a:(e.HiddenNodeMap[a.Label]=a,e.HiddenNodeBuffer.appendChild(a.Shape.Content),e.HiddenNodeBuffer.appendChild(a.Shape.ShapeGroup))}),a.NodeView.SetGlobalPositionCacheEnabled(!1),this.ContentLayer.style.display="",this.SVGLayer.style.display="",console.log("Animation: "+a.GSNShape.__Debug_Animation_TotalNodeCount+" nodes moved, "+a.GSNShape.__Debug_Animation_SkippedNodeCount+" nodes skipped. reduce rate = "+a.GSNShape.__Debug_Animation_SkippedNodeCount/a.GSNShape.__Debug_Animation_TotalNodeCount)},c.prototype.ForceAppendAllOutOfScreenNode=function(){var a=this,b=function(b){if(b.Parent){var c=b.Shape.ArrowPath;c.parentNode!=a.HiddenNodeBuffer&&a.HiddenNodeBuffer.appendChild(c)}};for(var c in this.HiddenNodeMap){var d=this.HiddenNodeMap[c];delete this.HiddenNodeMap[c],this.OnScreenNodeMap[c]=d,this.ContentLayer.appendChild(d.Shape.Content),this.SVGLayerNodeGroup.appendChild(d.Shape.ShapeGroup),b(d)}},c.prototype.UpdateHiddenNodeList=function(){var b=this;a.NodeView.SetGlobalPositionCacheEnabled(!0);var c=this.Viewport.GetPageRectInGxGy(),d=function(a){if(a.Parent){var d=a.Shape.ArrowPath;a.IsConnectorInRect(c)?d.parentNode!=b.SVGLayerConnectorGroup&&b.SVGLayerConnectorGroup.appendChild(d):d.parentNode!=b.HiddenNodeBuffer&&b.HiddenNodeBuffer.appendChild(d)}};for(var e in this.OnScreenNodeMap){var f=this.OnScreenNodeMap[e];f.IsInRect(c)||(delete this.OnScreenNodeMap[e],this.HiddenNodeMap[e]=f,this.HiddenNodeBuffer.appendChild(f.Shape.Content),this.HiddenNodeBuffer.appendChild(f.Shape.ShapeGroup)),d(f)}for(var e in this.HiddenNodeMap){var f=this.HiddenNodeMap[e];f.IsInRect(c)&&(delete this.HiddenNodeMap[e],this.OnScreenNodeMap[e]=f,this.ContentLayer.appendChild(f.Shape.Content),this.SVGLayerNodeGroup.appendChild(f.Shape.ShapeGroup)),d(f)}a.NodeView.SetGlobalPositionCacheEnabled(!1)},c.prototype.Clear=function(){document.getElementById("assure-note").style.display="none",this.ContentLayer.innerHTML="",this.SVGLayer.removeChild(this.SVGLayerConnectorGroup),this.SVGLayer.removeChild(this.SVGLayerNodeGroup),this.SVGLayerConnectorGroup=a.AssureNoteUtils.CreateSVGElement("g"),this.SVGLayerNodeGroup=a.AssureNoteUtils.CreateSVGElement("g"),this.SVGLayer.appendChild(this.SVGLayerConnectorGroup),this.SVGLayer.appendChild(this.SVGLayerNodeGroup),this.Viewport.SVGLayer=this.SVGLayer,this.HiddenNodeMap={},this.OnScreenNodeMap={},this.HiddenNodeBuffer=document.createDocumentFragment(),document.getElementById("assure-note").style.display=""},c.prototype.DisplayPluginPanel=function(a,b){var c=this.App.PluginManager.GetPanelPlugin(a,b);c.Display(this.App.FullScreenEditorPanel,this.App.MasterRecord.GetLatestDoc(),b)},c.prototype.GetFocusedView=function(){return this.ViewMap?this.ViewMap[this.FocusedLabel]:null},c.prototype.GetNodeViewFromUID=function(a){for(var b in this.ViewMap)if(this.ViewMap[b].Model.UID==a)return this.ViewMap[b];return null},c.prototype.NavigateUp=function(){this.MoveToNearestNode(1)},c.prototype.NavigateDown=function(){this.MoveToNearestNode(3)},c.prototype.NavigateLeft=function(){this.MoveToNearestNode(0)},c.prototype.NavigateRight=function(){this.MoveToNearestNode(2)},c.prototype.NavigateHome=function(){this.FocusAndMoveToNode(this.TopNodeView)},c}(a.Panel);a.PictgramPanel=b}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(){function a(a,b){this.name=a,this.WGSN=b}return a}();a.WGSNSocket=b;var c=function(){function a(a,b,c,d){this.UserName=a,this.UID=b,this.IsRecursive=c,this.SID=d}return a}();a.EditNodeStatus=c;var d=function(){function a(a,b){this.SID=a,this.Label=b}return a}();a.FocusedLabels=d;var e=function(){function c(a){var b=this;this.App=a,this.DefaultChatServer=Config&&Config.DefaultChatServer?Config.DefaultChatServer:"http://localhost:3002",this.UseOnScrollEvent=!0,this.ReceivedFoldEvent=!1,this.EditNodeInfo=[],this.FocusedLabels=[],this.IsOperational()||a.DebugP("socket.io not found"),a.PictgramPanel.Viewport.AddEventListener("cameramove",function(a){var c=a.Target;if(b.IsConnected()&&b.UseOnScrollEvent&&1!=b.App.ModeManager.GetMode()){console.log("StartEmit");var d=c.GetCameraGX(),e=c.GetCameraGY(),f=c.GetCameraScale();b.Emit("sync",{X:d,Y:e,Scale:f})}}),this.socket=null,this.handler={}}return c.prototype.RegisterSocketHandler=function(a,b){this.handler[a]=b},c.prototype.Emit=function(a,b){return this.IsConnected()?void this.socket.emit(a,b):void this.App.DebugP("Socket not enable.")},c.prototype.EnableListeners=function(){var a=this;this.socket.on("disconnect",function(){a.App.ModeManager.Disable(),a.socket=null}),this.socket.on("close",function(b){a.UpdateView(""),a.UpdateWGSN(),console.log("close: "+b),a.App.UserList.RemoveUser(b)}),this.socket.on("error",function(){$.notify("Cannot establish connection or connection closed","error"),a.App.ModeManager.Disable()}),this.socket.on("init",function(b){null!=b.WGSN&&a.App.MasterRecord.HistoryList.length>1&&alert("Your changes will disappear. TODO: Make a choice."),null!=b.WGSN&&a.App.LoadNewWGSN(b.name,b.WGSN)}),this.socket.on("adduser",function(b){a.App.UserList.AddUser(b)}),this.socket.on("focusednode",function(b){var c,d;if(null==b.Label||0!=a.FocusedLabels.length)for(var e in a.FocusedLabels)if(a.FocusedLabels[e].SID==b.SID){d=a.FocusedLabels[e].Label,c=a.App.PictgramPanel.ViewMap[d],a.FocusedLabels.splice(e,1),a.App.UserList.RemoveFocusedUserColor(b.SID,c);break}if(null!=b.Label){var f=a.App.PictgramPanel.ViewMap[b.Label];a.App.UserList.AddFocusedUserColor(b.SID,f),a.FocusedLabels.push(b)}}),this.socket.on("updateeditmode",function(b){a.App.UserList.UpdateEditMode(b)}),this.socket.on("fold",function(b){if(!a.ReceivedFoldEvent){a.ReceivedFoldEvent=!0;var c=a.App.PictgramPanel.GetNodeViewFromUID(b.UID);a.App.ExecDoubleClicked(c),a.ReceivedFoldEvent=!1}}),this.socket.on("update",function(b){a.App.LoadNewWGSN(b.name,b.WGSN)}),this.socket.on("sync",function(b){a.UseOnScrollEvent=!1,a.App.PictgramPanel.Viewport.SetCamera(b.X,b.Y,b.Scale),a.UseOnScrollEvent=!0}),this.socket.on("startedit",function(b){console.log("edit");var c=a.App.PictgramPanel.GetNodeViewFromUID(b.UID);a.EditNodeInfo.push(b),a.UpdateFlags(c),a.UpdateView("startedit"),a.AddUserNameOn(c,{User:b.UserName,IsRecursive:b.IsRecursive})}),this.socket.on("finishedit",function(b){console.log("finishedit");var c;if(a.DeleteEditInfo(b),0!=(c=a.EditNodeInfo.length)){var d=a.App.PictgramPanel.GetNodeViewFromUID(a.EditNodeInfo[c-1].UID);a.UpdateFlags(d),a.UpdateView("anotheredit"),a.AddUserNameOn(d,{User:a.EditNodeInfo[c-1].UserName,IsRecursive:a.EditNodeInfo[c-1].IsRecursive})}else a.UpdateView("finishedit");console.log("here is ID array after delete = "+a.EditNodeInfo)});for(var b in this.handler)this.socket.on(b,this.handler[b])},c.prototype.Connect=function(a,b){this.IsConnected()||(this.socket=io.connect(null==b||""==b?this.DefaultChatServer:b),this.App.ModeManager.Enable(),this.EnableListeners(),this.App.UserList.Show(),this.Emit("adduser",{User:this.App.GetUserName(),Mode:this.App.ModeManager.GetMode(),Room:a}))},c.prototype.DisConnect=function(){this.socket.disconnect(),this.socket=null},c.prototype.IsConnected=function(){return null!=this.socket},c.prototype.IsOperational=function(){return null!=io&&null!=io.connect},c.prototype.DeleteEditInfo=function(a){for(var b=0;b<this.EditNodeInfo.length;b++)if(this.EditNodeInfo[b].UID==a)return void this.EditNodeInfo.splice(b,1)},c.prototype.UpdateParentStatus=function(a){null!=a.Parent&&(a.Parent.Status=1,this.UpdateParentStatus(a.Parent))},c.prototype.UpdateChildStatus=function(a){if(null!=a.Children)for(var b=0;b<a.Children.length;b++)a.Children[b].Status=2,this.UpdateChildStatus(a.Children[b]);if(null!=a.Left)for(var b=0;b<a.Left.length;b++)a.Left[b].Status=2,this.UpdateChildStatus(a.Left[b]);if(null!=a.Right)for(var b=0;b<a.Right.length;b++)a.Right[b].Status=2,this.UpdateChildStatus(a.Right[b])},c.prototype.UpdateFlags=function(a){a.Status=2,this.UpdateParentStatus(a),(null!=a.Children||null!=a.Left||null!=a.Right)&&this.EditNodeInfo[this.EditNodeInfo.length-1].IsRecursive&&this.UpdateChildStatus(a)},c.prototype.UpdateView=function(b){var c=new a.NodeView(this.App.MasterRecord.GetLatestDoc().TopNode,!0);c.SaveFlags(this.App.PictgramPanel.ViewMap),"finishedit"==b&&this.SetDefaultFlags(c),this.App.PictgramPanel.InitializeView(c),this.App.PictgramPanel.Draw(this.App.MasterRecord.GetLatestDoc().TopNode.GetLabel())},c.prototype.SetDefaultFlags=function(a){if(a.Status=0,null!=a.Children)for(var b=0;b<a.Children.length;b++)this.SetDefaultFlags(a.Children[b]);if(null!=a.Left)for(var b=0;b<a.Left.length;b++)this.SetDefaultFlags(a.Left[b]);if(null!=a.Right)for(var b=0;b<a.Right.length;b++)this.SetDefaultFlags(a.Right[b])},c.prototype.IsEditable=function(a){var b=this.App.PictgramPanel.GetNodeViewFromUID(a).Parent;if(0==this.EditNodeInfo.length)return!0;for(var c=0;c<this.EditNodeInfo.length;c++)if(this.EditNodeInfo[c].UID==a)return!1;for(;null!=b;){for(var c=0;c<this.EditNodeInfo.length;c++)if(this.EditNodeInfo[c].IsRecursive&&this.EditNodeInfo[c].UID==b.Model.UID)return!1;b=b.Parent}return!0},c.prototype.AddUserNameOn=function(a,b){var c,d,e=a.Label.replace(/\./g,"\\.");switch(a.Model.NodeType){case 0:case 1:c="5px",d="5px";break;case 2:c="5px",d="10px";break;case 3:c="19px",d="40px"}if($('<div class="user_'+b.User+'">'+b.User+"</div>").appendTo($("#"+e)).css({position:"absolute",top:c,right:d,"font-size":"12px","text-decoration":"underline"}),null!=a.Right&&b.IsRecursive&&this.AddUserNameOn(a.Right[0],b),null!=a.Children&&b.IsRecursive)for(var f=0;f<a.Children.length;f++)this.AddUserNameOn(a.Children[f],b)},c.prototype.StartEdit=function(a){this.IsConnected()&&this.Emit("startedit",a)},c.prototype.FoldNode=function(a){this.IsConnected()&&!this.ReceivedFoldEvent&&this.Emit("fold",a)},c.prototype.SyncScreenPos=function(a){this.Emit("syncfocus",a)},c.prototype.UpdateWGSN=function(){var c=new a.StringWriter;this.App.MasterRecord.FormatRecord(c);var d=c.toString();this.Emit("update",new b(this.App.WGSNName,d))},c.prototype.UpdateEditMode=function(a){this.Emit("updateeditmode",{User:this.App.GetUserName(),Mode:a})},c}();a.SocketManager=e}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(){function b(a,b){this.IsEnabled=a,this.ButtonId=null,this.ElementId=null,b&&(this.ButtonId=b,this.ElementId=b+"-menu-button")}return b.prototype.GetIconName=function(){return""},b.prototype.GetDisplayName=function(){return""},b.prototype.Enable=function(){this.IsEnabled=!0,this.ElementId&&$("#"+this.ElementId).removeClass("disabled")},b.prototype.Disable=function(){this.IsEnabled=!1,this.ElementId&&$("#"+this.ElementId).addClass("disabled")},b.CreateIconElement=function(a){var b=document.createElement("span");return b.className="glyphicon glyphicon-"+a,b},b.CreateID=function(){return"topmenu-"+a.AssureNoteUtils.GenerateRandomString()},b.prototype.Render=function(a,c,d){var e,f=this,g=b.CreateIconElement(this.GetIconName()),h="",i=document.createTextNode(h+this.GetDisplayName());if(d){e=document.createElement("button"),e.type="button",this.ElementId&&e.setAttribute("id",this.ElementId),e.setAttribute("oncontextmenu","return false");var j="btn navbar-btn btn-default clickable navbar-left";this.IsEnabled||(j+=" disabled"),e.className=j,e.appendChild(g),e.appendChild(i)}else{e=document.createElement("li");var k=document.createElement("a");k.href="#",k.appendChild(g),k.appendChild(i),e.appendChild(k)}e.addEventListener("click",function(){f.Invoke(a)}),c.appendChild(e)},b.prototype.Invoke=function(){},b}();a.TopMenuItem=b;var c=function(a){function c(b,c,d,e,f){a.call(this,b,c),this.DisplayName=d,this.IconName=e,this.SubMenuList=f}return __extends(c,a),c.prototype.GetIconName=function(){return this.IconName},c.prototype.GetDisplayName=function(){return this.DisplayName},c.prototype.Render=function(a,c,d){var e=b.CreateIconElement(this.GetIconName()),f=document.createTextNode(""+this.GetDisplayName()+"");if(d){var g=document.createElement("div");g.className="dropdown clickable navbar-left";var h=document.createElement("button");h.type="button",h.setAttribute("id",this.ElementId),h.setAttribute("oncontextmenu","return false"),h.setAttribute("data-toggle","dropdown");var i="btn navbar-btn btn-default dropdown-toggle";this.IsEnabled||(i+=" disabled"),h.className=i;var j=document.createElement("span");j.className="caret",h.appendChild(e),h.appendChild(f),h.appendChild(j);var k=document.createElement("ul");k.setAttribute("oncontextmenu","return false"),k.className="dropdown-menu",k.style.right="auto",k.style.width="250px";for(var l=0;l<this.SubMenuList.length;l++)this.SubMenuList[l].Render(a,k,!1);g.appendChild(h),g.appendChild(k),c.appendChild(g)}else{var m=document.createElement("li");m.className="dropdown-submenu";var n=document.createElement("a");n.href="#",m.appendChild(n),n.appendChild(e),n.appendChild(f);var k=document.createElement("ul");k.setAttribute("oncontextmenu","return false"),k.className="dropdown-menu";for(var l=0;l<this.SubMenuList.length;l++)this.SubMenuList[l].Render(a,k,!1);m.appendChild(k),c.appendChild(m)}},c}(b);a.SubMenuItem=c;var d=function(a){function b(b){a.call(this,!0),this.SubMenuList=b,this.SubMenuMap={};for(var c;c<b.length;c++)b[c].ButtonId&&(this.SubMenuMap[b[c].ButtonId]=b[c])}return __extends(b,a),b.prototype.AppendSubMenu=function(a){this.SubMenuList.unshift(a),a.ButtonId&&(this.SubMenuMap[a.ButtonId]=a)},b.prototype.Render=function(a,b){for(var c=0;c<this.SubMenuList.length;c++)this.SubMenuList[c].Render(a,b,!0);$(".dropdown-toggle").dropdown()},b}(b);a.TopMenuTopItem=d;var e=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.Render=function(a,b){var c=document.createElement("li");c.className="divider",b.appendChild(c)},b}(b);a.DividerMenuItem=e;var f=function(a){function b(){a.apply(this,arguments)
}return __extends(b,a),b.prototype.GetIconName=function(){return"plus"},b.prototype.GetDisplayName=function(){return"New..."},b.prototype.Invoke=function(a){a.ExecCommandByName("new")},b}(b);a.NewMenuItem=f;var g=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.GetIconName=function(){return"folder-open"},b.prototype.GetDisplayName=function(){return"Open..."},b.prototype.Invoke=function(a){a.ExecCommandByName("open")},b}(b);a.OpenMenuItem=g;var h=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.GetIconName=function(){return"cloud-upload"},b.prototype.GetDisplayName=function(){return"Share"},b.prototype.Invoke=function(a){a.MasterRecord.GetLatestDoc().DocHistory.IsCommitRevision||a.ExecCommandByName("commit","Share"),a.ExecCommandByName("share")},b}(b);a.UploadMenuItem=h;var i=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.GetIconName=function(){return"floppy-save"},b.prototype.GetDisplayName=function(){return"Save"},b.prototype.Invoke=function(a){a.MasterRecord.GetLatestDoc().DocHistory.IsCommitRevision||a.ExecCommandByName("commit","Save");var b=a.WGSNName.replace(/(\.\w+)?$/,".wgsn");a.ExecCommandByName("save",b)},b}(b);a.SaveMenuItem=i;var j=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.GetDisplayName=function(){return"*."+this.GetExtention()+"..."},b.prototype.GetExtention=function(){return""},b.prototype.Invoke=function(a){a.MasterRecord.GetLatestDoc().DocHistory.IsCommitRevision||a.ExecCommandByName("commit","Save");var b=a.WGSNName.replace(/(\.\w+)?$/,"."+this.GetExtention()),c=a.FindCommandByCommandLineName("save"),d=prompt("Enter the file name",b);if(null!=d){var e;e=""==d?[b]:[d.replace(/(\.\w+)?$/,"."+this.GetExtention())],c.Invoke(null,e)}},b}(b);a.SaveAsMenuItem=j;var k=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.GetExtention=function(){return"wgsn"},b}(j);a.SaveAsWGSNMenuItem=k;var l=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.GetExtention=function(){return"dcase_model"},b}(j);a.SaveAsDCaseMenuItem=l;var m=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.GetDisplayName=function(){return"*.svg..."},b.prototype.GetExtention=function(){return""},b.prototype.Invoke=function(a){if(!a.MasterRecord.GetLatestDoc().DocHistory.IsCommitRevision){var b=a.FindCommandByCommandLineName("commit");b.Invoke(null,["Save"])}var c=a.WGSNName.replace(/(\.\w+)?$/,".svg"),d=a.FindCommandByCommandLineName("save-as-svg"),e=prompt("Enter the file name",c);if(null!=e){var f;f=""==e?[c]:[e.replace(/(\.\w+)?$/,".svg")],d.Invoke(null,f)}},b}(b);a.SaveAsSVGMenuItem=m;var n=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.GetIconName=function(){return"question-sign"},b.prototype.GetDisplayName=function(){return"Command list"},b.prototype.Invoke=function(a){a.ExecCommandByName("help")},b}(b);a.CommandListMenuItem=n;var o=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.GetIconName=function(){return"question-sign"},b.prototype.GetDisplayName=function(){return"Help"},b.prototype.Invoke=function(){window.open("https://github.com/AssureNote/AssureNote/blob/master/README.md")},b}(b);a.HelpMenuItem=o;var p=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.GetIconName=function(){return"question-sign"},b.prototype.GetDisplayName=function(){return"About"},b.prototype.Invoke=function(){$("#about-modal").modal()},b}(b);a.AboutMenuItem=p;var q=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.GetIconName=function(){return"time"},b.prototype.GetDisplayName=function(){return"Show history panel"},b.prototype.Invoke=function(a){a.ExecCommandByName("history")},b}(b);a.ShowHistoryPanelItem=q}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(){function a(a,b,c,d){this.UserName=a,this.Color=b,this.IsEditMode=c,this.SID=d}return a}();a.UserItem=b;var c=function(c){function d(a){c.call(this,a),this.App=a,this.UserName="Guest",this.UserList=[]}return __extends(d,c),d.prototype.Show=function(){var a=!1;for(var b in this.UserList)this.UserList[b].IsEditMode&&(a=!0);this.App.ModeManager.ReadOnly(a),$(".user-name").text(this.App.GetUserName()),$("#user-list-tmpl").tmpl(this.UserList).appendTo($("#user-list").empty())},d.prototype.AddUser=function(c){var d=this.GetRandomColor(),e=0==c.Mode?!0:!1;this.UserList.push(new b(c.User,d,e,c.SID)),this.Show();var f="highlight-"+c.SID,g={stroke:d};a.AssureNoteUtils.DefineColorStyle(f,g)},d.prototype.UpdateEditMode=function(a){for(var b in this.UserList)if(this.UserList[b].SID==a.SID){var c=this.UserList[b];c.IsEditMode=0==a.Mode}this.Show()},d.prototype.RemoveUser=function(a){for(var b=0;b<this.UserList.length;b++)if(this.UserList[b].SID==a){this.UserList.splice(b,1);break}this.Show()},d.prototype.GetRandomColor=function(){var a;do{a=Math.floor(16777215*Math.random()).toString(16);for(var b=a.length;6>b;b++)a="0"+a}while("000000"==a||"FFFFFF"==a);return"#"+a},d.prototype.AddFocusedUserColor=function(a,b){var c="highlight-"+a;b.Shape.AddColorStyle(c)},d.prototype.RemoveFocusedUserColor=function(a,b){var c="highlight-"+a;b.Shape.RemoveColorStyle(c)},d}(a.Panel);a.UserList=c}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(){function a(a,b){this.source=a,this.target=b}return a}(),c=function(){function c(b){this.Record=b,this.nodes={},this.links={},this.Text2NodeTypeMap={Goal:0,Strategy:2,Context:1,Pattern:1,Evidence:3},this.Doc=new a.GSNDoc(this.Record),this.Record.AddHistory(0,"unknown","converter","2013-12-09T13:16:18+0900","-",this.Doc)}return c.prototype.MakeTree=function(a){var b=this.nodes[a];for(var c in this.links){var d=this.links[c];if(d.source==a||d.target==a){var e;e=d.source==a?d.target:d.source,delete this.links[c];var f=this.nodes[e];null==b.SubNodeList?b.SubNodeList=[f]:b.SubNodeList.push(f),f.ParentNode=b,this.MakeTree(e)}}return b},c.prototype.Parse=function(c){var d=this,e=!0,f=$(c);f.find("rootBasicNode").each(function(b,c){var f=c.getAttribute("xsi:type"),g=f.split(":").pop(),h=c.getAttribute("id"),i=c.getAttribute("desc");e&&(d.RootNodeId=h,e=!1);var j=d.Text2NodeTypeMap[g],k=new a.GSNNode(d.Doc,null,j,g.charAt(0),a.AssureNoteUtils.GenerateUID(),null);k.NodeDoc=i,d.nodes[h]=k}),f.find("rootBasicLink").each(function(a,c){var e=c.getAttribute("id"),f=c.getAttribute("source").substring(1),g=c.getAttribute("target").substring(1);d.links[e]=new b(f,g)}),this.Doc.TopNode=this.MakeTree(this.RootNodeId),this.Doc.RenumberAll()},c}();a.DCaseModelXMLParser=c}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(a){function b(b){a.call(this,b),this.History=new c(b)}return __extends(b,a),b.prototype.GetCommandLineNames=function(){return["history"]},b.prototype.GetHelpHTML=function(){return"<code>history</code><br>."},b.prototype.Invoke=function(){this.History.Show()},b.prototype.CanUseOnViewOnlyMode=function(){return!0},b}(a.Command);a.HistoryCommand=b;var c=function(b){function c(a){b.call(this,a),this.App=a,this.Element=$("#history"),this.Element.hide(),this.App.HistoryPanel=this}return __extends(c,b),c.prototype.Show=function(){this.Index=this.App.MasterRecord.HistoryList.length-1,this.Update(),this.Element.show()},c.prototype.Hide=function(){this.Element.empty(),this.Element.hide(),this.DrawGSN(this.App.MasterRecord.GetLatestDoc().TopNode)},c.prototype.DrawGSN=function(b){var c=new a.NodeView(b,!0);this.App.PictgramPanel.InitializeView(c),this.App.PictgramPanel.Draw()},c.prototype.Update=function(){var b=this;this.Element.empty();var c=this.App.MasterRecord.HistoryList[this.Index],d=c.GetCommitMessage()||"(No Commit Message)",e={Message:d,User:c.Author,DateTime:a.AssureNoteUtils.FormatDate(c.DateString),DateTimeString:new Date(c.DateString).toLocaleString(),Count:{All:c.Doc.GetNodeCount(),Goal:c.Doc.GetNodeCountTypeOf(0),Evidence:c.Doc.GetNodeCountTypeOf(3),Context:c.Doc.GetNodeCountTypeOf(1),Strategy:c.Doc.GetNodeCountTypeOf(2)}};$("#history_tmpl").tmpl([e]).appendTo(this.Element),$("#history-panel-date").tooltip({}),$("#history-panel-count").tooltip({html:!0,title:"Goal: "+e.Count.Goal+"<br>Evidence: "+e.Count.Evidence+"<br>Context: "+e.Count.Context+"<br>Strategy: "+e.Count.Strategy}),0==this.Index&&$("#prev-revision").addClass("disabled"),this.Index==this.App.MasterRecord.HistoryList.length-1&&$("#next-revision").addClass("disabled"),$("#history-panel-close").click(function(){b.Hide()}),$("#prev-revision").click(function(){var a=(b.App.MasterRecord.HistoryList.length,b.Index);for(b.Index--,b.Index<0&&(b.Index=0);!b.App.MasterRecord.HistoryList[b.Index].IsCommitRevision;){if(b.Index<0){b.Index=0;break}b.Index--}if(console.log(b.Index),a!=b.Index){var c=b.App.MasterRecord.HistoryList[b.Index].Doc.TopNode;b.DrawGSN(c),b.Update()}}),$("#next-revision").click(function(){var a=b.App.MasterRecord.HistoryList.length,c=b.Index;for(b.Index++,b.Index>=a&&(b.Index=a-1);!b.App.MasterRecord.HistoryList[b.Index].IsCommitRevision;)if(b.Index++,b.Index>=a){b.Index=a-1;break}if(console.log(b.Index),c!=b.Index){var d=b.App.MasterRecord.HistoryList[b.Index].Doc.TopNode;b.DrawGSN(d),b.Update()}})},c}(a.Panel);a.HistoryPanel=c}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(){function b(){this.LoadingIndicatorVisible=!0,this.LoadingIndicator=document.getElementById("loading-indicator"),b.Current=this,this.Commands=[],this.CommandLineTable={},this.PluginManager=new a.PluginManager(this),this.PictgramPanel=new a.PictgramPanel(this),this.SocketManager=new a.SocketManager(this),this.FullScreenEditorPanel=new a.WGSNEditorPanel(this),this.SingleNodeEditorPanel=new a.SingleNodeEditorPanel(this),this.ModeManager=new a.ModeManager(this,1),this.DefaultCommand=new a.CommandMissingCommand(this),this.RegistCommand(new a.SaveCommand(this)),this.RegistCommand(new a.SaveSVGCommand(this)),this.RegistCommand(new a.SaveWGSNCommand(this)),this.RegistCommand(new a.SaveDCaseCommand(this)),this.RegistCommand(new a.CommitCommand(this)),this.RegistCommand(new a.OpenCommand(this)),this.RegistCommand(new a.NewCommand(this)),this.RegistCommand(new a.UnfoldAllCommand(this)),this.RegistCommand(new a.SetColorCommand(this)),this.RegistCommand(new a.SetScaleCommand(this)),this.RegistCommand(new a.HelpCommand(this)),this.RegistCommand(new a.ShareCommand(this)),this.RegistCommand(new a.HistoryCommand(this)),this.RegistCommand(new a.SetGuestUserNameCommand(this)),this.TopMenu=new a.TopMenuTopItem([]),this.TopMenuRight=new a.TopMenuTopItem([]),this.PluginManager.LoadPlugin(),this.UserName=null!=$.cookie("UserName")?$.cookie("UserName"):"Guest",this.UserList=new a.UserList(this),this.TopMenu.AppendSubMenu(new a.SubMenuItem(!0,"history","History","time",[new a.ShowHistoryPanelItem(!0)])),this.TopMenu.AppendSubMenu(new a.SubMenuItem(!0,"file","File","file",[new a.NewMenuItem(!0),new a.OpenMenuItem(!0),new a.SaveMenuItem(!0),new a.SubMenuItem(!0,"save-as","Save As","floppy-save",[new a.SaveAsWGSNMenuItem(!0),new a.SaveAsDCaseMenuItem(!0),new a.SaveAsSVGMenuItem(!0)]),new a.DividerMenuItem(!0),new a.HelpMenuItem(!0),new a.AboutMenuItem(!0)])),this.TopMenuRight.AppendSubMenu(new a.UploadMenuItem(!0)),this.TopMenu.Render(this,$("#top-menu").empty()[0],!0),this.TopMenuRight.Render(this,$("#top-menu-right").empty()[0],!0)}return b.prototype.IsLoading=function(){return this.LoadingIndicatorVisible},b.prototype.SetLoading=function(a){this.LoadingIndicatorVisible=a,this.LoadingIndicator.style.display=a?"":"none"},b.prototype.RegistCommand=function(a){this.Commands.push(a);for(var b=a.GetCommandLineNames(),c=0;c<b.length;++c)this.CommandLineTable[b[c].toLowerCase()]=a},b.prototype.DebugP=function(a){console.log(a)},b.Assert=function(a,b){if(0==a)throw console.log("Assert: "+b),"Assert: "+b},b.prototype.ExecDoubleClicked=function(a){this.PluginManager.GetDoubleClicked().forEach(function(b){b.OnNodeDoubleClicked(a)})},b.prototype.FindCommandByCommandLineName=function(a){var b=this.CommandLineTable[a.toLowerCase()]||this.DefaultCommand;return 1!=this.ModeManager.GetMode()||b.CanUseOnViewOnlyMode()?b:this.DefaultCommand},b.prototype.ExecCommandByName=function(a){for(var b=[],c=0;c<arguments.length-1;c++)b[c]=arguments[c+1];var d=this.FindCommandByCommandLineName(a);return d?(d.Invoke(a,b),!0):!1},b.prototype.ExecCommand=function(a){var b=a.GetMethod();if("search"!=b){var c=this.FindCommandByCommandLineName(b);c.Invoke(b,a.GetArgs())}},b.prototype.LoadDefaultWGSN=function(){var b=this;if(this.SetLoading(!0),null!=window.location.pathname.match("/file/"))a.AssureNoteUtils.postJsonRPC("download",{fileId:window.location.pathname.replace(/\/.*\//,"")},function(a){b.LoadNewWGSN("hello.wgsn",a.content)},function(){console.log("Assurance Case not found."),alert("Assurance Case not found.")});else{var c=navigator.browserLanguage||navigator.language||navigator.userLanguage;c&&"ja"!=c?this.LoadNewWGSN("hello.wgsn",$("#default-case-en").text()):this.LoadNewWGSN("hello.wgsn",$("#default-case-ja").text())}this.SetLoading(!1)},b.prototype.GetUserName=function(){return this.UserName},b.prototype.SetUserName=function(a){this.UserName=a},b.prototype.LoadNewWGSN=function(b,c){this.SetLoading(!0);var d=b.split(".").pop();switch(this.WGSNName=b,this.MasterRecord=new a.GSNRecord,d){case"dcase_model":new a.DCaseModelXMLParser(this.MasterRecord).Parse(c);break;case"xmi":new a.XMIParser(this.MasterRecord).Parse(c);break;default:case"wgsn":this.MasterRecord.Parse(c),this.MasterRecord.RenumberAll()}var e=this.MasterRecord.GetLatestDoc(),f=e.TopNode;if(this.PictgramPanel.InitializeView(new a.NodeView(f,!0)),this.PictgramPanel.FoldDeepSubGoals(this.PictgramPanel.TopNodeView),this.PictgramPanel.Draw(),""!=location.hash){var g=location.hash.substring(1),h=this.PictgramPanel.ViewMap[g];if(h){for(var i=h.Parent;i;)i.SetIsFolded(!1),i=i.Parent;this.PictgramPanel.Draw(),this.PictgramPanel.ChangeFocusedLabel(g),console.log(h.GetCenterGX()),this.PictgramPanel.Viewport.SetCamera(h.GetCenterGX(),h.GetCenterGY(),1)}}else{var j=this.PictgramPanel.TopNodeView;this.PictgramPanel.Viewport.SetCamera(j.GetCenterGX(),j.GetCenterGY()+this.PictgramPanel.Viewport.GetPageHeight()/3,1)}$("title").text("AssureNote"),this.SetLoading(!1)},b.prototype.LoadFiles=function(b){var c=this;if(b[0]){var d=new FileReader;d.onerror=function(a){console.log("error",a.target.error.code)},d.onload=function(d){var e=d.target.result,f=b[0].name;a.AssureNoteUtils.UpdateHash(null),c.LoadNewWGSN(f,e),c.SocketManager.UpdateWGSN()},d.readAsText(b[0],"utf-8")}},b}();a.AssureNoteApp=b}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(){function a(a,b,c){this.X=a,this.Y=b,this.ID=c}return a.prototype.SetPosition=function(a,b){this.X=a,this.Y=b},a}();a.Pointer=b;var c=function(){function a(a){this.Viewport=a,this.CurrentX=0,this.CurrentY=0,this.Dx=0,this.Dy=0,this.MainPointerID=null,this.Pointers=[],this.timer=0,this.ANIMATE_THRESHOLD=5,this.SPEED_MAX=100}return a.prototype.StartDrag=function(a,b){this.CurrentX=a,this.CurrentY=b;try{this.OnStartDrag&&this.OnStartDrag(this.Viewport)}catch(c){}},a.prototype.UpdateDrag=function(a,b){this.Dx=a-this.CurrentX,this.Dy=b-this.CurrentY;var c=this.Dx*this.Dx+this.Dy+this.Dy;c>this.SPEED_MAX*this.SPEED_MAX&&(this.Dx*=this.SPEED_MAX*this.SPEED_MAX/c,this.Dy*=this.SPEED_MAX*this.SPEED_MAX/c),this.CurrentX=a,this.CurrentY=b,this.OnDragged&&this.OnDragged(this.Viewport)},a.prototype.GetMainPointer=function(){return this.Pointers[this.MainPointerID]},a.prototype.IsDragging=function(){return null!=this.MainPointerID},a.prototype.StopAnimation=function(){clearInterval(this.timer),this.Dx=0,this.Dy=0},a.prototype.EndDrag=function(){this.MainPointerID=null,this.Viewport.SetEventMapLayerPosition(!1);try{this.OnEndDrag&&this.OnEndDrag(this.Viewport)}catch(a){}},a.prototype.OnPointerEvent=function(a,c){var d=this;switch(a.type){case"pointerdown":if("mouse"==a.pointerType&&0!=a.button)return;this.Pointers[a.pointerId]||(this.Pointers[a.pointerId]=new b(a.clientX,a.clientY,a.pointerId),a.preventDefault(),a.stopPropagation());break;case"pointerout":case"pointerleave":case"pointercancel":case"pointerup":if(!this.Pointers[a.pointerId])return;delete this.Pointers[a.pointerId],a.preventDefault(),a.stopPropagation();break;case"pointermove":if(!this.Pointers[a.pointerId])return;this.Pointers[a.pointerId].SetPosition(a.clientX,a.clientY),a.preventDefault(),a.stopPropagation();break;default:return}var e=Object.keys(this.Pointers).length>0,f=e&&!this.IsDragging(),g=!this.GetMainPointer()&&this.IsDragging();if(e)if(f){this.StopAnimation(),this.timer=null;var h=this.Pointers[Object.keys(this.Pointers)[0]];this.MainPointerID=h.ID,this.Viewport.SetEventMapLayerPosition(!0),this.StartDrag(h.X,h.Y)}else{var h=this.GetMainPointer();h?(this.UpdateDrag(h.X,h.Y),c.AddOffset(this.Dx,this.Dy)):this.EndDrag()}else g&&(this.timer&&(this.StopAnimation(),this.timer=null),this.timer=setInterval(function(){Math.abs(d.Dx)<d.ANIMATE_THRESHOLD&&Math.abs(d.Dy)<d.ANIMATE_THRESHOLD&&d.StopAnimation(),d.CurrentX+=d.Dx,d.CurrentY+=d.Dy,d.Dx*=.95,d.Dy*=.95,c.AddOffset(d.Dx,d.Dy)},16)),this.EndDrag()},a.prototype.OnDoubleTap=function(a,b){b.ContentLayer.clientWidth,b.ContentLayer.clientHeight,this.Pointers[0]},a.prototype.OnMouseWheel=function(a,b){b.SetCameraScale(b.GetCameraScale()*(1+.02*a.deltaY))},a}();a.ScrollManager=c;var d=function(b){function d(d,e,f,g){var h=this;b.call(this),this.SVGLayer=d,this.EventMapLayer=e,this.ContentLayer=f,this.ControlLayer=g,this.ScrollManager=new c(this),this.CameraGX=0,this.CameraGY=0,this.Scale=1,this.PageWidth=window.innerWidth,this.PageHeight=window.innerHeight,this.IsPointerEnabled=!0,this.CameraMoveTask=new a.AnimationFrameTask,this.IsEventMapUpper=!1,window.addEventListener("resize",function(){h.UpdatePageRect()}),this.UpdatePageRect(),this.SetCameraPageCenter(this.GetPageCenterX(),this.GetPageCenterY()),a.AssureNoteUtils.SetTransformOriginToElement(this.ContentLayer,"left top"),a.AssureNoteUtils.SetTransformOriginToElement(this.ControlLayer,"left top"),this.UpdateAttr();var i=function(a){h.IsPointerEnabled&&h.ScrollManager.OnPointerEvent(a,h)};["down","move","up","out","leave","cancel"].forEach(function(a){h.EventMapLayer.addEventListener("pointer"+a,i,!1)}),$(this.EventMapLayer.parentElement).on("mousewheel",function(a){h.IsPointerEnabled&&h.ScrollManager.OnMouseWheel(a,h)})}return __extends(d,b),d.prototype.GetCameraScale=function(){return this.Scale},d.LimitScale=function(a){return Math.max(.2,Math.min(20,a))},d.prototype.SetCameraScale=function(a){this.Scale=d.LimitScale(a),this.UpdateAttr()},d.prototype.GetOffsetPageX=function(){return this.CameraCenterPageX-this.CameraGX*this.Scale},d.prototype.GetOffsetPageY=function(){return this.CameraCenterPageY-this.CameraGY*this.Scale},d.prototype.LimitCameraPosition=function(){var a=this.CameraLimitRect;a&&(this.CameraGX<a.X&&(this.CameraGX=a.X),this.CameraGY<a.Y&&(this.CameraGY=a.Y),this.CameraGX>a.X+a.Width&&(this.CameraGX=a.X+a.Width),this.CameraGY>a.Y+a.Height&&(this.CameraGY=a.Y+a.Height))},d.prototype.SetOffset=function(a,b){this.CameraGX=(this.CameraCenterPageX-a)/this.Scale,this.CameraGY=(this.CameraCenterPageY-b)/this.Scale,this.LimitCameraPosition(),this.UpdateAttr()},d.prototype.AddOffset=function(a,b){this.CameraGX-=a/this.Scale,this.CameraGY-=b/this.Scale,this.LimitCameraPosition(),this.UpdateAttr()},d.prototype.GetCameraGX=function(){return this.CameraGX},d.prototype.GetCameraGY=function(){return this.CameraGY},d.prototype.SetCameraPosition=function(a,b){this.SetOffset(this.CameraCenterPageX-a*this.Scale,this.CameraCenterPageY-b*this.Scale)},d.prototype.SetCamera=function(a,b,c){this.Scale=c,this.SetOffset(this.CameraCenterPageX-a*this.Scale,this.CameraCenterPageY-b*this.Scale)},d.prototype.MoveCamera=function(a,b,c){this.Scale+=c,this.CameraGX+=a,this.CameraGY+=b,this.UpdateAttr()},d.prototype.GetCameraPageCenterX=function(){return this.CameraCenterPageX},d.prototype.GetCameraPageCenterY=function(){return this.CameraCenterPageY},d.prototype.SetCameraPageCenter=function(a,b){this.CameraCenterPageX=a,this.CameraCenterPageY=b},d.prototype.PageXFromGX=function(a){return this.CameraCenterPageX+(a-this.CameraGX)*this.Scale},d.prototype.PageYFromGY=function(a){return this.CameraCenterPageY+(a-this.CameraGY)*this.Scale},d.prototype.GXFromPageX=function(a){return(a-this.CameraCenterPageX)/this.Scale+this.CameraGX},d.prototype.GYFromPageY=function(a){return(a-this.CameraCenterPageY)/this.Scale+this.CameraGY},d.prototype.ConvertRectGlobalXYFromPageXY=function(b){var c=this.GXFromPageX(b.X),d=this.GYFromPageY(b.Y),e=this.GXFromPageX(b.X+b.Width),f=this.GYFromPageY(b.Y+b.Height);return new a.Rect(c,d,e-c,f-d)},d.prototype.GetPageRectInGxGy=function(){var b=this.GXFromPageX(0),c=this.GYFromPageY(0),d=this.GXFromPageX(this.PageWidth),e=this.GYFromPageY(this.PageHeight);return new a.Rect(b,c,d-b,e-c)},d.prototype.GetPageWidth=function(){return this.PageWidth},d.prototype.GetPageHeight=function(){return this.PageHeight},d.prototype.GetPageCenterX=function(){return.5*this.GetPageWidth()},d.prototype.GetPageCenterY=function(){return.5*this.GetPageHeight()},d.prototype.Move=function(a,b,c,d){this.MoveTo(this.GetCameraGX()+a,this.GetCameraGY()+b,c,d)},d.prototype.MoveTo=function(a,b,c,d){var e=this.CreateMoveToTaskFunction(a,b,c,d);return e?void this.CameraMoveTask.Start(d,e):void this.SetCamera(a,b,c)},d.prototype.CreateMoveTaskFunction=function(a,b,c,d){return this.CreateMoveToTaskFunction(this.GetCameraGX()+a,this.GetCameraGY()+b,c,d)},d.prototype.CreateMoveToTaskFunction=function(a,b,c,e){var f=this;if(c=d.LimitScale(c),0>=e)return null;var g=(a-this.GetCameraGX())/e,h=(b-this.GetCameraGY())/e,i=this.GetCameraScale(),j=c/i,k=1/e,l=function(a){return i*Math.pow(j,a*k)};return 0==h&&0==g&&c==i?null:function(a,b,c){var d=l(b-c)-l(b-a-c);f.MoveCamera(g*a,h*a,d)}},d.prototype.UpdatePageRect=function(){var a=this.CameraCenterPageX/this.PageWidth,b=this.CameraCenterPageY/this.PageHeight;this.PageWidth=window.innerWidth,this.PageHeight=window.innerHeight,this.SetCameraPageCenter(this.PageWidth*a,this.PageHeight*b)},d.prototype.SetEventMapLayerPosition=function(a){a&&!this.IsEventMapUpper?$(this.ControlLayer).after(this.EventMapLayer):!a&&this.IsEventMapUpper&&$(this.ContentLayer).before(this.EventMapLayer),this.IsEventMapUpper=a},d.CreateTranformAttr=function(a,b,c){return"translate("+a+" "+b+") scale("+c+")"},d.CreateTransformStyle=function(a,b,c){return"translate("+a+"px, "+b+"px) scale("+c+") "},d.prototype.UpdateAttr=function(){var b=this.GetOffsetPageX(),c=this.GetOffsetPageY(),e=d.CreateTranformAttr(b,c,this.Scale),f=d.CreateTransformStyle(b,c,this.Scale);this.SVGLayer.setAttribute("transform",e),a.AssureNoteUtils.SetTransformToElement(this.ContentLayer,f),a.AssureNoteUtils.SetTransformToElement(this.ControlLayer,f),this.OnScroll&&this.OnScroll(this);var g=new a.AssureNoteEvent;g.Type="cameramove",g.Target=this,this.DispatchEvent(g)},d}(a.EventTarget);a.ViewportManager=d}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(a){function b(b){a.call(this,b)}return __extends(b,a),b.prototype.GetCommandLineNames=function(){return["fold"]},b.prototype.GetHelpHTML=function(){return"<code>fold label</code><br>Toggle folding state of Goal."},b.prototype.Invoke=function(a,b){if(b.length<1)return void this.App.DebugP("no args");var c=b[0].toUpperCase(),d=(document.createEvent("UIEvents"),this.App.PictgramPanel.ViewMap[c]);null!=d?this.Fold(d):this.App.DebugP(c+" not found.")},b.prototype.Fold=function(a){{var b=this.App.PictgramPanel;b.Viewport}if(this.App.SocketManager.FoldNode({IsFolded:a.IsFolded(),UID:a.Model.UID}),2==a.GetNodeType()){if(null!=a.Children)for(var c=0;c<a.Children.length;c++){var d=a.Children[c];0==d.GetNodeType()&&d.SetIsFolded(!0)}}else{if(0!=a.GetNodeType())return void this.App.DebugP("Only type 'Strategy' or 'Goal' can be allowed to fold.");a.SetIsFolded(!a.IsFolded())}b.Draw(b.TopNodeView.Label,300,a)},b.prototype.CanUseOnViewOnlyMode=function(){return!0},b}(a.Command);a.FoldingCommand=b;var c=function(c){function d(a){c.call(this),this.SetHasDoubleClicked(!0),this.FoldingCommand=new b(a),a.RegistCommand(this.FoldingCommand)}return __extends(d,c),d.prototype.OnNodeDoubleClicked=function(b){1==a.AssureNoteApp.Current.ModeManager.GetMode()&&this.FoldingCommand.Fold(b)},d}(a.Plugin);a.FoldingViewSwitchPlugin=c}(AssureNote||(AssureNote={})),AssureNote.OnLoadPlugin(function(a){var b=new AssureNote.FoldingViewSwitchPlugin(a);a.PluginManager.SetPlugin("fold",b)});var AssureNote;!function(a){var b=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.GetCommandLineNames=function(){return["message"]},b.prototype.GetHelpHTML=function(){return"<code>message msg</code><br>Send message to the chat server."},b.prototype.Invoke=function(a,b){this.App.SocketManager.IsConnected()&&(this.App.SocketManager.Emit("message",b.join(" ")),$.notify(b.join(" "),"info"))},b.prototype.CanUseOnViewOnlyMode=function(){return!0},b}(a.Command);a.MessageCommand=b;var c=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.GetCommandLineNames=function(){return["connect"]},c.prototype.GetHelpHTML=function(){return"<code>connect [room?] [uri?]</code><br>Connect to the chat server."},c.prototype.Invoke=function(b,c){if(c.length>2)return void this.App.DebugP("Invalid parameter: "+c);var d=null,e=null;2==c.length?(d=c[0],e=c[1]):1==c.length&&(a.AssureNoteUtils.isValidURL(c[0])?e=c[0]:d=c[0]),this.App.ModeManager.SetMode(1),this.App.SocketManager.IsOperational()&&this.App.SocketManager.Connect(d,e)},c.prototype.CanUseOnViewOnlyMode=function(){return!0},c}(a.Command);a.ConnectCommand=c;var d=function(c){function d(a){c.call(this),this.AssureNoteApp=a,this.AssureNoteApp.SocketManager.RegisterSocketHandler("message",function(a){console.log(a),$.notify(a)}),this.AssureNoteApp.RegistCommand(new b(this.AssureNoteApp))}return __extends(d,c),d.prototype.RenderSVG=function(b,c){switch(c.RemoveColorStyle(a.ColorStyle.SingleEdit),c.RemoveColorStyle(a.ColorStyle.Locked),c.Status){case 1:c.AddColorStyle(a.ColorStyle.SingleEdit);break;case 2:c.AddColorStyle(a.ColorStyle.Locked)}},d}(a.Plugin);a.MessageChatPlugin=d;var e=function(a){function b(b){a.call(this),this.AssureNoteApp=b,this.AssureNoteApp.RegistCommand(new c(this.AssureNoteApp))}return __extends(b,a),b}(a.Plugin);a.ConnectServerPlugin=e}(AssureNote||(AssureNote={})),AssureNote.OnLoadPlugin(function(a){var b=new AssureNote.MessageChatPlugin(a);a.PluginManager.SetPlugin("message",b);var c=new AssureNote.ConnectServerPlugin(a);a.PluginManager.SetPlugin("connect",c)});var AssureNote;!function(a){var b=function(a){function b(b){a.call(this),this.AssureNoteApp=b}return __extends(b,a),b.prototype.Style=function(a,b){console.log("Match: "+a);var c=document.createElement("span");return c.className=b,c.textContent=a,c.outerHTML},b.prototype.Supplant=function(a,b,c){var d=this;return a.replace(/\[([^\[\]]*)\]/g,function(a){for(var e=[],f=0;f<arguments.length-1;f++)e[f]=arguments[f+1];for(var g=e[0],h=c[g];c[h];)h=c[h];if("string"==typeof h&&""!=h||"number"==typeof h)return d.Style(h,"node-variable");for(h=b[g];b[h];)h=b[h];return"string"==typeof h&&""!=h?d.Style(h,"node-variable"):d.Style(a,"node-variable-undefined")})},b.prototype.RenderHTML=function(a,b){var c=b.GetTagMapWithLexicalScope(),d=b.BaseDoc.GetLabelMap();return this.Supplant(a,d.hash,c?c.hash:{})},b}(a.Plugin);a.VariableInterpolationPlugin=b}(AssureNote||(AssureNote={})),AssureNote.OnLoadPlugin(function(a){var b=new AssureNote.VariableInterpolationPlugin(a);a.PluginManager.SetPlugin("variableinterpolation",b)});var AssureNote;!function(a){var b=function(b){function c(a){b.call(this),this.AssureNoteApp=a}return __extends(c,b),c.prototype.RenderSVG=function(b,c){c.RemoveColorStyle(a.ColorStyle.ToDo);var d=c.Model.GetTagMap();if(d){(d.get("TODO")||""==d.get("TODO"))&&c.AddColorStyle(a.ColorStyle.ToDo);var e=d.keySet();for(var f in e)""==d.get(e[f])&&c.AddColorStyle(a.ColorStyle.ToDo)}},c}(a.Plugin);a.ToDoPlugin=b}(AssureNote||(AssureNote={})),AssureNote.OnLoadPlugin(function(a){var b=new AssureNote.ToDoPlugin(a);a.PluginManager.SetPlugin("todo",b)});var Debug={};!function(){var a=document.getElementsByClassName("navbar")[0];a.innerHTML=a.innerHTML.replace(/\s\s+/g,"")}(),$(function(){var a=AssureNote.AssureNoteUtils.UserAgant;if(!a.IsBlink()&&!a.IsWebkit()&&!a.IsGecko())return void alert("Not supported browser. Use Chrome/Safari/FireFox.");a.IsPerformanceEnabled()||(window.performance={now:function(){return Date.now()}});var b=new AssureNote.AssureNoteApp;Debug.AssureNote=b,Debug.ShowCameraInfo=function(){setInterval(function(){var a=Debug.AssureNote.PictgramPanel.Viewport,b=a.GetCameraGX(),c=a.GetCameraGY(),d=a.GetCameraScale();document.title=["(",~~b,", ",~~c,") ",~~(100*d),"%"].join("")},100)},Debug.ShowFocusedLabel=function(){setInterval(function(){var a=Debug.AssureNote.PictgramPanel;document.title=a.FocusedLabel||"(not selected)"},100)},b.LoadDefaultWGSN()});var AssureNote;!function(a){var b=function(){function b(a,c){if(this.Model=a,this.RelativeX=0,this.RelativeY=0,this.Left=null,this.Right=null,this.Children=null,this.Shape=null,this.ShouldReLayoutFlag=!0,this.Label=a.GetLabel(),this.NodeDoc=a.NodeDoc,this.IsVisible=!0,this.IsFoldedFlag=!1,this.Status=0,c&&null!=a.SubNodeList)for(var d=0;d<a.SubNodeList.length;d++){var e=a.SubNodeList[d],f=new b(e,c);1==e.NodeType?this.AppendRightNode(f):this.AppendChild(f)}}return b.prototype.IsFolded=function(){return this.IsFoldedFlag},b.prototype.SetIsFolded=function(a){this.IsFoldedFlag!=a&&this.SetShouldReLayout(!0),this.IsFoldedFlag=a},b.prototype.SetShouldReLayout=function(a){!this.ShouldReLayoutFlag&&a&&this.Parent&&this.Parent.SetShouldReLayout(!0),this.ShouldReLayoutFlag=a},b.prototype.ShouldReLayout=function(){return this.ShouldReLayoutFlag},b.prototype.UpdateViewMap=function(a){if(a[this.Label]=this,null!=this.Left)for(var b=0;b<this.Left.length;b++)this.Left[b].UpdateViewMap(a);if(null!=this.Right)for(var b=0;b<this.Right.length;b++)this.Right[b].UpdateViewMap(a);if(null!=this.Children)for(var b=0;b<this.Children.length;b++)this.Children[b].UpdateViewMap(a)},b.prototype.AppendChild=function(a){null==this.Children&&(this.Children=[]),this.Children.push(a),a.Parent=this},b.prototype.AppendLeftNode=function(a){null==this.Left&&(this.Left=[]),this.Left.push(a),a.Parent=this},b.prototype.AppendRightNode=function(a){null==this.Right&&(this.Right=[]),this.Right.push(a),a.Parent=this},b.prototype.GetShape=function(){return null==this.Shape&&(this.Shape=a.AssureNoteUtils.CreateGSNShape(this)),this.Shape},b.prototype.SetShape=function(a){this.Shape&&(this.Shape.NodeView=null),a&&(a.NodeView=this),this.Shape=a},b.prototype.GetGX=function(){return null!=b.GlobalPositionCache&&b.GlobalPositionCache[this.Label]?b.GlobalPositionCache[this.Label].X:null==this.Parent?this.RelativeX:this.Parent.GetGX()+this.RelativeX},b.prototype.GetGY=function(){return null!=b.GlobalPositionCache&&b.GlobalPositionCache[this.Label]?b.GlobalPositionCache[this.Label].Y:null==this.Parent?this.RelativeY:this.Parent.GetGY()+this.RelativeY},b.prototype.GetCenterGX=function(){return this.GetGX()+.5*this.Shape.GetNodeWidth()},b.prototype.GetCenterGY=function(){return this.GetGY()+.5*this.Shape.GetNodeHeight()},b.SetGlobalPositionCacheEnabled=function(a){a&&null==b.GlobalPositionCache?b.GlobalPositionCache={}:a||(b.GlobalPositionCache=null)},b.prototype.GetGlobalPosition=function(){if(null!=b.GlobalPositionCache&&b.GlobalPositionCache[this.Label])return b.GlobalPositionCache[this.Label].Clone();if(null==this.Parent)return new a.Point(this.RelativeX,this.RelativeY);var c=this.Parent.GetGlobalPosition();return c.X+=this.RelativeX,c.Y+=this.RelativeY,null!=b.GlobalPositionCache&&(b.GlobalPositionCache[this.Label]=c.Clone()),c
},b.prototype.GetNodeType=function(){return this.Model.NodeType},b.prototype.Render=function(a,b,c){this.Shape.Render(a,b,c)},b.prototype.SaveFlags=function(a){var b=a[this.Model.GetLabel()];b&&(this.IsFoldedFlag=b.IsFoldedFlag,this.Status=b.Status,this.NodeDoc!=b.NodeDoc||this.GetNodeType()!=b.GetNodeType()||b.HasParameter()?this.GetShape().SetColorStyle(b.GetShape().GetColorStyle()):this.SetShape(b.GetShape()));for(var c=0;this.Children&&c<this.Children.length;c++)this.Children[c].SaveFlags(a);for(var c=0;this.Left&&c<this.Left.length;c++)this.Left[c].SaveFlags(a);for(var c=0;this.Right&&c<this.Right.length;c++)this.Right[c].SaveFlags(a)},b.prototype.GetConnectorPosition=function(a,b){var c=this.Shape.GetConnectorPosition(a);return c.X+=b.X,c.Y+=b.Y,c},b.prototype.UpdateNodePosition=function(b,c,d,e){var f=this;if(c=c||0,this.IsVisible){var g=function(a){var g=e;!g&&a.Shape.WillFadein()&&(g=f),g&&c>0?(a.Shape.SetFadeinBasePosition(g.Shape.GetGXCache(),g.Shape.GetGYCache()),a.UpdateNodePosition(b,c,d,g)):a.UpdateNodePosition(b,c,d)},h=this.GetGlobalPosition();this.Shape.MoveTo(b,h.X,h.Y,c,d);for(var i=[3,2,0],j=[this.Children,this.Right,this.Left],k=0;3>k;++k){var l=this.GetConnectorPosition(i[k],h),m=a.ReverseDirection(i[k]);this.ForEachVisibleSubNode(j[k],function(e){var f=e.GetConnectorPosition(m,e.GetGlobalPosition());g(e),e.Shape.MoveArrowTo(b,l,f,i[k],c,d),e.ParentDirection=a.ReverseDirection(i[k])})}}},b.prototype.ForEachVisibleSubNode=function(a,b){if(null!=a&&!this.IsFoldedFlag)for(var c=0;c<a.length;c++)if(a[c].IsVisible&&b(a[c])===!1)return!1;return!0},b.prototype.ForEachVisibleChildren=function(a){this.ForEachVisibleSubNode(this.Children,a)},b.prototype.ForEachVisibleRightNodes=function(a){this.ForEachVisibleSubNode(this.Right,a)},b.prototype.ForEachVisibleLeftNodes=function(a){this.ForEachVisibleSubNode(this.Left,a)},b.prototype.ForEachVisibleAllSubNodes=function(a){return this.ForEachVisibleSubNode(this.Left,a)&&this.ForEachVisibleSubNode(this.Right,a)&&this.ForEachVisibleSubNode(this.Children,a)?!0:!1},b.prototype.TraverseVisibleNode=function(a){a(this),this.ForEachVisibleAllSubNodes(function(b){b.TraverseVisibleNode(a)})},b.prototype.ForEachSubNode=function(a,b){if(null!=a)for(var c=0;c<a.length;c++)if(b(a[c])===!1)return!1;return!0},b.prototype.ForEachAllSubNodes=function(a){return this.ForEachSubNode(this.Left,a)&&this.ForEachSubNode(this.Right,a)&&this.ForEachSubNode(this.Children,a)?!0:!1},b.prototype.TraverseNode=function(a){return a(this)===!1?!1:this.ForEachAllSubNodes(function(b){return b.TraverseNode(a)})?!0:!1},b.prototype.ClearAnimationCache=function(a){(a||!this.IsVisible)&&this.GetShape().ClearAnimationCache(),this.ForEachAllSubNodes(a||this.IsFoldedFlag?function(a){a.ClearAnimationCache(!0)}:function(a){a.ClearAnimationCache(!1)})},b.prototype.HasSideNode=function(){return null!=this.Left&&this.Left.length>0||null!=this.Right&&this.Right.length>0},b.prototype.HasChildren=function(){return null!=this.Children&&this.Children.length>0},b.prototype.AddColorStyle=function(a){this.Shape.AddColorStyle(a)},b.prototype.RemoveColorStyle=function(a){this.Shape.RemoveColorStyle(a)},b.prototype.IsInRect=function(b){var c,d=this.Shape.GetGXCache(),e=this.Shape.GetGYCache();return c=null!=d&&null!=e?new a.Point(d,e):this.GetGlobalPosition(),c.X>b.X+b.Width||c.Y>b.Y+b.Height?!1:(c.X+=this.Shape.GetNodeWidth(),c.Y+=this.Shape.GetNodeHeight(),c.X<b.X||c.Y<b.Y?!1:!0)},b.prototype.IsConnectorInRect=function(b){if(!this.Parent)return!1;var c,d;null!=this.Shape.GetGXCache()&&null!=this.Shape.GetGYCache()?(c=this.Shape.GetArrowP1Cache(),d=this.Shape.GetArrowP2Cache()):(c=this.GetConnectorPosition(this.ParentDirection,this.GetGlobalPosition()),d=this.Parent.GetConnectorPosition(a.ReverseDirection(this.ParentDirection),this.Parent.GetGlobalPosition()));var e=new a.Point(Math.min(c.X,d.X),Math.min(c.Y,d.Y));return e.X>b.X+b.Width||e.Y>b.Y+b.Height?!1:(e.X=Math.max(c.X,d.X),e.Y=Math.max(c.Y,d.Y),e.X<b.X||e.Y<b.Y?!1:!0)},b.prototype.HasParameter=function(){return null!=this.NodeDoc.match(/\[([^\[\]]*)\]/)},b.prototype.IsMonitorNode=function(){var a=this.Model;if(!a.IsEvidence())return!1;for(var b=a.GetCloseGoal(),c=null,d=0;d<b.SubNodeList.length;d++){var e=b.SubNodeList[d];if(e.IsContext()){c=e;break}}if(null==c)return!1;var f=c.GetTagMapWithLexicalScope(),g=f.get("Location"),h=f.get("Condition");return g&&h?!0:!1},b.GlobalPositionCache=null,b}();a.NodeView=b,function(a){a[a.TreeEditable=0]="TreeEditable",a[a.SingleEditable=1]="SingleEditable",a[a.Locked=2]="Locked"}(a.EditStatus||(a.EditStatus={}));a.EditStatus}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(){function b(){var a=this;this.Queue=[],this.TimerHandle=0,this.DummyDiv=document.createElement("div"),this.DummyDiv.style.position="absolute",this.DummyDiv.style.top="1000%",document.body.appendChild(this.DummyDiv),setInterval(function(){a.Queue.length&&console.log("size prefetch: "+a.Queue.length+" nodes left")},1e3)}return b.prototype.Start=function(){var b=this;this.TimerHandle=setInterval(function(){for(var c=a.AssureNoteUtils.GetTime();b.Queue.length>0&&a.AssureNoteUtils.GetTime()-c<16;){var d=b.Queue.shift();d.NodeView&&!d.IsSizeCached()&&(d.PrerenderContent(a.AssureNoteApp.Current.PluginManager),d.Content.parentElement||b.DummyDiv.appendChild(d.Content),d.GetNodeWidth(),d.GetHeadHeight(),b.DummyDiv.removeChild(d.Content))}0==b.Queue.length&&(clearInterval(b.TimerHandle),b.TimerHandle=0)},20)},b.prototype.AddShape=function(a){this.Queue.push(a),this.TimerHandle||this.Start()},b}();a.GSNShapeSizePreFetcher=b;var c=function(){function c(d){this.NodeView=d,this.ColorStyles=[a.ColorStyle.Default],this.willFadein=!1,this.GXCache=null,this.GYCache=null,this.Content=null,this.NodeWidthCache=c.DefaultWidth,this.NodeHeightCache=0,this.HeadBoundingBox=new a.Rect(0,0,0,0),this.TreeBoundingBox=new a.Rect(0,0,0,0),null==c.AsyncSizePrefetcher&&(c.AsyncSizePrefetcher=new b),c.AsyncSizePrefetcher.AddShape(this)}return c.prototype.IsSizeCached=function(){return 0!=this.NodeHeightCache&&0!=this.NodeWidthCache},c.CreateArrowPath=function(){return c.ArrowPathMaster.cloneNode()},c.prototype.SetTreeRect=function(a,b,c,d){this.SetTreeUpperLeft(a,b),this.SetTreeSize(c,d)},c.prototype.SetHeadRect=function(a,b,c,d){this.SetHeadUpperLeft(a,b),this.SetHeadSize(c,d)},c.prototype.SetTreeSize=function(a,b){this.TreeBoundingBox.Width=a,this.TreeBoundingBox.Height=b},c.prototype.SetHeadSize=function(a,b){this.HeadBoundingBox.Width=a,this.HeadBoundingBox.Height=b},c.prototype.GetNodeWidth=function(){return this.NodeWidthCache},c.prototype.GetNodeHeight=function(){if(0==this.NodeHeightCache){var a=c.NodeHeightCache[this.Content.innerHTML];a?this.NodeHeightCache=a:c.NodeHeightCache[this.Content.innerHTML]=this.NodeHeightCache=this.Content.clientHeight}return this.NodeHeightCache},c.prototype.GetTreeWidth=function(){return 0==this.TreeBoundingBox.Width&&(this.TreeBoundingBox.Width=250),this.TreeBoundingBox.Width},c.prototype.GetTreeHeight=function(){return 0==this.TreeBoundingBox.Height&&(this.TreeBoundingBox.Height=100),this.TreeBoundingBox.Height},c.prototype.GetHeadWidth=function(){return 0==this.HeadBoundingBox.Width&&(this.HeadBoundingBox.Width=250),this.HeadBoundingBox.Width},c.prototype.GetHeadHeight=function(){return 0==this.HeadBoundingBox.Height&&(this.HeadBoundingBox.Height=100),this.HeadBoundingBox.Height},c.prototype.GetTreeLeftLocalX=function(){return this.TreeBoundingBox.X},c.prototype.GetHeadLeftLocalX=function(){return this.HeadBoundingBox.X},c.prototype.SetTreeUpperLeft=function(a,b){this.TreeBoundingBox.X=a,this.TreeBoundingBox.Y=b},c.prototype.SetHeadUpperLeft=function(a,b){this.HeadBoundingBox.X=a,this.HeadBoundingBox.Y=b},c.prototype.UpdateHtmlClass=function(){this.Content.className="node"},c.prototype.FormatNewLine=function(a){return a.replace(/\n/g,"<br>")},c.prototype.PrerenderHTMLContent=function(b){if(null==this.Content){var c=document.createElement("div");this.Content=c,c.style.position="absolute",c.id=this.NodeView.Label;var d=document.createElement("h4");d.textContent=this.NodeView.Label;var e=document.createElement("p"),f=a.AssureNoteUtils.HTMLEncode(this.NodeView.NodeDoc.trim());e.innerHTML=this.FormatNewLine(b.InvokeHTMLRenderPlugin(f,this.NodeView.Model)),this.UpdateHtmlClass(),c.appendChild(d),c.appendChild(e)}},c.prototype.PrerenderContent=function(a){this.PrerenderHTMLContent(a),this.PrerenderSVGContent(a)},c.prototype.Render=function(a,b,c){b.appendChild(this.ShapeGroup),null!=this.ArrowPath&&null!=this.NodeView.Parent&&c.appendChild(this.ArrowPath),a.appendChild(this.Content)},c.prototype.FitSizeToContent=function(){},c.prototype.RemoveAnimateElement=function(a){if(a){var b=a.parentNode;b&&b.removeChild(a)}},c.prototype.SetPosition=function(a,b){if(this.NodeView.IsVisible){var c=this.Content;null!=c&&(c.style.left=a+"px",c.style.top=b+"px");var d=this.ShapeGroup.transform.baseVal.getItem(0).matrix;d.e=a,d.f=b}this.GXCache=a,this.GYCache=b},c.prototype.SetOpacity=function(a){this.Content.style.opacity=a.toString(),this.ShapeGroup.style.opacity=a.toString()},c.prototype.Fadein=function(a,b){var c=this,d=1/b,e=0;a.push(function(a){e+=d*a,c.SetOpacity(e),c.SetArrowOpacity(e)})},c.prototype.MoveTo=function(a,b,d,e,f){var g=this;if(0>=e)return void this.SetPosition(b,d);if(this.WillFadein()){if(c.__Debug_Animation_TotalNodeCount++,f&&(d+this.GetNodeHeight()<f.Y||d>f.Y+f.Height))return this.SetPosition(b,d),this.willFadein=!1,void c.__Debug_Animation_SkippedNodeCount++;if(this.Fadein(a,e),this.willFadein=!1,null==this.GXCache||null==this.GYCache)return this.SetPosition(b,d),void c.__Debug_Animation_SkippedNodeCount++}if(f){if(c.__Debug_Animation_TotalNodeCount++,(this.GXCache+this.GetNodeWidth()<f.X||this.GXCache>f.X+f.Width)&&(b+this.GetNodeWidth()<f.X||b>f.X+f.Width))return c.__Debug_Animation_SkippedNodeCount++,void this.SetPosition(b,d);if(this.GYCache+this.GetNodeHeight()<f.Y||this.GYCache>f.Y+f.Height)return c.__Debug_Animation_SkippedNodeCount++,void this.SetPosition(b,d)}var h=(b-this.GXCache)/e,i=(d-this.GYCache)/e;a.push(function(a){return g.SetPosition(g.GXCache+h*a,g.GYCache+i*a)})},c.prototype.SetFadeinBasePosition=function(b,c){this.willFadein=!0,this.GXCache=b,this.GYCache=c,this.ArrowP1Cache=this.ArrowP2Cache=new a.Point(b+.5*this.GetNodeWidth(),c+.5*this.GetNodeHeight())},c.prototype.GetGXCache=function(){return this.GXCache},c.prototype.GetGYCache=function(){return this.GYCache},c.prototype.WillFadein=function(){return this.willFadein||null==this.GXCache||null==this.GYCache},c.prototype.ClearAnimationCache=function(){this.GXCache=null,this.GYCache=null},c.prototype.PrerenderSVGContent=function(b){this.ShapeGroup=a.AssureNoteUtils.CreateSVGElement("g"),this.ShapeGroup.setAttribute("transform","translate(0,0)"),this.ShapeGroup.setAttribute("class",this.ColorStyles.join(" ")),this.ArrowPath=c.CreateArrowPath(),this.ArrowStart=this.ArrowPath.pathSegList.getItem(0),this.ArrowCurve=this.ArrowPath.pathSegList.getItem(1),b.InvokeSVGRenderPlugin(this.ShapeGroup,this.NodeView)},c.prototype.GetArrowP1Cache=function(){return this.ArrowP1Cache},c.prototype.GetArrowP2Cache=function(){return this.ArrowP2Cache},c.prototype.SetArrowPosition=function(a,b,c){var d=this.ArrowStart,e=this.ArrowCurve;if(d.x=a.X,d.y=a.Y,e.x=b.X,e.y=b.Y,3==c||1==c){var f=Math.abs(a.X-b.X);e.x1=(9*a.X+b.X)/10,e.y1=b.Y,e.x2=(9*b.X+a.X)/10,e.y2=a.Y,f>300&&(e.x1=a.X-10*(a.X-b.X<0?-1:1),e.x2=b.X+10*(a.X-b.X<0?-1:1)),50>f&&(e.y1=e.y2=.5*(a.Y+b.Y))}else e.x1=(a.X+b.X)/2,e.y1=(9*a.Y+b.Y)/10,e.x2=(a.X+b.X)/2,e.y2=(9*b.Y+a.Y)/10;this.ArrowP1Cache=a,this.ArrowP2Cache=b},c.prototype.SetArrowOpacity=function(a){this.ArrowPath.style.opacity=a.toString()},c.prototype.MoveArrowTo=function(a,b,c,d,e,f){var g=this;if(0>=e)return void this.SetArrowPosition(b,c,d);if(f){var h=this.ArrowP1Cache.X<this.ArrowP2Cache.X?this.ArrowP2Cache.X:this.ArrowP1Cache.X,i=this.ArrowP1Cache.X<this.ArrowP2Cache.X?this.ArrowP1Cache.X:this.ArrowP2Cache.X;if(h<f.X||i>f.X+f.Width){var j=b.X<c.X?c.X:b.X,k=b.X<c.X?b.X:c.X;if(j<f.X||k>f.X+f.Width)return void this.SetArrowPosition(b,c,d)}if(this.ArrowP2Cache.Y<f.Y||this.ArrowP1Cache.Y>f.Y+f.Height)return void this.SetArrowPosition(b,c,d)}if(this.ArrowP1Cache==this.ArrowP2Cache&&f&&(c.Y+this.GetNodeHeight()<f.Y||b.Y>f.Y+f.Height))return void this.SetArrowPosition(b,c,d);var l=(b.X-this.ArrowP1Cache.X)/e,m=(b.Y-this.ArrowP1Cache.Y)/e,n=(c.X-this.ArrowP2Cache.X)/e,o=(c.Y-this.ArrowP2Cache.Y)/e,p=this.ArrowP1Cache.Clone(),q=this.ArrowP2Cache.Clone();a.push(function(a){p.X+=l*a,p.Y+=m*a,q.X+=n*a,q.Y+=o*a,g.SetArrowPosition(p,q,d)})},c.prototype.SetArrowColorWhite=function(a){a?this.ArrowPath.setAttribute("marker-end","url(#Triangle-white)"):this.ArrowPath.setAttribute("marker-end","url(#Triangle-black)")},c.prototype.GetConnectorPosition=function(b){switch(b){case 2:return new a.Point(this.GetNodeWidth(),this.GetNodeHeight()/2);case 0:return new a.Point(0,this.GetNodeHeight()/2);case 1:return new a.Point(this.GetNodeWidth()/2,0);case 3:return new a.Point(this.GetNodeWidth()/2,this.GetNodeHeight());default:return new a.Point(0,0)}},c.prototype.AddColorStyle=function(a){a&&(this.ColorStyles.indexOf(a)<0&&this.ColorStyles.push(a),this.ShapeGroup&&this.ShapeGroup.setAttribute("class",this.ColorStyles.join(" ")))},c.prototype.RemoveColorStyle=function(b){if(b&&b!=a.ColorStyle.Default){var c=this.ColorStyles.indexOf(b);c>0&&this.ColorStyles.splice(c,1),this.ShapeGroup&&this.ShapeGroup.setAttribute("class",this.ColorStyles.join(" "))}},c.prototype.GetColorStyle=function(){return this.ColorStyles},c.prototype.SetColorStyle=function(b){this.ColorStyles=b,this.ColorStyles.indexOf(a.ColorStyle.Default)<0&&this.ColorStyles.push(a.ColorStyle.Default)},c.prototype.ClearColorStyle=function(){this.ColorStyles=[a.ColorStyle.Default],this.ShapeGroup&&this.ShapeGroup.setAttribute("class",this.ColorStyles.join(" "))},c.NodeHeightCache={},c.DefaultWidth=250,c.ArrowPathMaster=function(){var b=a.AssureNoteUtils.CreateSVGElement("path");return b.setAttribute("marker-end","url(#Triangle-black)"),b.setAttribute("fill","none"),b.setAttribute("stroke","gray"),b.setAttribute("d","M0,0 C0,0 0,0 0,0"),b}(),c}();a.GSNShape=c;var d=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.PrerenderSVGContent=function(d){b.prototype.PrerenderSVGContent.call(this,d),this.BodyRect=a.AssureNoteUtils.CreateSVGElement("rect"),this.ShapeGroup.appendChild(this.BodyRect),this.NodeView.IsFolded()&&this.ShapeGroup.appendChild(c.ModuleSymbolMaster.cloneNode()),null!=this.NodeView.Children||this.NodeView.IsFolded()||(this.UndevelopedSymbol=c.UndevelopedSymbolMaster.cloneNode(),this.ShapeGroup.appendChild(this.UndevelopedSymbol))},c.prototype.FitSizeToContent=function(){if(this.BodyRect.setAttribute("width",this.GetNodeWidth().toString()),this.BodyRect.setAttribute("height",this.GetNodeHeight().toString()),null==this.NodeView.Children&&!this.NodeView.IsFolded()){var a=(this.GetNodeWidth()/2).toString(),b=(this.GetNodeHeight()+20).toString();this.UndevelopedSymbol.setAttribute("transform","translate("+a+","+b+")"),this.UndevelopedSymbol.setAttribute("y",b+"px")}},c.prototype.UpdateHtmlClass=function(){this.Content.className="node node-goal"},c.ModuleSymbolMaster=function(){var b=a.AssureNoteUtils.CreateSVGElement("rect");return b.setAttribute("width","80px"),b.setAttribute("height","13px"),b.setAttribute("y","-13px"),b}(),c.UndevelopedSymbolMaster=function(){var b=a.AssureNoteUtils.CreateSVGElement("polygon");return b.setAttribute("points","0 -20 -20 0 0 20 20 0"),b}(),c}(c);a.GSNGoalShape=d;var e=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.PrerenderSVGContent=function(c){b.prototype.PrerenderSVGContent.call(this,c),this.BodyRect=a.AssureNoteUtils.CreateSVGElement("rect"),this.ArrowPath.setAttribute("marker-end","url(#Triangle-white)"),this.BodyRect.setAttribute("rx","10"),this.BodyRect.setAttribute("ry","10"),this.ShapeGroup.appendChild(this.BodyRect)},c.prototype.FitSizeToContent=function(){this.BodyRect.setAttribute("width",this.GetNodeWidth().toString()),this.BodyRect.setAttribute("height",this.GetNodeHeight().toString())},c.prototype.UpdateHtmlClass=function(){this.Content.className="node node-context"},c}(c);a.GSNContextShape=e;var f=function(b){function c(){b.apply(this,arguments),this.delta=20}return __extends(c,b),c.prototype.PrerenderSVGContent=function(c){b.prototype.PrerenderSVGContent.call(this,c),this.BodyPolygon=a.AssureNoteUtils.CreateSVGElement("polygon"),this.ShapeGroup.appendChild(this.BodyPolygon)},c.prototype.FitSizeToContent=function(){var a=this.GetNodeWidth(),b=this.GetNodeHeight();this.BodyPolygon.setAttribute("points",""+this.delta+",0 "+a+",0 "+(a-this.delta)+","+b+" 0,"+b)},c.prototype.UpdateHtmlClass=function(){this.Content.className="node node-strategy"},c.prototype.GetConnectorPosition=function(b){switch(b){case 2:return new a.Point(this.GetNodeWidth()-this.delta/2,this.GetNodeHeight()/2);case 0:return new a.Point(this.delta/2,this.GetNodeHeight()/2);case 1:return new a.Point(this.GetNodeWidth()/2,0);case 3:return new a.Point(this.GetNodeWidth()/2,this.GetNodeHeight())}},c}(c);a.GSNStrategyShape=f;var g=function(b){function c(){b.apply(this,arguments)}return __extends(c,b),c.prototype.PrerenderSVGContent=function(d){if(b.prototype.PrerenderSVGContent.call(this,d),this.BodyEllipse=a.AssureNoteUtils.CreateSVGElement("ellipse"),this.ShapeGroup.appendChild(this.BodyEllipse),this.NodeView.IsMonitorNode()){var e=c.MonitorLabelMaster.cloneNode();e.textContent="M",this.ShapeGroup.appendChild(e)}},c.prototype.FitSizeToContent=function(){this.BodyEllipse.setAttribute("cx",(this.GetNodeWidth()/2).toString()),this.BodyEllipse.setAttribute("cy",(this.GetNodeHeight()/2).toString()),this.BodyEllipse.setAttribute("rx",(this.GetNodeWidth()/2).toString()),this.BodyEllipse.setAttribute("ry",(this.GetNodeHeight()/2).toString())},c.prototype.UpdateHtmlClass=function(){this.Content.className="node node-evidence"},c.MonitorLabelMaster=function(){var b=a.AssureNoteUtils.CreateSVGElement("text");return b.setAttribute("x","220"),b.setAttribute("y","20"),b.setAttribute("font-size","36px"),b.setAttribute("font-family","Times New Roman"),b.setAttribute("fill","gray"),b.setAttribute("stroke","none"),b}(),c}(c);a.GSNEvidenceShape=g}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(){function a(a,b){this.App=a,this.Mode=b,this.WrapperElement=$(".edit-mode"),this.Input=document.createElement("input"),this.Input.id="mode-switch",this.Input.setAttribute("type","checkbox"),0==b&&this.Input.setAttribute("checked",""),this.Input.setAttribute("data-on-label","Edit"),this.Input.setAttribute("data-off-label","View"),this.Enable()}return a.prototype.GetMode=function(){return this.Mode},a.prototype.SetMode=function(a){this.Mode=a,0==a?this.Input.setAttribute("checked",""):this.Input.removeAttribute("checked")},a.prototype.ReadOnly=function(a){$("#mode-switch").bootstrapSwitch("setDisabled",a)},a.prototype.Disable=function(){$(this.WrapperElement.empty())},a.prototype.Enable=function(){var a=this;$(this.Input).appendTo(this.WrapperElement.empty()),$("#mode-switch").bootstrapSwitch(),$("#mode-switch").bootstrapSwitch("setSizeClass","").on("switch-change",function(){for(var b=[],c=0;c<arguments.length-1;c++)b[c]=arguments[c+1];var d=b[0].value;a.SetMode(d?0:1),a.App.SocketManager.UpdateEditMode(a.Mode)})},a}();a.ModeManager=b}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(a){function b(b){a.call(this,b),this.AssureNoteApp=b,this.Tooltip=null,this.CurrentView=null}return __extends(b,a),b.prototype.Enable=function(){},b.prototype.Remove=function(){this.Tooltip.remove(),this.Tooltip=null,this.CurrentView=null,this.IsEnable=!1},b.prototype.Create=function(a,b,c){if(null!=this.Tooltip&&this.Remove(),null!=c&&0!=c.length){this.IsEnable=!0,this.CurrentView=a,this.Tooltip=$('<div"></div>');var d=$('<pre id="tooltip"></pre>'),e=$(document.createElement("ul"));e.addClass("list-unstyled");for(var f=0;f<c.length;f++)e.append(c[f]);d.append(e),this.Tooltip.append(d),this.Tooltip.appendTo(b);var g=this.CurrentView.GetGY()+this.CurrentView.Shape.GetNodeHeight()+5,h=this.CurrentView.GetGX()+this.CurrentView.Shape.GetNodeWidth()/2;this.Tooltip.css({position:"absolute",top:g,left:h,display:"block",opacity:100})}},b}(a.Panel);a.Tooltip=b}(AssureNote||(AssureNote={}));var AssureNote;!function(a){function b(a,b,c,d){var e=null,f={jsonrpc:"2.0",method:b,id:1,params:c};return $.ajax({type:"POST",url:a,async:!1,data:f,success:function(a){e=a},error:function(a,b,c){console.log("ajax error"),null!=d&&d(a,b,c)}}),e}var c=function(){function a(a){this.URL=a}return a.prototype.GetLatestData=function(a,c,d){var e={location:a,type:c},f=b(this.URL,"getLatestData",e,d);return null==f?null:"result"in f?f.result:(console.log(f.error),null)},a}();a.RecApi=c}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(){function a(a,b){this.source=a,this.target=b}return a}(),c=function(){function c(b){this.Record=b,this.contents={},this.nodes={},this.links={},this.Text2NodeTypeMap={"GSN.Goal":0,"GSN.Strategy":2,"GSN.Context":1,"GSN.Solution":3},this.Doc=new a.GSNDoc(this.Record),this.Record.AddHistory(0,"unknown","converter","2013-12-09T13:16:18+0900","-",this.Doc)}return c.prototype.MakeTree=function(a){var b=this.nodes[a];for(var c in this.links){var d=this.links[c];if(d.source==a||d.target==a){var e;e=d.source==a?d.target:d.source,delete this.links[c];var f=this.nodes[e];null==b.SubNodeList?b.SubNodeList=[f]:b.SubNodeList.push(f),f.ParentNode=b,this.MakeTree(e)}}return b},c.prototype.Parse=function(c){var d=this,e=!0,f=$(c);f.find("argumentElement").each(function(a,b){var c=b.getAttribute("xmi:id");d.contents[c]=b.getAttribute("content")}),f.find("children").each(function(b,c){var f=c.getAttribute("type"),g=c.getAttribute("xmi:id"),h=c.getAttribute("element");e&&(d.RootNodeId=g,e=!1);var i=d.Text2NodeTypeMap[f],j=new a.GSNNode(d.Doc,null,i,f.charAt(4),a.AssureNoteUtils.GenerateUID(),null);j.NodeDoc=d.contents[h]||"",d.nodes[g]=j}),f.find("edges").each(function(a,c){var e=c.getAttribute("xmi:id"),f=c.getAttribute("source"),g=c.getAttribute("target");d.links[e]=new b(f,g)}),this.Doc.TopNode=this.MakeTree(this.RootNodeId),this.Doc.RenumberAll()},c}();a.XMIParser=c}(AssureNote||(AssureNote={}));var AssureNote;!function(a){var b=function(b){function c(a){b.call(this,a)}return __extends(c,b),c.prototype.GetCommandLineNames=function(){return["rm","remove"]},c.prototype.GetHelpHTML=function(){return"<code>remove label</code><br>Remove a node and it's descendant."},c.prototype.Invoke=function(b,d){if(d.length>0){var e=d[0],f=this.App.PictgramPanel.ViewMap[e];if(null==f)return void this.App.DebugP("Node not Found");for(var g=this.App.PictgramPanel.ViewMap[e].Model,h=g.ParentNode,i=0;i<h.SubNodeList.length;i++){var j=h.SubNodeList[i];g==j&&h.SubNodeList.splice(i,1)}c.RemoveDescendantsRecursive(g);var k=this.App.MasterRecord.GetLatestDoc().TopNode,l=new a.NodeView(k,!0);l.SaveFlags(this.App.PictgramPanel.ViewMap),this.App.PictgramPanel.InitializeView(l),this.App.PictgramPanel.Draw(k.GetLabel()),this.App.SocketManager.UpdateWGSN()}else console.log("Need paramter")},c.RemoveDescendantsRecursive=function(a){if(null==a.SubNodeList)return void(a.ParentNode=null);for(var b=0;b<a.SubNodeList.length;b++)c.RemoveDescendantsRecursive(a.SubNodeList[b]);a.SubNodeList=null},c}(a.Command);a.RemoveCommand=b;var c=function(c){function d(a){c.call(this),this.AssureNoteApp=a,this.SetHasMenuBarButton(!0),this.AssureNoteApp.RegistCommand(new b(this.AssureNoteApp))}return __extends(d,c),d.prototype.CreateMenuBarButton=function(){{var b=this;this.AssureNoteApp}return new a.NodeMenuItem("remove-id","/images/remove.png","remove",function(a,c){var d=b.AssureNoteApp.FindCommandByCommandLineName("remove");d&&d.Invoke(null,[c.Label])})},d}(a.Plugin);a.RemoveNodePlugin=c}(AssureNote||(AssureNote={})),AssureNote.OnLoadPlugin(function(a){var b=new AssureNote.RemoveNodePlugin(a);a.PluginManager.SetPlugin("Remove",b)});var AssureNote;!function(a){var b=function(b){function c(a){b.call(this,a),this.Text2NodeTypeMap={goal:0,strategy:2,context:1,evidence:3}}return __extends(c,b),c.prototype.GetCommandLineNames=function(){return["addnode","add-node"]},c.prototype.GetHelpHTML=function(){return"<code>add-node node type</code><br>Add new node."},c.prototype.Invoke=function(b,c){var d=this.Text2NodeTypeMap[c[1].toLowerCase()],e=this.App.PictgramPanel.ViewMap[c[0]];if(null==e)return void this.App.DebugP("Node not Found");this.App.MasterRecord.OpenEditor(this.App.GetUserName(),"todo",null,"test");var f=this.App.MasterRecord.EditingDoc.GetNode(e.Model.UID);new a.GSNNode(f.BaseDoc,f,d,null,a.AssureNoteUtils.GenerateUID(),null);var g=this.App.MasterRecord.EditingDoc;g.RenumberAll();var h=g.TopNode,i=new a.NodeView(h,!0);i.SaveFlags(this.App.PictgramPanel.ViewMap),this.App.PictgramPanel.InitializeView(i),this.App.PictgramPanel.Draw(h.GetLabel()),this.App.SocketManager.UpdateWGSN(),this.App.MasterRecord.CloseEditor()},c}(a.Command);a.AddNodeCommand=b;var c=function(c){function d(a){c.call(this),this.AssureNoteApp=a,this.SetHasMenuBarButton(!0),this.AssureNoteApp.RegistCommand(new b(this.AssureNoteApp))}return __extends(d,c),d.prototype.CreateCallback=function(a){var b=this;return function(c,d){var e=b.AssureNoteApp.FindCommandByCommandLineName("add-node");e&&e.Invoke(null,[d.Label,a])}},d.prototype.CreateGoalMenu=function(){return new a.NodeMenuItem("add-goal","/images/goal.png","goal",this.CreateCallback("goal"))},d.prototype.CreateContextMenu=function(){return new a.NodeMenuItem("add-context","/images/context.png","context",this.CreateCallback("context"))},d.prototype.CreateStrategyMenu=function(){return new a.NodeMenuItem("add-strategy","/images/strategy.png","strategy",this.CreateCallback("strategy"))},d.prototype.CreateEvidenceMenu=function(){return new a.NodeMenuItem("add-evidence","/images/evidence.png","evidence",this.CreateCallback("evidence"))},d.prototype.CreateMenuBarButtons=function(a){var b=[],c=a.GetNodeType();switch(c){case 0:b=b.concat([this.CreateContextMenu(a),this.CreateStrategyMenu(a),this.CreateEvidenceMenu(a)]);break;case 2:b=b.concat([this.CreateContextMenu(a),this.CreateGoalMenu(a)]);break;case 1:break;case 3:b.push(this.CreateContextMenu(a))}return b},d}(a.Plugin);a.AddNodePlugin=c}(AssureNote||(AssureNote={})),AssureNote.OnLoadPlugin(function(a){var b=new AssureNote.AddNodePlugin(a);a.PluginManager.SetPlugin("AddNode",b)});var AssureNote;!function(a){var b=function(b){function c(a){b.call(this),this.AssureNoteApp=a}return __extends(c,b),c.prototype.RenderHTML=function(b,c){var d=c.LastModified.Author;if(d&&"unknown"!=d){var e=document.createElement("span");e.className="glyphicon glyphicon-user";var f=document.createElement("span");f.className="glyphicon glyphicon-time";var g=document.createElement("span");g.className="node-author",c.IsEvidence()?g.className=g.className+" node-author-evidence":c.IsStrategy()&&(g.className=g.className+" node-author-strategy"),g.textContent=d+"&nbsp";var h=document.createElement("small");return h.innerHTML=f.outerHTML+"&nbsp"+a.AssureNoteUtils.FormatDate(c.LastModified.DateString),g.innerHTML=e.outerHTML+g.textContent+h.outerHTML,b+g.outerHTML}return b},c.prototype.CreateTooltipContents=function(b){var c=[],d=null;return"unknown"!=b.Model.Created.Author&&(d=document.createElement("li"),d.innerHTML="Created by <b>"+b.Model.Created.Author+"</b> "+a.AssureNoteUtils.FormatDate(b.Model.Created.DateString),c.push(d)),"unknown"!=b.Model.LastModified.Author&&(d=document.createElement("li"),d.innerHTML="Last modified by <b>"+b.Model.LastModified.Author+"</b> "+a.AssureNoteUtils.FormatDate(b.Model.LastModified.DateString),c.push(d)),c},c}(a.Plugin);a.LastModifiedPlugin=b}(AssureNote||(AssureNote={})),AssureNote.OnLoadPlugin(function(a){var b=new AssureNote.LastModifiedPlugin(a);a.PluginManager.SetPlugin("LastModified",b)});var AssureNote;!function(AssureNote){var MonitorNode=function(){function MonitorNode(a,b){this.App=a,this.Label=b,this.Data=null,this.PastStatus=[],this.PastLogs=[];for(var c=this.GetModel(),d=c.GetCloseGoal(),e=null,f=0;f<d.SubNodeList.length;f++){var g=d.SubNodeList[f];if(g.IsContext()){e=g;break}}if(null!=e){var h=e.GetTagMapWithLexicalScope();this.Location=h.get("Location"),this.Condition=h.get("Condition"),this.ExtractTypeFromCondition()}}return MonitorNode.prototype.GetView=function(){return this.App.PictgramPanel.ViewMap[this.Label]},MonitorNode.prototype.GetModel=function(){return this.GetView().Model},MonitorNode.prototype.ExtractTypeFromCondition=function(){var a=this.Condition.replace(/\{|\}|\(|\)|==|<=|>=|<|>/g," "),b=a.split(" ");this.Type=null;for(var c=0;c<b.length;c++)if(""!=b[c]&&!$.isNumeric(b[c])){this.Type=b[c];break}},MonitorNode.prototype.IsValid=function(){return this.Location&&this.Type&&this.Condition?!0:!1},MonitorNode.prototype.IsDead=function(){return null==this.GetView()?!0:!1},MonitorNode.prototype.GetLatestLog=function(){return this.PastLogs[0]},MonitorNode.prototype.SetLatestLog=function(a){this.PastLogs.length>10&&this.PastLogs.pop(),this.PastLogs.unshift(a)},MonitorNode.prototype.GetLatestStatus=function(){return this.PastStatus[0]},MonitorNode.prototype.SetLatestStatus=function(a){this.PastStatus.length>10&&this.PastStatus.pop(),this.PastStatus.unshift(a)},MonitorNode.prototype.UpdateModel=function(){var a=this.GetModel();null==a.TagMap&&(a.TagMap=new AssureNote.HashMap);var b=null!=this.Data?this.Data+"":"";a.TagMap.put(this.Type,b),a.HasTag=!0;var c=a.NodeDoc+AssureNote.Lib.LineFeed,d=new RegExp(this.Type+"\\s*::.*\\n","g");c.match(d)?(c=c.replace(d,this.Type+"::"+b+AssureNote.Lib.LineFeed),c=c.slice(0,-1)):(c==AssureNote.Lib.LineFeed&&(c=""),c+=this.Type+"::"+b),a.NodeDoc=c,a.LastModified=a.BaseDoc.DocHistory},MonitorNode.prototype.Update=function(Rec,ErrorCallback){var LatestLog=Rec.GetLatestData(this.Location,this.Type,ErrorCallback);if(null!=LatestLog&&JSON.stringify(LatestLog)!=JSON.stringify(this.GetLatestLog())){this.Data=LatestLog.data;var RecType=this.Type.replace(/[\.\/\-]/g,"_"),RecCondition=this.Condition.replace(/[\.\/\-]/g,"_"),Script="var "+RecType+"="+this.Data+";";Script+=RecCondition+";";var LatestStatus=eval(Script);this.SetLatestLog(LatestLog),this.SetLatestStatus(LatestStatus),this.UpdateModel()}},MonitorNode}();AssureNote.MonitorNode=MonitorNode;var MonitorNodeManager=function(){function a(a){this.App=a,this.MonitorNodeMap={},this.NodeCount=0,this.IsRunning=!1;var b=Config.RecURL;(null==b||""==b)&&(b="http://localhost:3001/api/3.0/"),this.Rec=new AssureNote.RecApi(b),this.NodeColorMap={}}return a.prototype.SetRecURL=function(a){this.Rec=new AssureNote.RecApi(a)},a.prototype.SetMonitorNode=function(a){a.Label in this.MonitorNodeMap||(this.NodeCount+=1),this.MonitorNodeMap[a.Label]=a,a.UpdateModel()},a.prototype.DeleteMonitorNode=function(a){a in this.MonitorNodeMap&&(this.NodeCount-=1,delete this.MonitorNodeMap[a])},a.prototype.DeleteDeadMonitorNodes=function(){for(var a in this.MonitorNodeMap){var b=this.MonitorNodeMap[a];if(b.IsDead()&&(this.DeleteMonitorNode(a),this.NodeCount<1&&this.IsRunning)){this.StopMonitoring();break}}},a.prototype.DeleteAllMonitorNodes=function(){for(var a in this.MonitorNodeMap){{this.MonitorNodeMap[a]}if(this.DeleteMonitorNode(a),this.NodeCount<1&&this.IsRunning){this.StopMonitoring();break}}},a.prototype.InitializeView=function(a){var b=this.App.PictgramPanel;a.RenumberAll();var c=new AssureNote.NodeView(a.TopNode,!0);c.SaveFlags(b.ViewMap),b.InitializeView(c)},a.prototype.UpdateView=function(a){this.App.PictgramPanel.Draw(a.TopNode.GetLabel())},a.prototype.CheckPresumedNodeColor=function(){var a=this,b=this.App.MasterRecord.GetLatestDoc().GetLabelMap();for(var c in a.App.PictgramPanel.ViewMap){var d=a.App.PictgramPanel.ViewMap[c],e=d.Model;if(e.HasTag){var f=null,g=e.GetTagMap().get("Presume");
null!=g&&(f=g.replace(/\[|\]/g,""));var h=null;null!=f&&(h=b.get(f)),null==h&&(h=f);var i=a.NodeColorMap[h];if(null!=i&&i){for(var j=d;null!=d;)a.NodeColorMap[d.Label]=AssureNote.ColorStyle.Danger,d=d.Parent;j.Model.IsContext()&&(j=j.Parent),j.ForEachVisibleChildren(function(b){b.TraverseNode(function(b){a.NodeColorMap[b.Label]=AssureNote.ColorStyle.Useless})})}}}},a.prototype.UpdateNodeColorMap=function(){this.NodeColorMap={};for(var a in this.MonitorNodeMap){var b=this.MonitorNodeMap[a];if(0==b.GetLatestStatus())for(var c=b.GetView();null!=c;)this.NodeColorMap[c.Label]=AssureNote.ColorStyle.Danger,c=c.Parent}this.CheckPresumedNodeColor()},a.prototype.StartMonitoring=function(a){this.IsRunning=!0,console.log("Start monitoring...");var b=this;this.Timer=setInterval(function(){console.log("Monitoring..."),b.NodeColorMap={};var a=b.App.MasterRecord.GetLatestDoc(),c=!0;for(var d in b.MonitorNodeMap){var e=b.MonitorNodeMap[d];if(e.IsDead()){if(b.DeleteMonitorNode(d),b.NodeCount<1&&b.IsRunning){b.StopMonitoring();break}}else{if(e.Update(b.Rec,function(){b.StopMonitoring()}),!b.IsRunning)break;if(c&&("Monitor"!=a.DocHistory.Author&&(b.App.MasterRecord.OpenEditor("Monitor","todo",null,"test"),a=b.App.MasterRecord.EditingDoc),c=!1),0==e.GetLatestStatus())for(var f=e.GetView();null!=f;)b.NodeColorMap[f.Label]=AssureNote.ColorStyle.Danger,f=f.Parent}}b.CheckPresumedNodeColor(),b.InitializeView(a),b.UpdateView(a),null!=b.App.MasterRecord.EditingDoc&&b.App.MasterRecord.CloseEditor()},a),SetMonitorMenuItem.ChangeMenuToggle(this.App)},a.prototype.StopMonitoring=function(){this.IsRunning=!1,console.log("Stop monitoring..."),clearTimeout(this.Timer),SetMonitorMenuItem.ChangeMenuToggle(this.App)},a}();AssureNote.MonitorNodeManager=MonitorNodeManager;var MNodeManager=null,SetMonitorCommand=function(a){function b(b){a.call(this,b)}return __extends(b,a),b.prototype.GetCommandLineNames=function(){return["set-monitor"]},b.prototype.GetHelpHTML=function(){return"<code>set-monitor</code><br>Set node as monitor."},b.prototype.Invoke=function(a,b){if(MNodeManager.DeleteDeadMonitorNodes(),1==b.length){var c=b[0];if("all"==c){var d=!0;for(var e in this.App.PictgramPanel.ViewMap){var f=this.App.PictgramPanel.ViewMap[e];if(f.Model.IsEvidence()){var g=new MonitorNode(this.App,e);g.IsValid()?(d&&(this.App.MasterRecord.OpenEditor("Monitor","todo",null,"test"),MNodeManager.InitializeView(this.App.MasterRecord.EditingDoc),d=!1),MNodeManager.SetMonitorNode(g)):this.App.DebugP("Node("+e+") is not a monitor")}}}else{var e=c,f=this.App.PictgramPanel.ViewMap[e];if(null==f)return void this.App.DebugP("Node not found");if(!f.Model.IsEvidence())return void this.App.DebugP("This node is not a monitor");var g=new MonitorNode(this.App,e);if(!g.IsValid())return void this.App.DebugP("This node is not a monitor");this.App.MasterRecord.OpenEditor("Monitor","todo",null,"test"),MNodeManager.InitializeView(this.App.MasterRecord.EditingDoc),MNodeManager.SetMonitorNode(g)}null!=this.App.MasterRecord.EditingDoc&&(MNodeManager.UpdateView(this.App.MasterRecord.EditingDoc),this.App.MasterRecord.CloseEditor()),MNodeManager.NodeCount>0&&!MNodeManager.IsRunning&&MNodeManager.StartMonitoring(5e3)}else console.log(b.length>1?"Too many parameter":"Need parameter")},b.prototype.CanUseOnViewOnlyMode=function(){return!0},b}(AssureNote.Command);AssureNote.SetMonitorCommand=SetMonitorCommand;var UnsetMonitorCommand=function(a){function b(b){a.call(this,b)}return __extends(b,a),b.prototype.GetCommandLineNames=function(){return["unset-monitor"]},b.prototype.GetHelpHTML=function(){return"<code>unset-monitor</code><br>Unset node as monitor."},b.prototype.Invoke=function(a,b){if(MNodeManager.DeleteDeadMonitorNodes(),1==b.length){var c=b[0];if("all"==c)MNodeManager.DeleteAllMonitorNodes();else{var d=c,e=this.App.PictgramPanel.ViewMap[d];if(null==e)return void this.App.DebugP("Node not found");MNodeManager.DeleteMonitorNode(d),MNodeManager.NodeCount<1&&MNodeManager.IsRunning&&MNodeManager.StopMonitoring()}MNodeManager.UpdateNodeColorMap();var f=this.App.MasterRecord.GetLatestDoc();MNodeManager.InitializeView(f),MNodeManager.UpdateView(f)}else console.log(b.length>1?"Too many parameter":"Need parameter")},b.prototype.CanUseOnViewOnlyMode=function(){return!0},b}(AssureNote.Command);AssureNote.UnsetMonitorCommand=UnsetMonitorCommand;var UseRecAtCommand=function(a){function b(b){a.call(this,b)}return __extends(b,a),b.prototype.GetCommandLineNames=function(){return["use-rec-at"]},b.prototype.GetHelpHTML=function(){return"<code>use-rec-at</code><br>Use specified REC."},b.prototype.Invoke=function(a,b){1==b.length?MNodeManager.SetRecURL(b[0]):console.log(b.length>1?"Too many parameter":"Need parameter")},b.prototype.CanUseOnViewOnlyMode=function(){return!0},b}(AssureNote.Command);AssureNote.UseRecAtCommand=UseRecAtCommand;var MonitorListPanel=function(a){function b(b){a.call(this,b);var c=$('<div id="monitorlist-modal" tabindex="-1" role="dialog" aria-labelledby="monitorlist-modal-label" aria-hidden="true" class="modal fade">\n  <div class="modal-dialog">\n    <div class="modal-content">\n      <div class="modal-header">\n        <button type="button" data-dismiss="modal" aria-hidden="true" class="close">&times;</button>\n        <h4 id="monitorlist-modal-label" class="modal-title">Active Monitor List</h4>\n      </div>\n      <div id="monitorlist-modal-body" class="modal-body">\n      </div>\n      <div class="modal-footer">\n        <button type="button" data-dismiss="modal" class="btn btn-default">Close</button>\n      </div>\n    </div>\n  </div>\n</div>\n            ');$("#plugin-layer").append(c),$("#monitorlist-modal").on("hidden.bs.modal",function(){b.PictgramPanel.Activate()})}return __extends(b,a),b.prototype.UpdateMonitorList=function(){var a=$("#monitorlist-modal-body")[0],b=document.createElement("table");b.className="table table-bordered",b.setAttribute("width","90%"),b.setAttribute("align","center");var c="";c+='<tr align="center" bgcolor="#cccccc">',c+="<th>Label</th>",c+="<th>Type</th>",c+="<th>Location</th>",c+="<th>AuthID</th>",c+="<th>Last Update</th>",c+="</tr>";for(var d in MNodeManager.MonitorNodeMap){var e=MNodeManager.MonitorNodeMap[d],f=e.GetLatestStatus();c+=null==f||1==f?'<tr align="center">':'<tr align="center" bgcolor="#ffaa7d">',c+="<td>"+e.Label+"</td>",c+="<td>"+e.Type+"</td>",c+="<td>"+e.Location+"</td>";var g=e.GetLatestLog();null!=g?(c+="<td>"+g.authid+"</td>",c+="<td>"+g.timestamp+"</td>"):(c+="<td>N/A</td>",c+="<td>N/A</td>"),c+="</tr>"}b.innerHTML=c,a.innerHTML=b.outerHTML},b.prototype.OnActivate=function(){this.UpdateMonitorList(),$("#monitorlist-modal").modal()},b}(AssureNote.Panel);AssureNote.MonitorListPanel=MonitorListPanel;var ShowMonitorListCommand=function(a){function b(b){a.call(this,b),this.MonitorListPanel=new MonitorListPanel(b)}return __extends(b,a),b.prototype.GetCommandLineNames=function(){return["show-monitorlist"]},b.prototype.GetHelpHTML=function(){return"<code>show-monitorlist</code><br>Show list of monitors."},b.prototype.Invoke=function(){this.MonitorListPanel.Activate()},b.prototype.CanUseOnViewOnlyMode=function(){return!0},b}(AssureNote.Command);AssureNote.ShowMonitorListCommand=ShowMonitorListCommand;var SetMonitorMenuItem=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.GetIconName=function(){return MNodeManager.IsRunning?"minus":"plus"},b.prototype.GetDisplayName=function(){return MNodeManager.IsRunning?"Unset":"Set"},b.ChangeMenuToggle=function(a){a.TopMenu.Render(a,$("#top-menu").empty()[0],!0)},b.prototype.Invoke=function(a){if(MNodeManager.IsRunning){var b=a.FindCommandByCommandLineName("unset-monitor");null!=b&&b.Invoke(null,["all"])}else{var b=a.FindCommandByCommandLineName("set-monitor");null!=b&&b.Invoke(null,["all"])}},b}(AssureNote.TopMenuItem);AssureNote.SetMonitorMenuItem=SetMonitorMenuItem;var ShowMonitorListMenuItem=function(a){function b(){a.apply(this,arguments)}return __extends(b,a),b.prototype.GetIconName=function(){return"th-list"},b.prototype.GetDisplayName=function(){return"Show monitors"},b.prototype.Invoke=function(a){var b=a.FindCommandByCommandLineName("show-monitorlist");b.Invoke(null,[])},b}(AssureNote.TopMenuItem);AssureNote.ShowMonitorListMenuItem=ShowMonitorListMenuItem;var MonitorNodePlugin=function(a){function b(b){a.call(this),this.AssureNoteApp=b,MNodeManager=new MonitorNodeManager(this.AssureNoteApp),this.SetHasMenuBarButton(!0),this.AssureNoteApp.RegistCommand(new SetMonitorCommand(this.AssureNoteApp)),this.AssureNoteApp.RegistCommand(new UnsetMonitorCommand(this.AssureNoteApp)),this.AssureNoteApp.RegistCommand(new UseRecAtCommand(this.AssureNoteApp)),this.AssureNoteApp.RegistCommand(new ShowMonitorListCommand(this.AssureNoteApp)),this.AssureNoteApp.TopMenu.AppendSubMenu(new AssureNote.SubMenuItem(!1,"monitor","Monitor","eye-open",[new SetMonitorMenuItem(!0),new ShowMonitorListMenuItem(!0)]))}return __extends(b,a),b.prototype.CreateMenuBarButton=function(a){if(!a.Model.IsEvidence())return null;var b=this.AssureNoteApp,c=new MonitorNode(b,a.Label);return c.IsValid?c.Label in MNodeManager.MonitorNodeMap?new AssureNote.NodeMenuItem("unset-monitor","/images/monitor.png","unset monitor",function(a,c){var d=b.FindCommandByCommandLineName("unset-monitor");null!=d&&d.Invoke(null,[c.Label])}):new AssureNote.NodeMenuItem("set-monitor","/images/monitor.png","set monitor",function(a,c){var d=b.FindCommandByCommandLineName("set-monitor");null!=d&&d.Invoke(null,[c.Label])}):null},b.prototype.CreateTooltipContents=function(a){if(!(a.Label in MNodeManager.MonitorNodeMap))return null;var b=MNodeManager.MonitorNodeMap[a.Label],c=[],d=document.createElement("li");d.innerHTML="<b>Monitor</b> is running on <b>"+b.Location+"<br></b>",c.push(d);var e=b.GetLatestLog();null!=e&&(d=document.createElement("li"),d.innerHTML="<b>Monitor</b> is certificated by <b>"+b.GetLatestLog().authid+"<br></b>",c.push(d)),d=document.createElement("li"),d.innerHTML="<hr>",c.push(d),d=document.createElement("li");var f=document.createElement("table");f.setAttribute("border","4"),f.setAttribute("width","250"),f.setAttribute("align","center");var g="";g+="<caption>REC Logs</caption>",g+='<tr align="center" bgcolor="#cccccc">',g+="<th>Timestamp</th>",g+="<th>"+b.Type+"</th>",g+="</tr>";for(var h=0;h<b.PastLogs.length;h++){var i=b.PastLogs[h],j=b.PastStatus[h];g+=1==j?'<tr align="center">':'<tr align="center" bgcolor="#ffaa7d">',g+="<td>"+i.timestamp+"</td>",g+="<td>"+i.data+"</td>",g+="</tr>"}return f.innerHTML=g,d.innerHTML=f.outerHTML,c.push(d),c},b.prototype.RenderSVG=function(a,b){b.RemoveColorStyle(AssureNote.ColorStyle.Danger),b.RemoveColorStyle(AssureNote.ColorStyle.Useless),b.Label in MNodeManager.NodeColorMap&&b.AddColorStyle(MNodeManager.NodeColorMap[b.Label])},b}(AssureNote.Plugin);AssureNote.MonitorNodePlugin=MonitorNodePlugin}(AssureNote||(AssureNote={})),AssureNote.OnLoadPlugin(function(a){var b=new AssureNote.MonitorNodePlugin(a);a.PluginManager.SetPlugin("Monitor",b)});