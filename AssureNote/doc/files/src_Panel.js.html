<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/Panel.js - AssureNote</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="AssureNote"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.0.1</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/AssureNote.Panel.html">AssureNote.Panel</a></li>
            
                <li><a href="../classes/AssureNote.PictgramPanel.html">AssureNote.PictgramPanel</a></li>
            
                <li><a href="../classes/AssureNote.ScrollManager.html">AssureNote.ScrollManager</a></li>
            
                <li><a href="../classes/AssureNote.ViewportManager.html">AssureNote.ViewportManager</a></li>
            
                <li><a href="../classes/AssureNoteParsr.html">AssureNoteParsr</a></li>
            
                <li><a href="../classes/GSNDoc.html">GSNDoc</a></li>
            
                <li><a href="../classes/GSNHistory.html">GSNHistory</a></li>
            
                <li><a href="../classes/GSNNode.html">GSNNode</a></li>
            
                <li><a href="../classes/GSNRecord.html">GSNRecord</a></li>
            
                <li><a href="../classes/ParserContext.html">ParserContext</a></li>
            
                <li><a href="../classes/StringReader.html">StringReader</a></li>
            
                <li><a href="../classes/StringWriter.html">StringWriter</a></li>
            
                <li><a href="../classes/TagUtils.html">TagUtils</a></li>
            
                <li><a href="../classes/WikiSyntax.html">WikiSyntax</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: src/Panel.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
// ***************************************************************************
// Copyright (c) 2014, AssureNote project authors. All rights reserved.
// Redistribution and use in source and binary forms, with or without
// modification, are permitted provided that the following conditions are met:
//
// *  Redistributions of source code must retain the above copyright notice,
//    this list of conditions and the following disclaimer.
// *  Redistributions in binary form must reproduce the above copyright
//    notice, this list of conditions and the following disclaimer in the
//    documentation and/or other materials provided with the distribution.
//
// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
// &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
// TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
// PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
// CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
// EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
// PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS;
// OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
// WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR
// OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF
// ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
// **************************************************************************
var __extends = this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    __.prototype = b.prototype;
    d.prototype = new __();
};
///&lt;reference path=&#x27;./AssureNote.ts&#x27;/&gt;
///&lt;reference path=&#x27;./AssureNoteUtils.ts&#x27;/&gt;
///&lt;reference path=&#x27;./CommandLine.ts&#x27;/&gt;
///&lt;reference path=&#x27;./SearchNode.ts&#x27;/&gt;
///&lt;reference path=&#x27;./LayoutEngine.ts&#x27;/&gt;
///&lt;reference path=&#x27;./Editor.ts&#x27;/&gt;
///&lt;reference path=&#x27;../d.ts/codemirror.d.ts&#x27;/&gt;
///&lt;reference path=&#x27;../plugin/FullScreenEditor/FullScreenEditor.ts&#x27;/&gt;
///&lt;reference path=&#x27;../plugin/SingleNodeEditor/SingleNodeEditor.ts&#x27;/&gt;
var AssureNote;
(function (AssureNote) {
    /**
    @class AssureNote.Panel
    */
    var Panel = (function () {
        function Panel(App) {
            this.IsVisible = false;
            this.App = App;
            if (!Panel.Initialized) {
                Panel.ActivePanel = this;
                document.addEventListener(&quot;keydown&quot;, function (Event) {
                    Panel.ActivePanel.OnKeyDown(Event);
                });
                Panel.Initialized = true;
            }
        }
        Panel.prototype.Create = function (NodeView, ControlLayer, contents) {
            /* Do nothing */
        };

        Panel.prototype.OnKeyDown = function (Event) {
        };

        Panel.prototype.OnActivate = function () {
        };

        Panel.prototype.OnDeactivate = function () {
        };

        Panel.prototype.Remove = function () {
        };

        Panel.prototype.Show = function () {
            this.IsEnable = true;
        };

        Panel.prototype.Hide = function () {
            this.IsVisible = false;
        };

        Panel.prototype.Activate = function () {
            if (!this.IsActive()) {
                Panel.ActivePanel.OnDeactivate();
                Panel.ActivePanel = this;
                this.OnActivate();
            }
        };

        Panel.prototype.IsActive = function () {
            return Panel.ActivePanel == this;
        };
        Panel.Initialized = false;
        return Panel;
    })();
    AssureNote.Panel = Panel;

    /**
    @class AssureNote.PictgramPanel
    @extends AssureNote.Panel
    */
    var PictgramPanel = (function (_super) {
        __extends(PictgramPanel, _super);
        // We do not use FocusedView but FocusedLabel to make it modular.
        function PictgramPanel(App) {
            var _this = this;
            _super.call(this, App);
            this.App = App;
            this.SVGLayer = document.getElementById(&quot;svg-layer&quot;);
            this.EventMapLayer = (document.getElementById(&quot;eventmap-layer&quot;));
            this.ContentLayer = (document.getElementById(&quot;content-layer&quot;));
            this.ControlLayer = (document.getElementById(&quot;control-layer&quot;));
            this.Viewport = new AssureNote.ViewportManager(this.SVGLayer, this.EventMapLayer, this.ContentLayer, this.ControlLayer);
            this.LayoutEngine = new AssureNote.SimpleLayoutEngine(this.App);

            this.ContextMenu = new AssureNote.NodeMenu(App);
            this.NodeTooltip = new AssureNote.Tooltip(App);

            this.ContentLayer.addEventListener(&quot;click&quot;, function (event) {
                var Label = AssureNote.AssureNoteUtils.GetNodeLabelFromEvent(event);
                _this.App.DebugP(&quot;click:&quot; + Label);
                if (_this.IsActive()) {
                    _this.ChangeFocusedLabel(Label);
                }
                if (_this.ContextMenu.IsEnable) {
                    _this.ContextMenu.Remove();
                }
                if (_this.NodeTooltip.IsEnable) {
                    _this.NodeTooltip.Remove();
                }
                event.preventDefault();
            });

            this.EventMapLayer.addEventListener(&quot;pointerdown&quot;, function (event) {
                if (_this.IsActive()) {
                    _this.ChangeFocusedLabel(null);
                }
            });

            this.ContentLayer.addEventListener(&quot;contextmenu&quot;, function (event) {
                var Label = AssureNote.AssureNoteUtils.GetNodeLabelFromEvent(event);
                var NodeView = _this.ViewMap[Label];
                if (NodeView != null) {
                    _this.ChangeFocusedLabel(Label);
                    switch (NodeView.Status) {
                        case 0 /* TreeEditable */:
                            var Buttons = _this.App.PluginManager.GetMenuBarButtons(NodeView);
                            _this.ContextMenu.Create(_this.ViewMap[Label], _this.ControlLayer, Buttons);
                            break;
                        case 1 /* SingleEditable */:
                            var Buttons = _this.App.PluginManager.GetMenuBarButtons(NodeView);
                            _this.ContextMenu.Create(_this.ViewMap[Label], _this.ControlLayer, Buttons);
                            break;
                        case 2 /* Locked */:
                            $.notify(&quot;Warning: currently edited&quot;, &#x27;warn&#x27;);
                            break;
                    }
                } else {
                    _this.FocusedLabel = null;
                }
                event.preventDefault();
            });

            this.ContentLayer.addEventListener(&quot;dblclick&quot;, function (event) {
                var Label = AssureNote.AssureNoteUtils.GetNodeLabelFromEvent(event);
                var NodeView = _this.ViewMap[Label];
                _this.App.DebugP(&quot;double click:&quot; + Label);
                if (_this.ContextMenu.IsEnable) {
                    _this.ContextMenu.Remove();
                }
                if (_this.NodeTooltip.IsEnable) {
                    _this.NodeTooltip.Remove();
                }
                _this.App.ExecDoubleClicked(NodeView);
                event.preventDefault();
            });

            this.CmdLine = new AssureNote.CommandLine(App);
            this.Search = new AssureNote.Search(App);

            var ToolTipFocusedLabel = null;
            this.ContentLayer.addEventListener(&quot;mouseover&quot;, function (event) {
                if (_this.App.FullScreenEditorPanel.IsActive()) {
                    return;
                }
                var Label = AssureNote.AssureNoteUtils.GetNodeLabelFromEvent(event);
                var NodeView = _this.ViewMap[Label];
                if (NodeView != null &amp;&amp; ToolTipFocusedLabel != Label) {
                    ToolTipFocusedLabel = Label;
                    var Tooltips = _this.App.PluginManager.GetTooltipContents(NodeView);
                    _this.NodeTooltip.Create(NodeView, _this.ControlLayer, Tooltips);
                }
            });

            this.ContentLayer.addEventListener(&quot;mouseleave&quot;, function (event) {
                /* We use mouseleave event instead of mouseout since mouseout/mouseenter fires
                every time the pointer enters the sub-element of ContentLayer.
                Mouseleave can prevent this annoying event firing. */
                if (_this.NodeTooltip.IsEnable) {
                    _this.NodeTooltip.Remove();
                    ToolTipFocusedLabel = null;
                }
            });

            var DragHandler = function (e) {
                e.stopPropagation();
                e.preventDefault();
            };
            $(this.EventMapLayer).on(&#x27;dragenter&#x27;, DragHandler).on(&#x27;dragover&#x27;, DragHandler).on(&#x27;dragleave&#x27;, DragHandler).on(&#x27;drop&#x27;, function (event) {
                event.stopPropagation();
                event.preventDefault();
                if (_this.IsActive()) {
                    _this.App.LoadFiles(event.originalEvent.dataTransfer.files);
                }
            });

            this.Viewport.ScrollManager.OnDragged = function (Viewport) {
                if (!_this.MasterView) {
                    return;
                }
                var HitBoxCenter = new AssureNote.Point(Viewport.GXFromPageX(Viewport.GetPageCenterX()), Viewport.GYFromPageY(Viewport.GetPageHeight() / 3));
                _this.MasterView.TraverseVisibleNode(function (Node) {
                    if (Node.IsFolded) {
                        var DX = HitBoxCenter.X - Node.GetCenterGX();
                        var DY = HitBoxCenter.Y - Node.GetCenterGY();
                        var R = 150 / _this.Viewport.GetCameraScale();
                        if (DX * DX + DY * DY &lt; R * R) {
                            _this.App.ExecDoubleClicked(Node);
                        }
                        return false;
                    }
                });
            };
            this.Viewport.ScrollManager.OnStartDrag = function (Viewport) {
                $(&quot;#auto-expand-area&quot;).show(100);
                $(&quot;.dropdown.open &gt; .dropdown-toggle&quot;).dropdown(&quot;toggle&quot;);
            };
            this.Viewport.ScrollManager.OnEndDrag = function (Viewport) {
                $(&quot;#auto-expand-area&quot;).hide(100);
            };
        }
        PictgramPanel.prototype.OnKeyDown = function (Event) {
            var handled = true;
            switch (Event.keyCode) {
                case 58:
                case 186:
                case 191:
                case 219:
                    if (this.Search.IsSearching()) {
                        this.Search.EndSearch();
                    }
                    this.CmdLine.Activate();
                    break;
                case 27:
                    if (this.Search.IsSearching()) {
                        this.Search.EndSearch();
                        Event.preventDefault();
                    }
                    break;
                case 13:
                    if (this.Search.IsSearching()) {
                        this.Search.SearchNext(this.MasterView, event.shiftKey);
                        Event.preventDefault();
                    }
                    break;
                case 72:
                case 37:
                    this.NavigateLeft();
                    Event.preventDefault();
                    break;
                case 74:
                case 40:
                    this.NavigateDown();
                    Event.preventDefault();
                    break;
                case 75:
                case 38:
                    this.NavigateUp();
                    Event.preventDefault();
                    break;
                case 76:
                case 39:
                    this.NavigateRight();
                    Event.preventDefault();
                    break;
                case 36:
                    this.NavigateHome();
                    Event.preventDefault();
                    break;
                case 70:
                    if (!this.CmdLine.IsVisible) {
                        var EditCommand = this.App.FindCommandByCommandLineName(&quot;fold&quot;);
                        if (EditCommand &amp;&amp; this.FocusedLabel) {
                            EditCommand.Invoke(null, [this.FocusedLabel]);
                        }
                    }
                    Event.preventDefault();
                    break;
                case 65:
                case 73:
                    var EditCommand = this.App.FindCommandByCommandLineName(Event.shiftKey ? &quot;edit&quot; : &quot;singleedit&quot;);
                    if (EditCommand &amp;&amp; this.FocusedLabel) {
                        EditCommand.Invoke(null, [this.FocusedLabel]);
                    }
                    Event.preventDefault();
                    break;
                default:
                    handled = false;
                    break;
            }
            if (handled) {
                Event.stopPropagation();
            }
        };

        PictgramPanel.prototype.OnActivate = function () {
            this.Viewport.IsPointerEnabled = true;
        };

        PictgramPanel.prototype.OnDeactivate = function () {
            this.Viewport.IsPointerEnabled = false;
        };

        /**
        @method MoveToNearestNode
        @param {AssureNote.Direction} Dir
        */
        PictgramPanel.prototype.MoveToNearestNode = function (Dir) {
            var NextNode = this.FocusedLabel ? this.FindNearestNode(this.ViewMap[this.FocusedLabel], Dir) : this.MasterView;
            this.FocusAndMoveToNode(NextNode);
        };

        PictgramPanel.prototype.FocusAndMoveToNode = function (Node) {
            if (Node != null) {
                var NextNode = Node.constructor == String ? this.ViewMap[Node] : Node;
                if (NextNode != null) {
                    this.ChangeFocusedLabel(NextNode.Label);
                    this.Viewport.MoveTo(NextNode.GetCenterGX(), NextNode.GetCenterGY(), this.Viewport.GetCameraScale(), 50);
                }
            }
        };

        /**
        @method FindNearestNode
        @param {AssureNote.NodeView} CenterNode
        @param {AssureNote.Direction} Dir
        @return {AssureNote.NodeView} Found node. If no node is found, null is retured.
        */
        PictgramPanel.prototype.FindNearestNode = function (CenterNode, Dir) {
            if (!CenterNode) {
                return null;
            }
            var RightLimitVectorX = 1;
            var RightLimitVectorY = 1;
            var LeftLimitVectorX = 1;
            var LeftLimitVectorY = 1;

            switch (Dir) {
                case 2 /* Right */:
                    LeftLimitVectorY = -1;
                    break;
                case 0 /* Left */:
                    RightLimitVectorX = -1;
                    RightLimitVectorY = -1;
                    LeftLimitVectorX = -1;
                    break;
                case 1 /* Top */:
                    RightLimitVectorY = -1;
                    LeftLimitVectorX = -1;
                    LeftLimitVectorY = -1;
                    break;
                case 3 /* Bottom */:
                    RightLimitVectorX = -1;
                    break;
            }
            var NearestNode = null;
            var CurrentMinimumDistanceSquere = Infinity;
            this.MasterView.TraverseVisibleNode(function (Node) {
                var DX = Node.GetCenterGX() - CenterNode.GetCenterGX();
                var DY = Node.GetCenterGY() - CenterNode.GetCenterGY();
                var DDotR = DX * RightLimitVectorX + DY * RightLimitVectorY;
                var DDotL = DX * LeftLimitVectorX + DY * LeftLimitVectorY;
                if (DDotR &gt; 0 &amp;&amp; DDotL &gt; 0) {
                    var DistanceSquere = DX * DX + DY * DY;
                    if (DistanceSquere &lt; CurrentMinimumDistanceSquere) {
                        CurrentMinimumDistanceSquere = DistanceSquere;
                        NearestNode = Node;
                    }
                }
            });
            return NearestNode;
        };

        /**
        @method FoldDeepSubGoals
        @param {NodeView} NodeView
        */
        PictgramPanel.prototype.FoldDeepSubGoals = function (NodeView) {
            var _this = this;
            NodeView.ForEachVisibleChildren(function (SubNode) {
                _this.FoldDeepSubGoals(SubNode);
                if (SubNode.GetNodeType() == 0 /* Goal */ &amp;&amp; SubNode.Children != null) {
                    if (SubNode.Children.length != 1 || SubNode.Children[0].GetNodeType() != 3 /* Evidence */) {
                        SubNode.IsFolded = true;
                    }
                }
            });
        };

        /**
        @method ChangeFocusedLabel
        @param {string} Label If label is null, there is no focused label.
        */
        PictgramPanel.prototype.ChangeFocusedLabel = function (Label) {
            AssureNote.AssureNoteUtils.UpdateHash(Label);
            if (this.ContextMenu.IsEnable) {
                this.ContextMenu.Remove();
            }
            if (this.NodeTooltip.IsEnable) {
                this.NodeTooltip.Remove();
            }
            if (Label == null) {
                var oldNodeView = this.ViewMap[this.FocusedLabel];
                if (oldNodeView != null) {
                    oldNodeView.RemoveColorStyle(AssureNote.ColorStyle.Highlight);
                }
                this.FocusedLabel = null;
                return;
            }
            var NodeView = this.ViewMap[Label];
            if (NodeView != null) {
                var oldNodeView = this.ViewMap[this.FocusedLabel];
                if (oldNodeView != null) {
                    oldNodeView.RemoveColorStyle(AssureNote.ColorStyle.Highlight);
                }
                this.FocusedLabel = Label;
                NodeView.AddColorStyle(AssureNote.ColorStyle.Highlight);
            }
        };

        PictgramPanel.prototype.GetFocusedLabel = function () {
            return this.FocusedLabel;
        };

        PictgramPanel.prototype.InitializeView = function (NodeView) {
            this.MasterView = NodeView;
            this.ViewMap = {};
            this.MasterView.UpdateViewMap(this.ViewMap);
        };

        PictgramPanel.prototype.Draw = function (Label, Duration) {
            this.Clear();
            var TargetView = this.ViewMap[Label];

            if (TargetView == null) {
                TargetView = this.MasterView;
            }
            this.LayoutEngine.DoLayout(this, TargetView);
            this.ContentLayer.style.display = &quot;none&quot;;
            this.SVGLayer.style.display = &quot;none&quot;;
            AssureNote.NodeView.SetGlobalPositionCacheEnabled(true);

            TargetView.UpdateDocumentPosition(Duration);
            TargetView.ClearAnimationCache();

            AssureNote.NodeView.SetGlobalPositionCacheEnabled(false);
            this.ContentLayer.style.display = &quot;&quot;;
            this.SVGLayer.style.display = &quot;&quot;;
        };

        PictgramPanel.prototype.Clear = function () {
            this.ContentLayer.style.display = &quot;none&quot;;
            this.SVGLayer.style.display = &quot;none&quot;;
            for (var i = this.ContentLayer.childNodes.length - 1; i &gt;= 0; i--) {
                this.ContentLayer.removeChild(this.ContentLayer.childNodes[i]);
            }
            for (var i = this.SVGLayer.childNodes.length - 1; i &gt;= 0; i--) {
                this.SVGLayer.removeChild(this.SVGLayer.childNodes[i]);
            }
            this.ContentLayer.style.display = &quot;&quot;;
            this.SVGLayer.style.display = &quot;&quot;;
        };

        PictgramPanel.prototype.DisplayPluginPanel = function (PluginName, Label) {
            var Plugin = this.App.PluginManager.GetPanelPlugin(PluginName, Label);
            Plugin.Display(this.App.FullScreenEditorPanel, this.App.MasterRecord.GetLatestDoc(), Label);
        };

        PictgramPanel.prototype.GetFocusedView = function () {
            if (this.ViewMap) {
                return this.ViewMap[this.FocusedLabel];
            }
            return null;
        };

        PictgramPanel.prototype.GetNodeViewFromUID = function (UID) {
            for (var i in this.ViewMap) {
                if (this.ViewMap[i].Model.UID == UID)
                    return this.ViewMap[i];
            }
            return null;
        };

        PictgramPanel.prototype.NavigateUp = function () {
            this.MoveToNearestNode(1 /* Top */);
        };
        PictgramPanel.prototype.NavigateDown = function () {
            this.MoveToNearestNode(3 /* Bottom */);
        };
        PictgramPanel.prototype.NavigateLeft = function () {
            this.MoveToNearestNode(0 /* Left */);
        };
        PictgramPanel.prototype.NavigateRight = function () {
            this.MoveToNearestNode(2 /* Right */);
        };
        PictgramPanel.prototype.NavigateHome = function () {
            this.FocusAndMoveToNode(this.MasterView);
        };
        return PictgramPanel;
    })(Panel);
    AssureNote.PictgramPanel = PictgramPanel;
})(AssureNote || (AssureNote = {}));
//# sourceMappingURL=Panel.js.map

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
